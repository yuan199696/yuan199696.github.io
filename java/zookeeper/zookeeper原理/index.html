<!-- build time:Thu Dec 30 2021 21:23:38 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" href="https://baiyezi.vip/rss.xml"><link rel="alternate" type="application/atom+xml" href="https://baiyezi.vip/atom.xml"><link rel="alternate" type="application/json" href="https://baiyezi.vip/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="Java,Zookeeper,分布式,ZAB协议,Paxos协议"><link rel="canonical" href="https://baiyezi.vip/java/zookeeper/zookeeper%E5%8E%9F%E7%90%86/"><title>zookeeper原理 - Java |</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">zookeeper原理</h1><div class="meta"><span class="item" title="创建时间：2021-01-19 20:45:21"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-01-19T20:45:21+08:00">2021-01-19</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>18k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>16 分钟</span> </span><span id="java/zookeeper/zookeeper原理/" class="item leancloud_visitors" data-flag-title="" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start"></a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://gitee.com/bfanfanfan/img/raw/master/guzhuang/20211225105422.jpg"></li><li class="item" data-background-image="https://gitee.com/bfanfanfan/img/raw/master/docsify/20211228230548.png"></li><li class="item" data-background-image="https://gitee.com/bfanfanfan/img/raw/master/docsify/20211228231352.png"></li><li class="item" data-background-image="https://gitee.com/bfanfanfan/img/raw/master/guzhuang/20211225105419.jpg"></li><li class="item" data-background-image="https://gitee.com/bfanfanfan/img/raw/master/guzhuang/20211225105423.jpg"></li><li class="item" data-background-image="https://gitee.com/bfanfanfan/img/raw/master/guzhuang/20211225105418.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/java/" itemprop="item" rel="index" title="分类于 Java"><span itemprop="name">Java</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://baiyezi.vip/java/zookeeper/zookeeper%E5%8E%9F%E7%90%86/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="fanfanfan"><meta itemprop="description" content=", 花有重开日，人无再少年"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content=""></span><div class="body md" itemprop="articleBody"><h2 id="paxos"><a class="anchor" href="#paxos">#</a> paxos</h2><p>ZooKeeper 是分布式的协调服务，它提供可靠、快速的服务，那么它是如何保证可靠性、一致性、快速等特点呢？那就是通过 paxos，paxos 是一个基于消息传递的一致性算法，是 Leslie Lamport 于 1990 年提出，被广泛用于分布式计算中，Google 的 Chubby、Apache 的 ZooKeeper 都是基于他的理论来实现的。paxos 只有在一个可信的计算环境中才能成立，这个环境是不会被入侵破坏的。</p><p>paxos 简单介绍可以<span class="exturl" data-url="aHR0cHM6Ly93d3cuZG91YmFuLmNvbS9ub3RlLzIwODQzMDQyNC8=">参考</span></p><h2 id="zab"><a class="anchor" href="#zab">#</a> ZAB</h2><p>ZAB 即 ZooKeeper Automatic Broadcast（ZooKeeper 的原子广播协议）。作用在 ZooKeeper 有 leader 时的可用状态，能在可用状态下更好的同步数据。ZAB 是 paxos 的一种实现方式。</p><p>原子：follower 向 leader 发送创建节点的请求要么失败（如节点已经存在）要么成功，leader 向每个 follower 维持一个队列，通过队列向 follower 发送写命令。如果 leader 挂掉，那么将停止对外提供服务，直到新的 leader 被选出并且数据同步完成才继续提供服务，这样可以保证数据的一致性。</p><p>广播：分布式多节点，leader 向 follower 发送通知，但并不是所有 follower 都能收到通知，过半 follower 收到通知即可</p><p>ZooKeeper 的数据状态保存在内存中，日志保存在磁盘中</p><p><img data-src="https://gitee.com/bfanfanfan/img/raw/master/docsify/image-20210119094310860.png" alt="image-20210119094310860"></p><p>场景一：第一次启动 ZooKeeper 集群</p><p><strong>选举出 leader 的依据</strong>：事务 id（Zxid）需要是最新的；myid 需要是最大的</p><p>例如：以下四台节点，如果按照顺序 128、129、130、131 启动，那么前三台启动后就会选出 leader 为 130</p><p><img data-src="https://gitee.com/bfanfanfan/img/raw/master/docsify/image-20210119103737694.png" alt="image-20210119103737694"></p><p>场景二：重启 ZooKeeper 集群或 leader 挂掉后（例如四台节点中有两台节点挂掉，那么剩余两台节点将不可用，无法对外提供服务）</p><p>例如：如下假设 131 是 leader 且挂掉了，130 的事务 id 比其他节点都第一个版本且第一个发现 leader 挂掉了：</p><p>所以 130 会首先向 128、129 发起投票，128、129 接收到投票后发现 130 的事务 id 是低版本的，所以会废除 130 的投票，同时向 130 回复投票，且纠正 130 的事务 id 使其变为最新的事务 id，且 130 会投给自己一票；</p><p>在废除了 130 的投票后，此时 129 的 myid 是最大的，由于 130 起初向 129 发起投票，就会被动触发 129 向 130（回复 130 的投票）以及 128 发起投票（传播特性）。其实，只要向 myid 最大的节点发起投票。那么 myid 最大的节点就会向每个节点发起投票，最中结果就是 myid 最大的节点将成为新的 leader。</p><p><img data-src="https://gitee.com/bfanfanfan/img/raw/master/docsify/image-20210119142928163.png" alt="image-20210119142928163"></p><h2 id="watch"><a class="anchor" href="#watch">#</a> watch</h2><p>一个客户端在节点中创建的目录，其他客户端也可以看到。但是当创建目录的客户端挂掉后，其他客户端便不能获得挂掉的客户端创建的目录，所以便有了 watch，在获得某一客户端创建的目录后，可以监控、观察获得的目录是否有变化，如果有变化，那么就会 callback（回调）连接的节点的事件（如 creare、delete、change、children 等事件）。当然也可以不使用 watch，可以通过心跳验证其他客户端时候连接正常，但心跳有时间的延迟以及方向性（由一方向另一方发送心跳），所以时效性不如 watch。</p><p><img data-src="https://gitee.com/bfanfanfan/img/raw/master/docsify/image-20210119153806147.png" alt="image-20210119153806147"></p><h2 id="api使用"><a class="anchor" href="#api使用">#</a> API 使用</h2><h3 id="建立连接"><a class="anchor" href="#建立连接">#</a> 建立连接</h3><p>新建一个 maven 项目，引入 ZooKeeper 依赖，注意：依赖的版本要和 ZooKeeper 版本一致，我这里的 ZooKeeper 版本是 3.6.2，所以依赖版本也是 3.6.2</p><pre><code class="language-xml-dtd">&lt;!-- https://mvnrepository.com/artifact/org.apache.zookeeper/zookeeper --&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.apache.zookeeper&lt;/groupId&gt;
      &lt;artifactId&gt;zookeeper&lt;/artifactId&gt;
      &lt;version&gt;3.6.2&lt;/version&gt;
    &lt;/dependency&gt;
</code></pre><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>fan</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token class-name">WatchedEvent</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token class-name">Watcher</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token class-name">ZooKeeper</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CountDownLatch</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="12"></td><td><pre> * Hello world!</pre></td></tr><tr><td data-num="13"></td><td><pre> */</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello World!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment">//zk 是有 session 概念的，每一个连接是一个 session。没有连接池的概念</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">//watch（观察、监控）有两类：</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment">// 第一类：new ZooKeeper () 时传入的 watch，这个 watch 是 session 级别的，跟 path、node 没有关系</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token class-name">ZooKeeper</span> zk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span><span class="token string">"192.168.137.128:2181,192.168.137.129:2181,192.168.137.130:2181,192.168.137.131:2181"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token comment">//watch 的回调方法，在 zk 连接成功后执行回调函数</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token class-name">Event<span class="token punctuation">.</span>KeeperState</span> state <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token class-name">Event<span class="token punctuation">.</span>EventType</span> type <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token class-name">String</span> path <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">Unknown</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">Disconnected</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">NoSyncConnected</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">SyncConnected</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                        <span class="token comment">// 只要 zk 连接成功就减 1</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                        countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"connected!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">AuthFailed</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">ConnectedReadOnly</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">SaslAuthenticated</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">Expired</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">Closed</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>                <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">None</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">NodeCreated</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">NodeDeleted</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">NodeDataChanged</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">NodeChildrenChanged</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">DataWatchRemoved</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="69"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">ChildWatchRemoved</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">PersistentWatchRemoved</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token comment">// 让 countDownLatch.await (); 以后的代码阻塞，直到以上 countDownLatch.countDown (); 执行成功减 1 后再执行以下代码。</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token comment">// 目的是让 zk 阻塞，直到 zk 连接成功后再进入以下代码的执行</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token comment">//zk 状态</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token class-name">ZooKeeper<span class="token punctuation">.</span>States</span> state <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>            <span class="token keyword">case</span> CONNECTING<span class="token operator">:</span></pre></td></tr><tr><td data-num="85"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"connecting.."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>            <span class="token keyword">case</span> ASSOCIATING<span class="token operator">:</span></pre></td></tr><tr><td data-num="88"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>            <span class="token keyword">case</span> CONNECTED<span class="token operator">:</span></pre></td></tr><tr><td data-num="90"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"connected..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>            <span class="token keyword">case</span> CONNECTEDREADONLY<span class="token operator">:</span></pre></td></tr><tr><td data-num="93"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>            <span class="token keyword">case</span> CLOSED<span class="token operator">:</span></pre></td></tr><tr><td data-num="95"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>            <span class="token keyword">case</span> AUTH_FAILED<span class="token operator">:</span></pre></td></tr><tr><td data-num="97"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>            <span class="token keyword">case</span> NOT_CONNECTED<span class="token operator">:</span></pre></td></tr><tr><td data-num="99"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="102"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>开启 ZooKeeper 服务端，执行以上类的主函数，控制台输出如下，可以看到 ZooKeeper 的连接已经建立</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">D</span><span class="token operator">:</span>\jdk\jdk1<span class="token punctuation">.</span><span class="token number">8</span>\bin\java<span class="token punctuation">.</span>exe <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Hello</span> <span class="token class-name">World</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="3"></td><td><pre>log4j<span class="token operator">:</span>WARN <span class="token class-name">No</span> appenders could be found <span class="token keyword">for</span> logger <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span>ZooKeeper</span><span class="token punctuation">)</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="4"></td><td><pre>log4j<span class="token operator">:</span>WARN <span class="token class-name">Please</span> initialize the log4j system properly<span class="token punctuation">.</span></pre></td></tr><tr><td data-num="5"></td><td><pre>log4j<span class="token operator">:</span>WARN <span class="token class-name">See</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>logging<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org<span class="token operator">/</span>log4j<span class="token operator">/</span><span class="token number">1.2</span><span class="token operator">/</span>faq<span class="token punctuation">.</span>html#noconfig <span class="token keyword">for</span> more <span class="token class-name"><span class="token namespace">info<span class="token punctuation">.</span></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>WatchedEvent state<span class="token operator">:</span><span class="token class-name">SyncConnected</span> type<span class="token operator">:</span><span class="token class-name">None</span> path<span class="token operator">:</span><span class="token keyword">null</span></pre></td></tr><tr><td data-num="7"></td><td><pre>connected<span class="token operator">!</span></pre></td></tr><tr><td data-num="8"></td><td><pre>connected<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token class-name">Process</span> finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token number">0</span></pre></td></tr></table></figure><h3 id="创建修改节点"><a class="anchor" href="#创建修改节点">#</a> 创建 / 修改节点</h3><p>创建以下方法并在主函数中调用执行</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 创建节点</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">createNode</span><span class="token punctuation">(</span><span class="token class-name">ZooKeeper</span> zk<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KeeperException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token comment">// 创建节点</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token comment">// 节点，节点数据，权限，节点类型</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">String</span> pathName <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span> <span class="token class-name">CreateMode</span><span class="token punctuation">.</span>EPHEMERAL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment">// 节点的 Zxid 等元数据。节点数据由两部分组成：实际数据和元数据</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">Stat</span> stat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token comment">// 获取节点，其中带有 AsyncCallback.DataCallback 参数的表示是同步的，取回的数据直接处理；不带该参数的表示异步调用</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">//watch 观察指定的节点路径是否发生变化，如果发生变化，那么就调用回调函数 process ()</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> node <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"getData watch的事件："</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>stat<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"节点的值："</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment">// 修改节点数据，该动作将触发以上 getData () 中 注册的 watch，从而调用其回调函数 process</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token class-name">Stat</span> stat1 <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token string">"hello world"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token class-name">Stat</span> stat2 <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token string">"hello world111"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stat1<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>执行结果：可以看到当改变节点中的值时就会触发相应的 watch 事件 NodeDataChanged</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> watch的事件：<span class="token class-name">WatchedEvent</span> state<span class="token operator">:</span><span class="token class-name">SyncConnected</span> type<span class="token operator">:</span><span class="token class-name">None</span> path<span class="token operator">:</span><span class="token keyword">null</span>  #与path、node无关</pre></td></tr><tr><td data-num="2"></td><td><pre>connected<span class="token operator">!</span></pre></td></tr><tr><td data-num="3"></td><td><pre>connected<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="4"></td><td><pre>节点的值：hello</pre></td></tr><tr><td data-num="5"></td><td><pre>getData watch的事件：<span class="token class-name">WatchedEvent</span> state<span class="token operator">:</span><span class="token class-name">SyncConnected</span> type<span class="token operator">:</span><span class="token class-name">NodeDataChanged</span> path<span class="token operator">:</span><span class="token operator">/</span>node1</pre></td></tr></table></figure><p>此时，在开始定义的 sessionTimeout 时间范围内可以取到<strong>临时节点</strong>，超过该时间范围则取不到<strong>临时节点</strong></p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token function">ls</span> /</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>zookeeper<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token function">ls</span> / <span class="token comment">#session 时间范围内可以取到临时节点</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>node1, zookeeper<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token function">ls</span> / <span class="token comment">#超过 session 时间后无法取到临时节点</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>zookeeper<span class="token punctuation">]</span></pre></td></tr></table></figure><h3 id="重复注册watch"><a class="anchor" href="#重复注册watch">#</a> 重复注册 watch</h3><p>在已经注册的 watch 回调函数 process () 中继续使用 getData () 中 new Watcher () 的 watch 对象进行注册。</p><p>只需在以上创建节点的代码中增加一行代码即可：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre>zk<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> stat<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>整体方法如下</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 重复注册 watch</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">createNode_1</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ZooKeeper</span> zk<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KeeperException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token comment">// 创建节点</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token comment">// 节点，节点数据，权限，节点类型</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">String</span> pathName <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span> <span class="token class-name">CreateMode</span><span class="token punctuation">.</span>EPHEMERAL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment">// 节点的 Zxid 等元数据。节点数据由两部分组成：实际数据和元数据</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">final</span> <span class="token class-name">Stat</span> stat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token comment">// 获取节点，其中带有 AsyncCallback.DataCallback 参数的表示是同步的，取回的数据直接处理；不带该参数的表示异步调用</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">//watch 观察指定的节点路径是否发生变化，如果发生变化，那么就调用回调函数 process ()</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> node <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"getData watch的事件："</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                <span class="token comment">// 重复注册 watch，true 代表使用 default Watch，即 new ZooKeeper 时注册的 watch；this 代表继续使用 getData () 中 new Watcher () 的 watch 对象进行注册</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                    zk<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> stat<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">//                    zk.getData("/node1", true, stat);</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>stat<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"节点的值："</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// 修改节点数据，该动作将触发以上 getData () 中 注册的 watch，从而调用其回调函数 process</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token class-name">Stat</span> stat1 <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token string">"hello world"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// 由于 watch 是一次性的，所以再次修改节点的值时不会再触发 watch，此时可以重复注册 watch 来解决这个问题</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token class-name">Stat</span> stat2 <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token string">"hello world111"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stat1<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>此时，从执行结果中可以看到再次多次修改节点的值就会多次触发 watch 的相应事件</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> watch的事件：<span class="token class-name">WatchedEvent</span> state<span class="token operator">:</span><span class="token class-name">SyncConnected</span> type<span class="token operator">:</span><span class="token class-name">None</span> path<span class="token operator">:</span><span class="token keyword">null</span></pre></td></tr><tr><td data-num="2"></td><td><pre>connected<span class="token operator">!</span></pre></td></tr><tr><td data-num="3"></td><td><pre>connected<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="4"></td><td><pre>节点的值：hello</pre></td></tr><tr><td data-num="5"></td><td><pre>getData watch的事件：<span class="token class-name">WatchedEvent</span> state<span class="token operator">:</span><span class="token class-name">SyncConnected</span> type<span class="token operator">:</span><span class="token class-name">NodeDataChanged</span> path<span class="token operator">:</span><span class="token operator">/</span>node1</pre></td></tr><tr><td data-num="6"></td><td><pre>getData watch的事件：<span class="token class-name">WatchedEvent</span> state<span class="token operator">:</span><span class="token class-name">SyncConnected</span> type<span class="token operator">:</span><span class="token class-name">NodeDataChanged</span> path<span class="token operator">:</span><span class="token operator">/</span>node1</pre></td></tr></table></figure><h3 id="日志输出"><a class="anchor" href="#日志输出">#</a> 日志输出</h3><p>将 ZooKeeper 安装目录下 conf 目录下的 log4j.properties 文件拷贝到项目的 resources 目录下，执行程序后就可以看到日志的输出。</p><p>此时，让程序的 main 线程 sleep，使得 zk 连接不断开，同时让 zk 连接的当前 zk 服务端断开，查看日志输出 zk 是否会选择其他 zk 服务连接。</p><p>通过日志输出可以看到 zk 连接的 zk 服务端是 137.128</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">2021</span>-01-20 <span class="token number">14</span>:02:27,613 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:ZooKeeper@1006<span class="token punctuation">]</span> - Initiating client connection, <span class="token assign-left variable">connectString</span><span class="token operator">=</span><span class="token number">192.168</span>.137.128:2181,192.168.137.129:2181,192.168.137.130:2181,192.168.137.131:2181 <span class="token assign-left variable">sessionTimeout</span><span class="token operator">=</span><span class="token number">110000</span> <span class="token assign-left variable">watcher</span><span class="token operator">=</span>com.fan.App<span class="token variable">$1</span>@bebdb06</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2021</span>-01-20 <span class="token number">14</span>:02:27,618 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:X509Util@77<span class="token punctuation">]</span> - Setting -D jdk.tls.rejectClientInitiatedRenegotiation<span class="token operator">=</span>true to disable client-initiated TLS renegotiation</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2021</span>-01-20 <span class="token number">14</span>:02:29,154 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:ClientCnxnSocket@239<span class="token punctuation">]</span> - jute.maxbuffer value is <span class="token number">1048575</span> Bytes</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">2021</span>-01-20 <span class="token number">14</span>:02:29,306 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:ClientCnxn@1716<span class="token punctuation">]</span> - zookeeper.request.timeout value is <span class="token number">0</span>. feature <span class="token assign-left variable">enabled</span><span class="token operator">=</span>false</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">2021</span>-01-20 <span class="token number">14</span>:02:47,486 <span class="token punctuation">[</span>myid:192.168.137.128:2181<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main-SendThread<span class="token punctuation">(</span><span class="token number">192.168</span>.137.128:2181<span class="token punctuation">)</span>:ClientCnxn<span class="token variable">$SendThread</span>@1167<span class="token punctuation">]</span> - Opening socket connection to server <span class="token number">192.168</span>.137.128/192.168.137.128:2181.</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">2021</span>-01-20 <span class="token number">14</span>:02:47,486 <span class="token punctuation">[</span>myid:192.168.137.128:2181<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main-SendThread<span class="token punctuation">(</span><span class="token number">192.168</span>.137.128:2181<span class="token punctuation">)</span>:ClientCnxn<span class="token variable">$SendThread</span>@1169<span class="token punctuation">]</span> - SASL config status: Will not attempt to authenticate using SASL <span class="token punctuation">(</span>unknown error<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">2021</span>-01-20 <span class="token number">14</span>:02:47,490 <span class="token punctuation">[</span>myid:192.168.137.128:2181<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main-SendThread<span class="token punctuation">(</span><span class="token number">192.168</span>.137.128:2181<span class="token punctuation">)</span>:ClientCnxn<span class="token variable">$SendThread</span>@999<span class="token punctuation">]</span> - Socket connection established, initiating session, client: /192.168.137.1:17546, server: <span class="token number">192.168</span>.137.128/192.168.137.128:2181</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">2021</span>-01-20 <span class="token number">14</span>:02:47,591 <span class="token punctuation">[</span>myid:192.168.137.128:2181<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main-SendThread<span class="token punctuation">(</span><span class="token number">192.168</span>.137.128:2181<span class="token punctuation">)</span>:ClientCnxn<span class="token variable">$SendThread</span>@1433<span class="token punctuation">]</span> - Session establishment complete on server <span class="token number">192.168</span>.137.128/192.168.137.128:2181, session <span class="token function">id</span> <span class="token operator">=</span> 0x100010d71500000, negotiated <span class="token function">timeout</span> <span class="token operator">=</span> <span class="token number">40000</span> <span class="token comment">#zk 客户端连接的是 137.128 的 zk 服务端</span></pre></td></tr><tr><td data-num="9"></td><td><pre>new ZooKeeper<span class="token punctuation">(</span><span class="token punctuation">)</span> watch的事件：WatchedEvent state:SyncConnected type:None path:null <span class="token comment">#zk 的连接触发的是 SyncConnected 事件</span></pre></td></tr><tr><td data-num="10"></td><td><pre>connected<span class="token operator">!</span></pre></td></tr><tr><td data-num="11"></td><td><pre>connected<span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="12"></td><td><pre>节点的值：hello</pre></td></tr><tr><td data-num="13"></td><td><pre>getData watch的事件：WatchedEvent state:SyncConnected type:NodeDataChanged path:/node1</pre></td></tr><tr><td data-num="14"></td><td><pre>getData watch的事件：WatchedEvent state:SyncConnected type:NodeDataChanged path:/node1</pre></td></tr></table></figure><p>此时，将 zk 服务端 137.128 结束掉，查看日志输出，可以看到 zk 会连接到新的 zk 服务端 137.130，且 session id 不变。同时，也可以看到 new ZooKeeper () 时（建立 zk 连接）触发的 watch 事件是 session 级别的，zk 连接的变化就会触发相应的事件。（注意：此时可以将 new ZooKeeper () 时的 sessionTimeout 设置大些，确保 zk 客户端与 zk 服务端在建立新连接之前 session 仍然有效）</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">2021</span>-01-20 <span class="token number">14</span>:03:18,197 <span class="token punctuation">[</span>myid:192.168.137.128:2181<span class="token punctuation">]</span> - WARN  <span class="token punctuation">[</span>main-SendThread<span class="token punctuation">(</span><span class="token number">192.168</span>.137.128:2181<span class="token punctuation">)</span>:ClientCnxn<span class="token variable">$SendThread</span>@1285<span class="token punctuation">]</span> - Session 0x100010d71500000 <span class="token keyword">for</span> sever <span class="token number">192.168</span>.137.128/192.168.137.128:2181, Closing socket connection. Attempting reconnect except it is a SessionExpiredException.</pre></td></tr><tr><td data-num="2"></td><td><pre>EndOfStreamException: Unable to <span class="token builtin class-name">read</span> additional data from server sessionid 0x100010d71500000, likely server has closed socket</pre></td></tr><tr><td data-num="3"></td><td><pre>	at org.apache.zookeeper.ClientCnxnSocketNIO.doIO<span class="token punctuation">(</span>ClientCnxnSocketNIO.java:77<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	at org.apache.zookeeper.ClientCnxnSocketNIO.doTransport<span class="token punctuation">(</span>ClientCnxnSocketNIO.java:350<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	at org.apache.zookeeper.ClientCnxn<span class="token variable">$SendThread</span>.run<span class="token punctuation">(</span>ClientCnxn.java:1275<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>getData watch的事件：WatchedEvent state:Disconnected type:None path:null <span class="token comment">#与 137.128 连接断开后触发 Disconnected 事件</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">2021</span>-01-20 <span class="token number">14</span>:03:36,610 <span class="token punctuation">[</span>myid:192.168.137.129:2181<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main-SendThread<span class="token punctuation">(</span><span class="token number">192.168</span>.137.129:2181<span class="token punctuation">)</span>:ClientCnxn<span class="token variable">$SendThread</span>@1167<span class="token punctuation">]</span> - Opening socket connection to server <span class="token number">192.168</span>.137.129/192.168.137.129:2181. <span class="token comment">#试图与 137.129 建立连接 但失败</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">2021</span>-01-20 <span class="token number">14</span>:03:36,610 <span class="token punctuation">[</span>myid:192.168.137.129:2181<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main-SendThread<span class="token punctuation">(</span><span class="token number">192.168</span>.137.129:2181<span class="token punctuation">)</span>:ClientCnxn<span class="token variable">$SendThread</span>@1169<span class="token punctuation">]</span> - SASL config status: Will not attempt to authenticate using SASL <span class="token punctuation">(</span>unknown error<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">2021</span>-01-20 <span class="token number">14</span>:03:36,620 <span class="token punctuation">[</span>myid:192.168.137.129:2181<span class="token punctuation">]</span> - WARN  <span class="token punctuation">[</span>main-SendThread<span class="token punctuation">(</span><span class="token number">192.168</span>.137.129:2181<span class="token punctuation">)</span>:ClientCnxn<span class="token variable">$SendThread</span>@1242<span class="token punctuation">]</span> - Client session timed out, have not heard from server <span class="token keyword">in</span> 18234ms <span class="token keyword">for</span> session <span class="token function">id</span> 0x100010d71500000</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">2021</span>-01-20 <span class="token number">14</span>:03:36,620 <span class="token punctuation">[</span>myid:192.168.137.129:2181<span class="token punctuation">]</span> - WARN  <span class="token punctuation">[</span>main-SendThread<span class="token punctuation">(</span><span class="token number">192.168</span>.137.129:2181<span class="token punctuation">)</span>:ClientCnxn<span class="token variable">$SendThread</span>@1285<span class="token punctuation">]</span> - Session 0x100010d71500000 <span class="token keyword">for</span> sever <span class="token number">192.168</span>.137.129/192.168.137.129:2181, Closing socket connection. Attempting reconnect except it is a SessionExpiredException.</pre></td></tr><tr><td data-num="11"></td><td><pre>org.apache.zookeeper.ClientCnxn<span class="token variable">$SessionTimeoutException</span><span class="token builtin class-name">:</span> Client session timed out, have not heard from server <span class="token keyword">in</span> 18234ms <span class="token keyword">for</span> session <span class="token function">id</span> 0x100010d71500000</pre></td></tr><tr><td data-num="12"></td><td><pre>	at org.apache.zookeeper.ClientCnxn<span class="token variable">$SendThread</span>.run<span class="token punctuation">(</span>ClientCnxn.java:1243<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>org.apache.zookeeper.KeeperException<span class="token variable">$ConnectionLossException</span><span class="token builtin class-name">:</span> KeeperErrorCode <span class="token operator">=</span> ConnectionLoss <span class="token keyword">for</span> /node1</pre></td></tr><tr><td data-num="14"></td><td><pre>	at org.apache.zookeeper.KeeperException.create<span class="token punctuation">(</span>KeeperException.java:102<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	at org.apache.zookeeper.KeeperException.create<span class="token punctuation">(</span>KeeperException.java:54<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	at org.apache.zookeeper.ZooKeeper.getData<span class="token punctuation">(</span>ZooKeeper.java:2358<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	at com.fan.App<span class="token variable">$3</span>.process<span class="token punctuation">(</span>App.java:146<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	at org.apache.zookeeper.ClientCnxn<span class="token variable">$EventThread</span>.processEvent<span class="token punctuation">(</span>ClientCnxn.java:587<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	at org.apache.zookeeper.ClientCnxn<span class="token variable">$EventThread</span>.run<span class="token punctuation">(</span>ClientCnxn.java:562<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>new ZooKeeper<span class="token punctuation">(</span><span class="token punctuation">)</span> watch的事件：WatchedEvent state:Disconnected type:None path:null <span class="token comment"># 与 137.129 建立连接失败后触发 Disconnected 事件</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token number">2021</span>-01-20 <span class="token number">14</span>:03:55,271 <span class="token punctuation">[</span>myid:192.168.137.130:2181<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main-SendThread<span class="token punctuation">(</span><span class="token number">192.168</span>.137.130:2181<span class="token punctuation">)</span>:ClientCnxn<span class="token variable">$SendThread</span>@1167<span class="token punctuation">]</span> - Opening socket connection to server <span class="token number">192.168</span>.137.130/192.168.137.130:2181. <span class="token comment">#试图与 137.130 建立连接且成功且 session id 仍然是当初与 137.128 建立连接时的 session id</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token number">2021</span>-01-20 <span class="token number">14</span>:03:55,271 <span class="token punctuation">[</span>myid:192.168.137.130:2181<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main-SendThread<span class="token punctuation">(</span><span class="token number">192.168</span>.137.130:2181<span class="token punctuation">)</span>:ClientCnxn<span class="token variable">$SendThread</span>@1169<span class="token punctuation">]</span> - SASL config status: Will not attempt to authenticate using SASL <span class="token punctuation">(</span>unknown error<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token number">2021</span>-01-20 <span class="token number">14</span>:03:55,273 <span class="token punctuation">[</span>myid:192.168.137.130:2181<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main-SendThread<span class="token punctuation">(</span><span class="token number">192.168</span>.137.130:2181<span class="token punctuation">)</span>:ClientCnxn<span class="token variable">$SendThread</span>@999<span class="token punctuation">]</span> - Socket connection established, initiating session, client: /192.168.137.1:17566, server: <span class="token number">192.168</span>.137.130/192.168.137.130:2181</pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token number">2021</span>-01-20 <span class="token number">14</span>:03:55,280 <span class="token punctuation">[</span>myid:192.168.137.130:2181<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main-SendThread<span class="token punctuation">(</span><span class="token number">192.168</span>.137.130:2181<span class="token punctuation">)</span>:ClientCnxn<span class="token variable">$SendThread</span>@1433<span class="token punctuation">]</span> - Session establishment complete on server <span class="token number">192.168</span>.137.130/192.168.137.130:2181, session <span class="token function">id</span> <span class="token operator">=</span> 0x100010d71500000, negotiated <span class="token function">timeout</span> <span class="token operator">=</span> <span class="token number">40000</span></pre></td></tr><tr><td data-num="25"></td><td><pre>getData watch的事件：WatchedEvent state:SyncConnected type:None path:null</pre></td></tr><tr><td data-num="26"></td><td><pre>new ZooKeeper<span class="token punctuation">(</span><span class="token punctuation">)</span> watch的事件：WatchedEvent state:SyncConnected type:None path:null <span class="token comment">#与 137.130 成功建立连接后触发 SyncConnected 事件</span></pre></td></tr><tr><td data-num="27"></td><td><pre>connected<span class="token operator">!</span></pre></td></tr></table></figure><h3 id="异步回调"><a class="anchor" href="#异步回调">#</a> 异步回调</h3><p>调用方法不会等待方法结果返会，而是调用方法后就继续往下执行其他代码，方法的执行结果将异步的返回。Zookeeper 的 getData () 提供了一个异步回调的方法 AsyncCallback.DataCallback ()，通过该异步回调方法，在调用 getData () 方法后，getData () 方法执行结果将异步的在 processResult () 返回，不会阻塞执行。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 异步回调</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">asyncCallback</span><span class="token punctuation">(</span><span class="token class-name">ZooKeeper</span> zk<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------async start--------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        zk<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AsyncCallback<span class="token punctuation">.</span>DataCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> rc<span class="token punctuation">,</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">Object</span> ctx<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">,</span> <span class="token class-name">Stat</span> stat<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------async callback--------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token string">"abc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------async over--------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在主方法中调用并执行以上方法，从执行结果可以看到方法异步返回执行结果的效果</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>new ZooKeeper<span class="token punctuation">(</span><span class="token punctuation">)</span> watch的事件：WatchedEvent state:SyncConnected type:None path:null</pre></td></tr><tr><td data-num="2"></td><td><pre>connected<span class="token operator">!</span></pre></td></tr><tr><td data-num="3"></td><td><pre>connected<span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="4"></td><td><pre>节点的值：hello</pre></td></tr><tr><td data-num="5"></td><td><pre>getData watch的事件：WatchedEvent state:SyncConnected type:NodeDataChanged path:/node1</pre></td></tr><tr><td data-num="6"></td><td><pre>getData watch的事件：WatchedEvent state:SyncConnected type:NodeDataChanged path:/node1</pre></td></tr><tr><td data-num="7"></td><td><pre>--------async start--------</pre></td></tr><tr><td data-num="8"></td><td><pre>--------async over-------- <span class="token comment">#不会阻塞 System.out.println ("--------async over--------"); 的执行</span></pre></td></tr><tr><td data-num="9"></td><td><pre>--------async callback--------<span class="token comment"># getData () 方法执行结果异步的返回</span></pre></td></tr><tr><td data-num="10"></td><td><pre>hello world111</pre></td></tr></table></figure><p>完整代码如下：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>fan</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span>data<span class="token punctuation">.</span></span><span class="token class-name">Stat</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CountDownLatch</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="11"></td><td><pre> * Hello world!</pre></td></tr><tr><td data-num="12"></td><td><pre> */</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">//zk 是有 session 概念的，每一个连接是一个 session。没有连接池的概念。</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment">//watch 的注册只发生在对事件的调用，如使用 get,exists 方法调用事件</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token comment">//watch（观察、监控）有两类：</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment">// 第一类：new ZooKeeper () 时传入的 watch，这个 watch 是 session 级别的，跟 path、node 没有关系</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">// 第二类：zk.getData () 时传入的 watch，这个方法用于获取节点数据，跟 path、node 相关，用来观察指定节点是否发生变化</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment">//sessionTimeout 代表在 zk 连接断开后，session 存货的时间，即临时节点在 zk 断开后存活的时间</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token class-name">ZooKeeper</span> zk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span><span class="token string">"192.168.137.128:2181,192.168.137.129:2181,192.168.137.130:2181,192.168.137.131:2181"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token number">110000</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token comment">//watch 的回调方法，在 zk 连接成功后执行回调函数</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token class-name">Event<span class="token punctuation">.</span>KeeperState</span> state <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token class-name">Event<span class="token punctuation">.</span>EventType</span> type <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token class-name">String</span> path <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"new ZooKeeper() watch的事件："</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">Unknown</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">Disconnected</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">NoSyncConnected</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">SyncConnected</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                        <span class="token comment">// 只要 zk 连接成功就减 1</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                        countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"connected!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">AuthFailed</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">ConnectedReadOnly</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">SaslAuthenticated</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">Expired</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">Closed</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>                <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">None</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">NodeCreated</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">NodeDeleted</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">NodeDataChanged</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">NodeChildrenChanged</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">DataWatchRemoved</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="69"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">ChildWatchRemoved</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                    <span class="token keyword">case</span> <span class="token class-name">PersistentWatchRemoved</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token comment">// 让 countDownLatch.await (); 以后的代码阻塞，直到以上 countDownLatch.countDown (); 执行成功减 1 后再执行以下代码。</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token comment">// 目的是让 zk 阻塞，直到 zk 连接成功后再进入以下代码的执行</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token comment">//zk 连接状态</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token class-name">ZooKeeper<span class="token punctuation">.</span>States</span> state <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>            <span class="token keyword">case</span> CONNECTING<span class="token operator">:</span></pre></td></tr><tr><td data-num="85"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"connecting.."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>            <span class="token keyword">case</span> ASSOCIATING<span class="token operator">:</span></pre></td></tr><tr><td data-num="88"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>            <span class="token keyword">case</span> CONNECTED<span class="token operator">:</span></pre></td></tr><tr><td data-num="90"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"connected..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>            <span class="token keyword">case</span> CONNECTEDREADONLY<span class="token operator">:</span></pre></td></tr><tr><td data-num="93"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>            <span class="token keyword">case</span> CLOSED<span class="token operator">:</span></pre></td></tr><tr><td data-num="95"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>            <span class="token keyword">case</span> AUTH_FAILED<span class="token operator">:</span></pre></td></tr><tr><td data-num="97"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>            <span class="token keyword">case</span> NOT_CONNECTED<span class="token operator">:</span></pre></td></tr><tr><td data-num="99"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="101"></td><td><pre></pre></td></tr><tr><td data-num="102"></td><td><pre><span class="token comment">//        createNode(zk);</span></pre></td></tr><tr><td data-num="103"></td><td><pre>        <span class="token function">createNode_1</span><span class="token punctuation">(</span>zk<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>        <span class="token function">asyncCallback</span><span class="token punctuation">(</span>zk<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre></pre></td></tr><tr><td data-num="106"></td><td><pre>        <span class="token comment">// 让主线程 sleep，使得 zk 连接不断开</span></pre></td></tr><tr><td data-num="107"></td><td><pre>        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="109"></td><td><pre></pre></td></tr><tr><td data-num="110"></td><td><pre>    <span class="token comment">// 创建节点</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">createNode</span><span class="token punctuation">(</span><span class="token class-name">ZooKeeper</span> zk<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KeeperException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>        <span class="token comment">// 创建节点</span></pre></td></tr><tr><td data-num="113"></td><td><pre>        <span class="token comment">// 节点，节点数据，权限，节点类型</span></pre></td></tr><tr><td data-num="114"></td><td><pre>        <span class="token class-name">String</span> pathName <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span> <span class="token class-name">CreateMode</span><span class="token punctuation">.</span>EPHEMERAL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>        <span class="token comment">// 节点的 Zxid 等元数据。节点数据由两部分组成：实际数据和元数据</span></pre></td></tr><tr><td data-num="116"></td><td><pre>        <span class="token class-name">Stat</span> stat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>        <span class="token comment">// 获取节点，其中带有 AsyncCallback.DataCallback 参数的表示是同步的，取回的数据直接处理；不带该参数的表示异步调用</span></pre></td></tr><tr><td data-num="118"></td><td><pre>        <span class="token comment">//watch 观察指定的节点路径是否发生变化，如果发生变化，那么就调用回调函数 process ()</span></pre></td></tr><tr><td data-num="119"></td><td><pre>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> node <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"getData watch的事件："</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>stat<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"节点的值："</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="125"></td><td><pre></pre></td></tr><tr><td data-num="126"></td><td><pre>        <span class="token comment">// 修改节点数据，该动作将触发以上 getData () 中 注册的 watch，从而调用其回调函数 process</span></pre></td></tr><tr><td data-num="127"></td><td><pre>        <span class="token class-name">Stat</span> stat1 <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token string">"hello world"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>        <span class="token comment">// 由于 watch 是一次性的，所以再次修改节点的值时不会再触发 watch，此时可以重复注册 watch 来解决这个问题</span></pre></td></tr><tr><td data-num="129"></td><td><pre>        <span class="token class-name">Stat</span> stat2 <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token string">"hello world111"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stat1<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="131"></td><td><pre></pre></td></tr><tr><td data-num="132"></td><td><pre>    <span class="token comment">// 重复注册 watch</span></pre></td></tr><tr><td data-num="133"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">createNode_1</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ZooKeeper</span> zk<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KeeperException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>        <span class="token comment">// 创建节点</span></pre></td></tr><tr><td data-num="135"></td><td><pre>        <span class="token comment">// 节点，节点数据，权限，节点类型</span></pre></td></tr><tr><td data-num="136"></td><td><pre>        <span class="token class-name">String</span> pathName <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span> <span class="token class-name">CreateMode</span><span class="token punctuation">.</span>EPHEMERAL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>        <span class="token comment">// 节点的 Zxid 等元数据。节点数据由两部分组成：实际数据和元数据</span></pre></td></tr><tr><td data-num="138"></td><td><pre>        <span class="token keyword">final</span> <span class="token class-name">Stat</span> stat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>        <span class="token comment">// 获取节点，其中带有 AsyncCallback.DataCallback 参数的表示是同步的，取回的数据直接处理；不带该参数的表示异步调用</span></pre></td></tr><tr><td data-num="140"></td><td><pre>        <span class="token comment">//watch 观察指定的节点路径是否发生变化，如果发生变化，那么就调用回调函数 process ()</span></pre></td></tr><tr><td data-num="141"></td><td><pre>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> node <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="142"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"getData watch的事件："</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="144"></td><td><pre>                <span class="token comment">// 重复注册 watch，true 代表使用 default Watch，即 new ZooKeeper 时注册的 watch；this 代表继续使用 getData () 中 new Watcher () 的 watch 对象进行注册</span></pre></td></tr><tr><td data-num="145"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>                    zk<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> stat<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="147"></td><td><pre><span class="token comment">//                    zk.getData("/node1", true, stat);</span></pre></td></tr><tr><td data-num="148"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="149"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="150"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="151"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="152"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="153"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="154"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>stat<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="155"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"节点的值："</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="156"></td><td><pre></pre></td></tr><tr><td data-num="157"></td><td><pre>        <span class="token comment">// 修改节点数据，该动作将触发以上 getData () 中 注册的 watch，从而调用其回调函数 process</span></pre></td></tr><tr><td data-num="158"></td><td><pre>        <span class="token class-name">Stat</span> stat1 <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token string">"hello world"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="159"></td><td><pre>        <span class="token comment">// 由于 watch 是一次性的，所以再次修改节点的值时不会再触发 watch，此时可以重复注册 watch 来解决这个问题</span></pre></td></tr><tr><td data-num="160"></td><td><pre>        <span class="token class-name">Stat</span> stat2 <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token string">"hello world111"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stat1<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="161"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="162"></td><td><pre></pre></td></tr><tr><td data-num="163"></td><td><pre>    <span class="token comment">// 异步回调</span></pre></td></tr><tr><td data-num="164"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">asyncCallback</span><span class="token punctuation">(</span><span class="token class-name">ZooKeeper</span> zk<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="165"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------async start--------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="166"></td><td><pre>        zk<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"/node1"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AsyncCallback<span class="token punctuation">.</span>DataCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="167"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> rc<span class="token punctuation">,</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">Object</span> ctx<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">,</span> <span class="token class-name">Stat</span> stat<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="168"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------async callback--------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="169"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="170"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="171"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token string">"abc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="172"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------async over--------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="173"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="174"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><div class="tags"><a href="/tags/Java/" rel="tag"><i class="ic i-tag"></i> Java</a> <a href="/tags/Zookeeper/" rel="tag"><i class="ic i-tag"></i> Zookeeper</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="ic i-tag"></i> 分布式</a> <a href="/tags/ZAB%E5%8D%8F%E8%AE%AE/" rel="tag"><i class="ic i-tag"></i> ZAB协议</a> <a href="/tags/Paxos%E5%8D%8F%E8%AE%AE/" rel="tag"><i class="ic i-tag"></i> Paxos协议</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2021-12-27 23:21:32" itemprop="dateModified" datetime="2021-12-27T23:21:32+08:00">2021-12-27</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.jpg" alt="fanfanfan 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.jpg" alt="fanfanfan 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="fanfanfan 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>fanfanfan</li><li class="link"><strong>本文链接：</strong> <a href="https://baiyezi.vip/java/zookeeper/zookeeper%E5%8E%9F%E7%90%86/" title="zookeeper原理">https://baiyezi.vip/java/zookeeper/zookeeper原理/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/java/zookeeper/zookeeper%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;gitee.com&#x2F;bfanfanfan&#x2F;img&#x2F;raw&#x2F;master&#x2F;docsify&#x2F;20211228231352.png" title="zookeeper搭建及基本概念"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Java</span><h3>zookeeper搭建及基本概念</h3></a></div><div class="item right"><a href="/java/zookeeper/zookeeper%E6%A1%88%E4%BE%8B/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;gitee.com&#x2F;bfanfanfan&#x2F;img&#x2F;raw&#x2F;master&#x2F;docsify&#x2F;20211228231352.png" title="zookeeper案例"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> Java</span><h3>zookeeper案例</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#paxos"><span class="toc-number">1.</span> <span class="toc-text">paxos</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zab"><span class="toc-number">2.</span> <span class="toc-text">ZAB</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#watch"><span class="toc-number">3.</span> <span class="toc-text">watch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#api%E4%BD%BF%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">API 使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5"><span class="toc-number">4.1.</span> <span class="toc-text">建立连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BF%AE%E6%94%B9%E8%8A%82%E7%82%B9"><span class="toc-number">4.2.</span> <span class="toc-text">创建 &#x2F; 修改节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%A4%8D%E6%B3%A8%E5%86%8Cwatch"><span class="toc-number">4.3.</span> <span class="toc-text">重复注册 watch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E8%BE%93%E5%87%BA"><span class="toc-number">4.4.</span> <span class="toc-text">日志输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%9B%9E%E8%B0%83"><span class="toc-number">4.5.</span> <span class="toc-text">异步回调</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/java/MySQL/Linux%E4%B8%8B%E5%AE%89%E8%A3%85MySQL/" rel="bookmark" title="Linux下安装MySQL">Linux下安装MySQL</a></li><li><a href="/java/MySQL/MySQL%E5%9F%BA%E7%A1%80/" rel="bookmark" title="MySQL基础">MySQL基础</a></li><li><a href="/java/Spring/IOC%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F%EF%BC%88%E4%B8%80%EF%BC%89/" rel="bookmark" title="IOC配置方式（一）">IOC配置方式（一）</a></li><li><a href="/java/Spring/IOC%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F%EF%BC%88%E4%BA%8C%EF%BC%89/" rel="bookmark" title="IOC配置方式（二）">IOC配置方式（二）</a></li><li><a href="/java/Spring/IOC%E6%B3%A8%E8%A7%A3%E6%96%B9%E5%BC%8F/" rel="bookmark" title="IOC注解方式">IOC注解方式</a></li><li><a href="/java/Spring/AOP/" rel="bookmark" title="AOP">AOP</a></li><li><a href="/java/SpringBoot/SpringBoot%E5%85%A5%E9%97%A8/" rel="bookmark" title="SpringBoot入门">SpringBoot入门</a></li><li><a href="/java/SpringBoot/SpringBoot-Web%E5%BC%80%E5%8F%91/" rel="bookmark" title="SpringBoot-Web开发">SpringBoot-Web开发</a></li><li><a href="/java/SpringBoot/SpringBoot%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E5%8E%9F%E7%90%86/" rel="bookmark" title="SpringBoot自动装配原理">SpringBoot自动装配原理</a></li><li><a href="/java/zookeeper/zookeeper%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" rel="bookmark" title="zookeeper搭建及基本概念">zookeeper搭建及基本概念</a></li><li class="active"><a href="/java/zookeeper/zookeeper%E5%8E%9F%E7%90%86/" rel="bookmark" title="zookeeper原理">zookeeper原理</a></li><li><a href="/java/zookeeper/zookeeper%E6%A1%88%E4%BE%8B/" rel="bookmark" title="zookeeper案例">zookeeper案例</a></li><li><a href="/java/MySQL/MySQL%E8%B0%83%E4%BC%98%EF%BC%88%E4%B8%80%EF%BC%89/" rel="bookmark" title="MySQL调优（一）">MySQL调优（一）</a></li><li><a href="/java/redis/redis%E5%AE%89%E8%A3%85%E5%8F%8ANIO%E5%8E%9F%E7%90%86/" rel="bookmark" title="redis安装及NIO原理">redis安装及NIO原理</a></li><li><a href="/java/SpringMVC/SpringMVC%E5%85%A5%E9%97%A8%EF%BC%88%E4%B8%80%EF%BC%89/" rel="bookmark" title="SpringMVC入门（一）">SpringMVC入门（一）</a></li><li><a href="/java/SpringMVC/SpringMVC%E5%85%A5%E9%97%A8%EF%BC%88%E4%BA%8C%EF%BC%89/" rel="bookmark" title="SpringMVC入门（二）">SpringMVC入门（二）</a></li><li><a href="/java/SpringMVC/SpringMVC-REST%E9%A3%8E%E6%A0%BC/" rel="bookmark" title="SpringMVC-REST风格">SpringMVC-REST风格</a></li><li><a href="/java/SpringMVC/SpringMVC%E8%BF%9B%E9%98%B6/" rel="bookmark" title="SpringMVC进阶">SpringMVC进阶</a></li><li><a href="/java/SpringMVC/SpringMVC%E6%BA%90%E7%A0%81%E6%80%BB%E7%BB%93/" rel="bookmark" title="SpringMVC源码总结">SpringMVC源码总结</a></li><li><a href="/java/shiro/shiro%E5%85%A5%E9%97%A8/" rel="bookmark" title="shiro入门">shiro入门</a></li><li><a href="/java/shiro/shiro%E6%95%B4%E5%90%88SpringBoot/" rel="bookmark" title="shiro整合SpringBoot">shiro整合SpringBoot</a></li><li><a href="/java/shiro/shiro%E7%9A%84session%E7%AE%A1%E7%90%86/" rel="bookmark" title="shiro的session管理">shiro的session管理</a></li><li><a href="/java/shiro/shiro%E7%9A%84%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E7%99%BB%E5%BD%95/" rel="bookmark" title="shiro的缓存机制与分布式登录">shiro的缓存机制与分布式登录</a></li><li><a href="/java/shiro/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/" rel="bookmark" title="单点登录">单点登录</a></li><li><a href="/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" rel="bookmark" title="线程基础知识">线程基础知识</a></li><li><a href="/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91/%E5%AE%B9%E5%99%A8%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="bookmark" title="容器与线程池">容器与线程池</a></li><li><a href="/java/docker/Win10%E5%AE%89%E8%A3%85docker/" rel="bookmark" title="Win10安装docker">Win10安装docker</a></li><li><a href="/java/docker/Win10%E4%B8%ADdocker%E9%83%A8%E7%BD%B2springboot%E9%A1%B9%E7%9B%AE/" rel="bookmark" title="Win10安装docker">Win10安装docker</a></li><li><a href="/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91/JMH/" rel="bookmark" title="JMH">JMH</a></li><li><a href="/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" rel="bookmark" title="并发编程">并发编程</a></li><li><a href="/java/%E6%97%A5%E5%BF%97/java-%E6%97%A5%E5%BF%97%E4%BD%93%E7%B3%BB/" rel="bookmark" title="java-日志体系">java-日志体系</a></li><li><a href="/java/redis/redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" rel="bookmark" title="redis的数据类型">redis的数据类型</a></li><li><a href="/java/redis/redis%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8/" rel="bookmark" title="redis进阶使用">redis进阶使用</a></li><li><a href="/java/redis/redis%E7%9A%84%E9%9B%86%E7%BE%A4/" rel="bookmark" title="redis的集群">redis的集群</a></li><li><a href="/java/redis/redis%E5%9C%A8%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" rel="bookmark" title="redis在开发中的简单使用">redis在开发中的简单使用</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/ChainOfResponsibility%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F/" rel="bookmark" title="ChainOfResponsibility责任链模式">ChainOfResponsibility责任链模式</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Composite%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F/" rel="bookmark" title="Composite组合模式">Composite组合模式</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Decorator%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F/" rel="bookmark" title="Decorator装饰器模式">Decorator装饰器模式</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Facade%E9%97%A8%E9%9D%A2%E6%A8%A1%E5%BC%8F/" rel="bookmark" title="Facade门面模式">Facade门面模式</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Factory%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/" rel="bookmark" title="Factory工厂模式">Factory工厂模式</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Flyweight%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F/" rel="bookmark" title="Flyweight享元模式">Flyweight享元模式</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Iterator%E8%BF%AD%E4%BB%A3%E5%99%A8%E6%A8%A1%E5%BC%8F/" rel="bookmark" title="Iterator迭代器模式">Iterator迭代器模式</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Mediator%E8%B0%83%E5%81%9C%E8%80%85%E6%A8%A1%E5%BC%8F/" rel="bookmark" title="Mediator调停者模式">Mediator调停者模式</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Observer%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/" rel="bookmark" title="Observer观察者模式">Observer观察者模式</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Proxy%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/" rel="bookmark" title="Proxy代理模式">Proxy代理模式</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Singleton%E5%8D%95%E4%BE%8B/" rel="bookmark" title="Singleton单例">Singleton单例</a></li><li><a href="/java/SpringCloud/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BB%A5%E5%8F%8A%E6%9E%B6%E6%9E%84%E5%8F%91%E5%B1%95/" rel="bookmark" title="微服务以及架构发展">微服务以及架构发展</a></li><li><a href="/java/JVM/JVM-%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD/" rel="bookmark" title="JVM-类的加载">JVM-类的加载</a></li><li><a href="/java/SpringCloud/SpringCloud-Netflix%E4%BD%93%E7%B3%BB/" rel="bookmark" title="SpringCloud-Netflix体系">SpringCloud-Netflix体系</a></li><li><a href="/java/%E5%BA%8F%E5%88%97%E5%8C%96/%E5%BA%8F%E5%88%97%E5%8C%96/" rel="bookmark" title="序列化">序列化</a></li><li><a href="/java/JVM/JVM-JMM/" rel="bookmark" title="JVM-JMM">JVM-JMM</a></li><li><a href="/java/%E4%BA%BF%E7%BA%A7%E6%B5%81%E9%87%8F%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/" rel="bookmark" title="分布式系统与高并发系统架构">分布式系统与高并发系统架构</a></li><li><a href="/java/JVM/JVM-%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%9B%E5%BB%BA/" rel="bookmark" title="JVM-对象的创建">JVM-对象的创建</a></li><li><a href="/java/JVM/JVM-JVM%E8%B0%83%E4%BC%98/" rel="bookmark" title="JVM-JVM调优">JVM-JVM调优</a></li><li><a href="/java/JVM/JVM-GC/" rel="bookmark" title="JVM-GC">JVM-GC</a></li><li><a href="/java/SpringCloud/SpringCloud-Alibaba%E4%BD%93%E7%B3%BB/" rel="bookmark" title="SpringCloud-Alibaba体系">SpringCloud-Alibaba体系</a></li><li><a href="/java/SpringCloud/SpringCloud-SpringCloud%E4%BD%93%E7%B3%BB/" rel="bookmark" title="SpringCloud-SpringCloud体系">SpringCloud-SpringCloud体系</a></li><li><a href="/java/SpringCloud/Apollo/" rel="bookmark" title="Apollo">Apollo</a></li><li><a href="/java/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BC%9A%E8%AF%9D/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86%EF%BC%88%E4%B8%80%EF%BC%89/" rel="bookmark" title="微服务中的会话管理（一）">微服务中的会话管理（一）</a></li><li><a href="/java/io/%E7%A3%81%E7%9B%98IO%E4%B8%8E%E7%BD%91%E7%BB%9CIO/" rel="bookmark" title="磁盘IO与网络IO">磁盘IO与网络IO</a></li><li><a href="/java/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BC%9A%E8%AF%9D/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86%EF%BC%88%E4%BA%8C%EF%BC%89/" rel="bookmark" title="微服务中的会话管理（二）">微服务中的会话管理（二）</a></li><li><a href="/java/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BC%9A%E8%AF%9D/HTTPS/" rel="bookmark" title="HTTPS">HTTPS</a></li><li><a href="/java/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RocketMQ/RocketMQ-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/" rel="bookmark" title="RocketMQ-基础概念">RocketMQ-基础概念</a></li><li><a href="/java/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RocketMQ/RocketMQ-%E6%B6%88%E6%81%AF%E3%80%81%E4%BA%8B%E5%8A%A1/" rel="bookmark" title="RocketMQ-消息、事务">RocketMQ-消息、事务</a></li><li><a href="/java/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/kafka/Kafka-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84/" rel="bookmark" title="Kafka-整体架构">Kafka-整体架构</a></li><li><a href="/java/io/%E7%BD%91%E7%BB%9CIO%E6%A8%A1%E5%9E%8B/" rel="bookmark" title="网络IO模型">网络IO模型</a></li><li><a href="/java/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/kafka/Kafka-%E6%90%AD%E5%BB%BA/" rel="bookmark" title="Kafka-搭建">Kafka-搭建</a></li><li><a href="/java/io/Netty/" rel="bookmark" title="Netty">Netty</a></li><li><a href="/java/Nginx/nginx%E5%AE%9E%E6%88%98/" rel="bookmark" title="nginx实战">nginx实战</a></li><li><a href="/instruments/%E4%B8%B2%E5%8F%A3/Java%E5%92%8C%E4%B8%B2%E5%8F%A3%E8%BF%9B%E8%A1%8C%E9%80%9A%E4%BF%A1/" rel="bookmark" title="Java和串口进行通信">Java和串口进行通信</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="fanfanfan" data-src="/images/avatar.gif"><p class="name" itemprop="name">fanfanfan</p><div class="description" itemprop="description">花有重开日，人无再少年</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">76</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">4</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">78</span> <span class="name">标签</span></a></div></nav><div class="social"></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-magic"></i>友链</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item"><a href="/statistics/" rel="section"><i class="ic i-heart"></i>文章统计</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/java/zookeeper/zookeeper%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/java/zookeeper/zookeeper%E6%A1%88%E4%BE%8B/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a></div><span><a href="/java/Spring/IOC%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F%EF%BC%88%E4%B8%80%EF%BC%89/" title="IOC配置方式（一）">IOC配置方式（一）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a></div><span><a href="/java/JVM/JVM-%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%9B%E5%BB%BA/" title="JVM-对象的创建">JVM-对象的创建</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a></div><span><a href="/java/Spring/AOP/" title="AOP">AOP</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a></div><span><a href="/java/shiro/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/" title="单点登录">单点登录</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a></div><span><a href="/java/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RocketMQ/RocketMQ-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/" title="RocketMQ-基础概念">RocketMQ-基础概念</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a></div><span><a href="/java/Nginx/nginx%E5%AE%9E%E6%88%98/" title="nginx实战">nginx实战</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a></div><span><a href="/java/shiro/shiro%E5%85%A5%E9%97%A8/" title="shiro入门">shiro入门</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a></div><span><a href="/java/JVM/JVM-%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD/" title="JVM-类的加载">JVM-类的加载</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a></div><span><a href="/java/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RocketMQ/RocketMQ-%E6%B6%88%E6%81%AF%E3%80%81%E4%BA%8B%E5%8A%A1/" title="RocketMQ-消息、事务">RocketMQ-消息、事务</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/front/" title="分类于 前端">前端</a></div><span><a href="/front/%E7%AE%80%E5%8D%95%E5%9B%BE%E8%A1%A8%E5%88%B6%E4%BD%9C/%E5%9B%BE%E8%A1%A8%EF%BC%88%E4%B8%89%EF%BC%89/" title="图表（三）">图表（三）</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">fanfanfan</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">1.4m 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">20:37</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"java/zookeeper/zookeeper原理/",favicon:{show:"书院十四先生",hide:"书院十四先生"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js,npm/echarts@5.2.2/dist/echarts.min.js"></script><script src="/js/app.js?v=0.2.5"></script><script data-pjax>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?163b363f1983d176d657221fc8e1631b";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body></html><!-- rebuild by hrmmi -->