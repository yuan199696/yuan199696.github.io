<!-- build time:Tue Dec 28 2021 21:44:56 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN,en,default"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" href="https://baiyezi.vip/rss.xml"><link rel="alternate" type="application/atom+xml" href="https://baiyezi.vip/atom.xml"><link rel="alternate" type="application/json" href="https://baiyezi.vip/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="Java,数据库,IO,Redis,缓存"><link rel="canonical" href="https://baiyezi.vip/java/redis/redis%E7%9A%84%E9%9B%86%E7%BE%A4/"><title>redis的集群 - Java |</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">redis的集群</h1><div class="meta"><span class="item" title="创建时间：2021-04-08 15:16:52"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-04-08T15:16:52+08:00">2021-04-08</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>84k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>1:17</span> </span><span id="java/redis/redis的集群/" class="item leancloud_visitors" data-flag-title="" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start"></a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://gitee.com/bfanfanfan/img/raw/master/guzhuang/20211225105423.jpg"></li><li class="item" data-background-image="https://gitee.com/bfanfanfan/img/raw/master/guzhuang/20211225105422.jpg"></li><li class="item" data-background-image="https://gitee.com/bfanfanfan/img/raw/master/guzhuang/20211225105008.png"></li><li class="item" data-background-image="https://gitee.com/bfanfanfan/img/raw/master/guzhuang/20211225105418.jpg"></li><li class="item" data-background-image="https://gitee.com/bfanfanfan/img/raw/master/guzhuang/20211225105421.jpg"></li><li class="item" data-background-image="https://gitee.com/bfanfanfan/img/raw/master/guzhuang/20211225105419.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/java/" itemprop="item" rel="index" title="分类于 Java"><span itemprop="name">Java</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://baiyezi.vip/java/redis/redis%E7%9A%84%E9%9B%86%E7%BE%A4/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="fanfanfan"><meta itemprop="description" content=", 花有重开日，人无再少年"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content=""></span><div class="body md" itemprop="articleBody"><h2 id="单机-单节点-单实例"><a class="anchor" href="#单机-单节点-单实例">#</a> 单机、单节点、单实例</h2><p>容易引发的问题：</p><ul><li>单点故障</li><li>容量有限</li><li>压力大（如 IO 压力）</li></ul><p>以上三个问题解决方案：独立方案和整合方案</p><p>AKF：通过 x、y、z 三个轴对技术进行拆解</p><ul><li>x 轴是做全量、镜像的数据库，解决了单点故障的问题</li><li>y 轴根据业务功能进行业务分离，每个业务访问不同的数据，解决了单个数据库容量有限的问题</li><li>z 轴根据业务优先级以及逻辑对一个业务再进行拆分，每个子业务存放着业务的一部分数据，解决了单实例数据访问压力大的问题。</li></ul><p>单点故障的解决：基于单机的 redis 可能会发生物理机死机的情况。此时，可以将 redis 的数据库沿着 x 轴方向做几个数据库的备份。同时，主数据库可以只负责数据的写（也可以读），备份数据库可以只负责数据的读，做到了读写分离。</p><p><img data-src="https://gitee.com/bfanfanfan/img/raw/master/docsify/image-20201225155533053.png" alt="image-20201225155533053"></p><p>容量有限解决：沿 y 轴对业务功能数据进行分离，使得不同的业务访问不同的 redis 实例的数据（类似于 MySQL 的分库）。注意：可以单独使用 x 或者 y，也可以同时使用 x 和 y。同时使用 x 和 y 的好处是，y 轴的每个业务数据在 x 轴的每个数据库中都可以获取到。</p><p><img data-src="https://gitee.com/bfanfanfan/img/raw/master/docsify/image-20201225162522437.png" alt="image-20201225162522437"></p><p>压力大解决：沿 z 轴对业务数据再进行拆分，使得一个业务数据由几个子业务数据组成，这样就解决了 redis 单实例业务数据访问压力大的问题。</p><p><img data-src="https://gitee.com/bfanfanfan/img/raw/master/docsify/image-20201225163008779.png" alt="image-20201225163008779"></p><p><strong>AKF 的问题：</strong></p><ul><li>在 x 轴做全量、镜像的数据库时，为了保证数据的一致性，所有业务节点需要阻塞直到数据库备份完成，只要有一个备份数据库在规定阻塞时间没有备份完成，那么就会导致无法给客户端做出响应，造成业务的超时，导致业务不可用，破环了业务的可用性。</li></ul><p><img data-src="https://gitee.com/bfanfanfan/img/raw/master/docsify/image-20201225171129950.png" alt="image-20201225171129950"></p><p>主备：备机不参与业务，当主机挂掉后，备机提供数据</p><p>主从：客户端既可以访问主机，也可以访问从机</p><p><strong>CAP 原则</strong>：</p><p>CAP 原则又称 CAP 定理，指的是在一个分布式系统中，<span class="exturl" data-url="aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTQlQjglODAlRTglODclQjQlRTYlODAlQTcvOTg0MDA4Mw==">一致性</span>（Consistency）、<span class="exturl" data-url="aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTUlOEYlQUYlRTclOTQlQTglRTYlODAlQTcvMTA5NjI4">可用性</span>（Availability）、<span class="exturl" data-url="aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTUlODglODYlRTUlOEMlQkElRTUlQUUlQjklRTklOTQlOTklRTYlODAlQTcvMjM3MzQwNzM=">分区容错性</span>（Partition tolerance）。CAP 原则指的是，这三个<span class="exturl" data-url="aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTglQTYlODElRTclQjQlQTAvNTI2MTIwMA==">要素</span>最多只能同时实现两点，不可能三者兼顾。比如，数据备份时 的强一致性必然破坏应用的可用性。</p><h2 id="redis主从复制"><a class="anchor" href="#redis主从复制">#</a> redis 主从复制</h2><p><span class="exturl" data-url="aHR0cDovL3d3dy5yZWRpcy5jbi90b3BpY3MvcmVwbGljYXRpb24uaHRtbA==">文档参考</span></p><p>Redis 使用默认的异步复制，其特点是低延迟和高性能，是绝大多数 Redis 用例的自然复制模式。</p><p>!&gt;redis 的主从复制在 AKF 中属于 X 轴方向，<strong>解决了单点故障问题。</strong></p><p>接下来演示 redis 的主从复制：</p><p>首先，需要新建三个 redis 实例，这里使用 6379、6380、6381 端口</p><pre><code class="language-sh">[root@localhost utils]# pwd
/usr/local/redis-6.0.9/utils
[root@localhost utils]# ./install_server.sh 
Welcome to the redis service installer
This script will help you easily set up a running redis server

Please select the redis port for this instance: [6379] 6381 #默认端口为6379，可以指定端口，随后一直回车即可创建一个redis实例
Please select the redis config file name [/etc/redis/6381.conf] 
Selected default - /etc/redis/6381.conf
Please select the redis log file name [/var/log/redis_6381.log] 
Selected default - /var/log/redis_6381.log
Please select the data directory for this instance [/var/lib/redis/6381] 
Selected default - /var/lib/redis/6381
Please select the redis executable path [/usr/local/bin/redis-server] 
Selected config:
Port           : 6381
Config file    : /etc/redis/6381.conf
Log file       : /var/log/redis_6381.log
Data dir       : /var/lib/redis/6381
Executable     : /usr/local/bin/redis-server
Cli Executable : /usr/local/bin/redis-cli
Is this ok? Then press ENTER to go on or Ctrl-C to abort.
Copied /tmp/6381.conf =&gt; /etc/init.d/redis_6381
Installing service...
Successfully added to chkconfig!
Successfully added to runlevels 345!
Starting Redis server...
Installation successful!

[root@localhost bin]# service redis_6381 stop  #将redis服务停掉
Stopping ...
Redis stopped

</code></pre><p>新建一个 test 文件夹，并将三个 redis 实例的配置文件拷贝到该目录下作为测试使用</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># mkdir test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># cp /etc/redis/* ./</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># ll</span></pre></td></tr><tr><td data-num="4"></td><td><pre>总用量 <span class="token number">252</span></pre></td></tr><tr><td data-num="5"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">84917</span> <span class="token number">12</span>月 <span class="token number">26</span> <span class="token number">20</span>:19 <span class="token number">6379</span>.conf</pre></td></tr><tr><td data-num="6"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">84917</span> <span class="token number">12</span>月 <span class="token number">26</span> <span class="token number">20</span>:19 <span class="token number">6380</span>.conf</pre></td></tr><tr><td data-num="7"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">84917</span> <span class="token number">12</span>月 <span class="token number">26</span> <span class="token number">20</span>:19 <span class="token number">6381</span>.conf</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">#修改这三个文件的后台运行配置、日志输出配置、AOF 配置</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>daemonize no  <span class="token comment"># 225 行，关闭后台运行</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">#logfile /var/log/redis_6380.log  #261 行，注释掉日志文件的后台输出，让其在前台阻塞输出</span></pre></td></tr><tr><td data-num="13"></td><td><pre>appendonly no <span class="token comment">#1090 行， 关闭 AOF</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">#删除三个实例的数据文件</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># cd /var/lib/redis/</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span>root@localhost redis<span class="token punctuation">]</span><span class="token comment"># ll</span></pre></td></tr><tr><td data-num="18"></td><td><pre>总用量 <span class="token number">0</span></pre></td></tr><tr><td data-num="19"></td><td><pre>drwxr-xr-x. <span class="token number">2</span> root root <span class="token number">22</span> <span class="token number">12</span>月 <span class="token number">26</span> <span class="token number">20</span>:17 <span class="token number">6379</span></pre></td></tr><tr><td data-num="20"></td><td><pre>drwxr-xr-x. <span class="token number">2</span> root root <span class="token number">22</span> <span class="token number">12</span>月  <span class="token number">9</span> <span class="token number">23</span>:29 <span class="token number">6380</span></pre></td></tr><tr><td data-num="21"></td><td><pre>drwxr-xr-x. <span class="token number">2</span> root root <span class="token number">22</span> <span class="token number">12</span>月 <span class="token number">26</span> <span class="token number">20</span>:15 <span class="token number">6381</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">[</span>root@localhost redis<span class="token punctuation">]</span><span class="token comment"># rm -rf 6379/*</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">[</span>root@localhost redis<span class="token punctuation">]</span><span class="token comment"># rm -rf 6380/*</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">[</span>root@localhost redis<span class="token punctuation">]</span><span class="token comment"># rm -rf 6381/*</span></pre></td></tr></table></figure><p>窗口一：启动 6379 的 redis 实例服务端，作为主服务器</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># pwd</span></pre></td></tr><tr><td data-num="2"></td><td><pre>/root/test</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># redis-server ./6379.conf</span></pre></td></tr></table></figure><p>窗口二：启动 6379redis 实例的客户端</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># redis-cli</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span></pre></td></tr></table></figure><p>窗口三：启动 6380redis 实例的服务端</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># pwd</span></pre></td></tr><tr><td data-num="2"></td><td><pre>/root/test</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># redis-server ./6380.conf</span></pre></td></tr></table></figure><p>窗口四：启动 6380redis 实例的客户端</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -p 6380</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">0</span>></span></pre></td></tr></table></figure><p>窗口五：启动 6381redis 实例的服务端</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># pwd</span></pre></td></tr><tr><td data-num="2"></td><td><pre>/root/test</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># redis-server ./6381.conf</span></pre></td></tr></table></figure><p>窗口六：启动 6381redis 实例的客户端</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># redis-cli -p 6381</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">1</span>></span></pre></td></tr></table></figure><p>接下来，通过指令<strong> REPLICAOF</strong> 来指定 6379 作为主机，6380 以及 6381 作为从机</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token builtin class-name">help</span> SLAVEOF  <span class="token comment">#redis5.0 之后由 REPLICAOF 替代</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>  SLAVEOF <span class="token function">host</span> port</pre></td></tr><tr><td data-num="4"></td><td><pre>  summary: Make the server a replica of another instance, or promote it as master. Deprecated starting with Redis <span class="token number">5</span>. Use REPLICAOF instead.</pre></td></tr><tr><td data-num="5"></td><td><pre>  since: <span class="token number">1.0</span>.0</pre></td></tr><tr><td data-num="6"></td><td><pre>  group: server</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token builtin class-name">help</span> REPLICAOF</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>  REPLICAOF <span class="token function">host</span> port</pre></td></tr><tr><td data-num="4"></td><td><pre>  summary: Make the server a replica of another instance, or promote it as master.</pre></td></tr><tr><td data-num="5"></td><td><pre>  since: <span class="token number">5.0</span>.0</pre></td></tr><tr><td data-num="6"></td><td><pre>  group: server</pre></td></tr></table></figure><p>窗口四：6380 实例客户端输入 REPLICAOF 命令来指定 6379 实例作为主机</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">0</span>></span> REPLICAOF <span class="token number">127.0</span>.0.1 <span class="token number">6379</span></pre></td></tr><tr><td data-num="2"></td><td><pre>OK</pre></td></tr></table></figure><p>窗口一：查看 6379 实例服务端输出</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">24811</span>:M <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.249 * Replica <span class="token number">127.0</span>.0.1:6380 asks <span class="token keyword">for</span> synchronization</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">24811</span>:M <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.249 * Partial resynchronization not accepted: Replication ID mismatch <span class="token punctuation">(</span>Replica asked <span class="token keyword">for</span> <span class="token string">'7d46dafbef81553ef26d5ded33765687afaa5311'</span>, my replication IDs are <span class="token string">'49a6f152754be641ef10e561200223114cf48314'</span> and <span class="token string">'0000000000000000000000000000000000000000'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">24811</span>:M <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.249 * Replication backlog created, my new replication IDs are <span class="token string">'ed4567c38a47b0b397fad98c6b2c975ce170fcba'</span> and <span class="token string">'0000000000000000000000000000000000000000'</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">24811</span>:M <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.249 * Starting BGSAVE <span class="token keyword">for</span> SYNC with target: disk</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">24811</span>:M <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.250 * Background saving started by pid <span class="token number">25284</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">25284</span>:C <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.351 * DB saved on disk</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">25284</span>:C <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.351 * RDB: <span class="token number">2</span> MB of memory used by copy-on-write</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">24811</span>:M <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.451 * Background saving terminated with success</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">24811</span>:M <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.451 * Synchronization with replica <span class="token number">127.0</span>.0.1:6380 succeeded</pre></td></tr></table></figure><p>窗口三：查看 6380 实例服务端的输出</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">24853</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.016 * Before turning into a replica, using my own master parameters to synthesize a cached master: I may be able to synchronize with the new master with just a partial transfer.</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">24853</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.016 * REPLICAOF <span class="token number">127.0</span>.0.1:6379 enabled <span class="token punctuation">(</span>user request from <span class="token string">'id=4 addr=127.0.0.1:33014 fd=7 name= age=1215 idle=1 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=44 qbuf-free=32724 argv-mem=22 obl=0 oll=0 omem=0 tot-mem=61486 events=r cmd=replicaof user=default'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">24853</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.247 * Connecting to MASTER <span class="token number">127.0</span>.0.1:6379</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">24853</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.247 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA <span class="token function">sync</span> started</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">24853</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.247 * Non blocking connect <span class="token keyword">for</span> SYNC fired the event.</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">24853</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.248 * Master replied to PING, replication can continue<span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">24853</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.249 * Trying a partial resynchronization <span class="token punctuation">(</span>request 7d46dafbef81553ef26d5ded33765687afaa5311:1<span class="token punctuation">)</span>.</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">24853</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.250 * Full resync from master: ed4567c38a47b0b397fad98c6b2c975ce170fcba:0</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">24853</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.250 * Discarding previously cached master state.</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">24853</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.451 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA sync: receiving <span class="token number">175</span> bytes from master to disk</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">24853</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.451 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA sync: Flushing old data <span class="token comment">#先清空从机自己的数据</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token number">24853</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.451 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA sync: Loading DB <span class="token keyword">in</span> memory <span class="token comment">#同步主机的数据</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">24853</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.453 * Loading RDB produced by version <span class="token number">6.0</span>.9</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token number">24853</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.453 * RDB age <span class="token number">0</span> seconds</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token number">24853</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.453 * RDB memory usage when created <span class="token number">1.85</span> Mb</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token number">24853</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:39:27.453 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA sync: Finished with success <span class="token comment">#完成主从复制</span></pre></td></tr></table></figure><p>窗口二：在主机 6379 实例中设置 key</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> k1 hello</pre></td></tr><tr><td data-num="2"></td><td><pre>OK</pre></td></tr></table></figure><p>窗口四：在从机 6380 实例获取主机 6379 实例的 key</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">0</span>></span> get k1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token string">"hello"</span></pre></td></tr></table></figure><p>窗口六：此时，6381 实例还没有作为 6379 实例的从机，先设置一个 key，之后让其作为 6379 实例的从机，此时可以看到 6381 实例原来的 key 不存在了，存在的是主机 6379 实例的 key，这是因为在同步主机 6379 实例的数据之前，6381 实例作为从机会把自己原来的数据先刷到磁盘</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token builtin class-name">set</span> k2 applpe</pre></td></tr><tr><td data-num="2"></td><td><pre>OK</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">1</span>></span> keys *</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"k2"</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">1</span>></span> REPLICAOF <span class="token number">127.0</span>.0.1 <span class="token number">6379</span></pre></td></tr><tr><td data-num="6"></td><td><pre>OK</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">1</span>></span> keys *</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"k1"</span> <span class="token comment">#得到了主机 6379 实例的 key</span></pre></td></tr></table></figure><p>窗口五：查看 6381 服务端输出</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">25027</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:02:28.921 * Before turning into a replica, using my own master parameters to synthesize a cached master: I may be able to synchronize with the new master with just a partial transfer.</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">25027</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:02:28.921 * REPLICAOF <span class="token number">127.0</span>.0.1:6379 enabled <span class="token punctuation">(</span>user request from <span class="token string">'id=4 addr=127.0.0.1:47340 fd=7 name= age=2357 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=44 qbuf-free=32724 argv-mem=22 obl=0 oll=0 omem=0 tot-mem=61486 events=r cmd=replicaof user=default'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">25027</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:02:29.234 * Connecting to MASTER <span class="token number">127.0</span>.0.1:6379</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">25027</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:02:29.234 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA <span class="token function">sync</span> started</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">25027</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:02:29.234 * Non blocking connect <span class="token keyword">for</span> SYNC fired the event.</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">25027</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:02:29.235 * Master replied to PING, replication can continue<span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">25027</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:02:29.236 * Trying a partial resynchronization <span class="token punctuation">(</span>request f3fa6c71d62d4f43d0d67bf1d577fb1818cbce9c:1<span class="token punctuation">)</span>.</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">25027</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:02:29.237 * Full resync from master: ed4567c38a47b0b397fad98c6b2c975ce170fcba:1973</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">25027</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:02:29.237 * Discarding previously cached master state.</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">25027</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:02:29.334 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA sync: receiving <span class="token number">191</span> bytes from master to disk</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">25027</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:02:29.334 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA sync: Flushing old data</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token number">25027</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:02:29.334 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA sync: Loading DB <span class="token keyword">in</span> memory</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">25027</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:02:29.335 * Loading RDB produced by version <span class="token number">6.0</span>.9</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token number">25027</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:02:29.335 * RDB age <span class="token number">0</span> seconds</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token number">25027</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:02:29.335 * RDB memory usage when created <span class="token number">1.90</span> Mb</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token number">25027</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:02:29.335 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA sync: Finished with success</pre></td></tr></table></figure><p>!&gt; 现在假设：6381 从机突然挂掉了，那么当 6381 从机再次启动后是对主机的数据做增量还是全量备份呢？</p><p>窗口五：ctrl + C 结束掉 6381 从机的服务端</p><p>窗口二：主机 6379 设置一些 key</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> k2 kkk</pre></td></tr><tr><td data-num="2"></td><td><pre>OK</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> k3 ab</pre></td></tr><tr><td data-num="4"></td><td><pre>OK</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> k4 <span class="token number">666</span></pre></td></tr><tr><td data-num="6"></td><td><pre>OK</pre></td></tr></table></figure><p>窗口五：重新启动 6381 从机（此时直接在服务启动时就使用 replicaof 命令来指定主机），此时可以看到从机 6381 并没有像开始启动那样整个去同步主机 6379 中的数据，而是在原来的数据上做了增量，只增加了自己挂掉之后主机 6379 增加的数据。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># redis-server ./6381.conf --replicaof 127.0.0.1 6379</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">..</span><span class="token punctuation">..</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">25718</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:17:11.970 * Ready to accept connections</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">25718</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:17:11.970 * Connecting to MASTER <span class="token number">127.0</span>.0.1:6379</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">25718</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:17:11.970 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA <span class="token function">sync</span> started</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">25718</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:17:11.970 * Non blocking connect <span class="token keyword">for</span> SYNC fired the event.</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">25718</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:17:11.971 * Master replied to PING, replication can continue<span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">25718</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:17:11.971 * Trying a partial resynchronization <span class="token punctuation">(</span>request ed4567c38a47b0b397fad98c6b2c975ce170fcba:2954<span class="token punctuation">)</span>.</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">25718</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:17:11.972 * Successful partial resynchronization with master.</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">25718</span>:S <span class="token number">27</span> Dec <span class="token number">2020</span> <span class="token number">23</span>:17:11.972 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA sync: Master accepted a Partial Resynchronization.</pre></td></tr></table></figure><p>窗口六：获取数据</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">1</span>></span> keys *</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"k3"</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"k1"</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"k4"</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"k2"</span></pre></td></tr></table></figure><p>!&gt; 如果 6381 从机在重启时开启 AOF，那么必定会触发 bgsave 来将 6379 主机的数据重新刷入到磁盘，而不是做增量，同时在生成的 AOF 文件中看不出来有从机复制主机数据的痕迹。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost <span class="token number">6381</span><span class="token punctuation">]</span><span class="token comment"># pwd</span></pre></td></tr><tr><td data-num="2"></td><td><pre>/var/lib/redis/6381</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@localhost <span class="token number">6381</span><span class="token punctuation">]</span><span class="token comment"># vim appendonly.aof </span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>REDIS0009ú      redis-ver^E6.0.9ú</pre></td></tr><tr><td data-num="6"></td><td><pre>redis-bitsÀ@ú^EctimeÂ<span class="token operator">&lt;</span>8c<span class="token operator">></span>Uê_ú^Hused-memÂ<span class="token operator"><span class="token file-descriptor important">8</span>&lt;</span><span class="token number">9</span><span class="token operator"><span class="token file-descriptor important">5</span>></span>^<span class="token punctuation">\</span>^@ú^Laof-preambleÀ^Aþ^@û^D^@^@^Bk2^Ckkk^@^Bk1^Ehello^@^Bk3^Bab^@^Bk4Á<span class="token operator">&lt;</span>9a<span class="token operator">></span>^Bÿv^_^_Ó<span class="token operator">&lt;</span><span class="token number">9</span><span class="token operator"><span class="token file-descriptor important">6</span>></span>¸e¯</pre></td></tr></table></figure><p>!&gt; 如果此时主机挂掉了，那么可以使用其中一个从机来作为主机，供其他从机追随</p><p>假如原来的主机 6379 挂掉后，6380 作为主机，6381 从机追随 6380 主机</p><p>窗户四：6380 取消追随 6379 主机，自己作为了主机</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">0</span>></span> REPLICAOF no one</pre></td></tr><tr><td data-num="2"></td><td><pre>OK</pre></td></tr></table></figure><p>窗口六：6381 从机追随 6380 主机</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">1</span>></span> REPLICAOF <span class="token number">127.0</span>.0.1 <span class="token number">6380</span></pre></td></tr><tr><td data-num="2"></td><td><pre>OK</pre></td></tr></table></figure><p>窗口三：6380 主机服务端成功接收 6381 从机的追随</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">3928</span>:M <span class="token number">29</span> Dec <span class="token number">2020</span> 06:13:32.914 * Replica <span class="token number">127.0</span>.0.1:6381 asks <span class="token keyword">for</span> synchronization</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">3928</span>:M <span class="token number">29</span> Dec <span class="token number">2020</span> 06:13:32.914 * Partial resynchronization not accepted: Replication ID mismatch <span class="token punctuation">(</span>Replica asked <span class="token keyword">for</span> <span class="token string">'3b0b1e78ddbcd9a72b19ec2f778b41c471cd4060'</span>, my replication IDs are <span class="token string">'83b665ae724e3fe715d5f48d4996ac49e331197a'</span> and <span class="token string">'0000000000000000000000000000000000000000'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">3928</span>:M <span class="token number">29</span> Dec <span class="token number">2020</span> 06:13:32.914 * Replication backlog created, my new replication IDs are <span class="token string">'fe8f08e4bd7cf4a6acd41a8d1b92d129c3db8781'</span> and <span class="token string">'0000000000000000000000000000000000000000'</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">3928</span>:M <span class="token number">29</span> Dec <span class="token number">2020</span> 06:13:32.914 * Starting BGSAVE <span class="token keyword">for</span> SYNC with target: disk</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">3928</span>:M <span class="token number">29</span> Dec <span class="token number">2020</span> 06:13:32.915 * Background saving started by pid <span class="token number">4278</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">4278</span>:C <span class="token number">29</span> Dec <span class="token number">2020</span> 06:13:32.922 * DB saved on disk</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">4278</span>:C <span class="token number">29</span> Dec <span class="token number">2020</span> 06:13:32.923 * RDB: <span class="token number">2</span> MB of memory used by copy-on-write</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">3928</span>:M <span class="token number">29</span> Dec <span class="token number">2020</span> 06:13:33.013 * Background saving terminated with success</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">3928</span>:M <span class="token number">29</span> Dec <span class="token number">2020</span> 06:13:33.013 * Synchronization with replica <span class="token number">127.0</span>.0.1:6381 succeeded</pre></td></tr></table></figure><p>以上关于主从复制的演示都是手动敲命令来实现的，此外，还可以在配置文件中进行配置</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">368</span>行开始</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">################################# REPLICATION #################################</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># Master-Replica replication. Use replicaof to make a Redis instance a copy of</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># another Redis server. A few things to understand ASAP about Redis replication.</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">#   +------------------+      +---------------+</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">#   |      Master      | ---> |    Replica    |</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">#   | (receive writes) |      |  (exact copy) |</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#   +------------------+      +---------------+</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 1) Redis replication is asynchronous, but you can configure a master to</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">#    stop accepting writes if it appears to be not connected with at least</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">#    a given number of replicas.</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># 2) Redis replicas are able to perform a partial resynchronization with the</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">#    master if the replication link is lost for a relatively small amount of</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">#    time. You may want to configure the replication backlog size (see the next</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">#    sections of this file) with a sensible value depending on your needs.</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># 3) Replication is automatic and does not need user intervention. After a</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">#    network partition replicas automatically try to reconnect to masters</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">#    and resynchronize with them.</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment"># replicaof &lt;masterip> &lt;masterport></span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"># If the master is password protected (using the "requirepass" configuration</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"># directive below) it is possible to tell the replica to authenticate before</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"># starting the replication synchronization process, otherwise the master will</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment"># refuse the replica request.</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment"># masterauth &lt;master-password> #如果主机有密码的话，需要配置密码</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment"># However this is not enough if you are using Redis ACLs (for Redis version</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment"># 6 or greater), and the default user is not capable of running the PSYNC</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment"># command and/or other commands needed for replication. In this case it's</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment"># better to configure a special user to use with replication, and specify the</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment"># masteruser configuration as such:</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment"># masteruser &lt;username></span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment"># When masteruser is specified, the replica will authenticate against its</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment"># master using the new AUTH form: AUTH &lt;username> &lt;password>.</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token comment"># When a replica loses its connection with the master, or when the replication</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token comment"># is still in progress, the replica can act in two different ways:</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment"># 1) if replica-serve-stale-data is set to 'yes' (the default) the replica will</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token comment">#    still reply to client requests, possibly with out of date data, or the</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token comment">#    data set may just be empty if this is the first synchronization.</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token comment"># 2) If replica-serve-stale-data is set to 'no' the replica will reply with</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token comment">#    an error "SYNC with master in progress" to all commands except:</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token comment">#    INFO, REPLICAOF, AUTH, PING, SHUTDOWN, REPLCONF, ROLE, CONFIG, SUBSCRIBE,</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token comment">#    UNSUBSCRIBE, PSUBSCRIBE, PUNSUBSCRIBE, PUBLISH, PUBSUB, COMMAND, POST,</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment">#    HOST and LATENCY.</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="55"></td><td><pre>replica-serve-stale-data <span class="token function">yes</span>  <span class="token comment">#在从机同步主机数据的时候，从机的数据是否对外暴露可查。为 no 则表示只有从机同步完主机数据后才开始对外暴露数据</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token comment"># You can configure a replica instance to accept writes or not. Writing against</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token comment"># a replica instance may be useful to store some ephemeral data (because data</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token comment"># written on a replica will be easily deleted after resync with the master) but</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token comment"># may also cause problems if clients are writing to it because of a</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token comment"># misconfiguration.</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token comment"># Since Redis 2.6 by default replicas are read-only.</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token comment"># Note: read only replicas are not designed to be exposed to untrusted clients</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token comment"># on the internet. It's just a protection layer against misuse of the instance.</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token comment"># Still a read only replica exports by default all the administrative commands</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token comment"># such as CONFIG, DEBUG, and so forth. To a limited extent you can improve</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token comment"># security of read only replicas using 'rename-command' to shadow all the</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token comment"># administrative / dangerous commands.</span></pre></td></tr><tr><td data-num="71"></td><td><pre>replica-read-only <span class="token function">yes</span> <span class="token comment"># 从机只支持查询，为 no 代表可以写入</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token comment"># Replication SYNC strategy: disk or socket.</span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token comment"># New replicas and reconnecting replicas that are not able to continue the</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token comment"># replication process just receiving differences, need to do what is called a</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token comment"># "full synchronization". An RDB file is transmitted from the master to the</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token comment"># replicas.</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token comment"># The transmission can happen in two different ways: #关于主从复制时，主机给从机传输数据时有两种方式：一是主机先将数据写到磁盘，然后从机通过网络再从磁盘读取数据；二是通过网络直接传输给从机，不经过磁盘。很明显方式二效率更高。</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token comment"># 1) Disk-backed: The Redis master creates a new process that writes the RDB</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token comment">#                 file on disk. Later the file is transferred by the parent</span></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token comment">#                 process to the replicas incrementally.</span></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token comment"># 2) Diskless: The Redis master creates a new process that directly writes the</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token comment">#              RDB file to replica sockets, without touching the disk at all.</span></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token comment"># With disk-backed replication, while the RDB file is generated, more replicas</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token comment"># can be queued and served with the RDB file as soon as the current child</span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token comment"># producing the RDB file finishes its work. With diskless replication instead</span></pre></td></tr><tr><td data-num="91"></td><td><pre><span class="token comment"># once the transfer starts, new replicas arriving will be queued and a new</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token comment"># transfer will start when the current one terminates.</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token comment"># When diskless replication is used, the master waits a configurable amount of</span></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token comment"># time (in seconds) before starting the transfer in the hope that multiple</span></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token comment"># replicas will arrive and the transfer can be parallelized.</span></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token comment"># With slow disks and fast (large bandwidth) networks, diskless replication</span></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token comment"># works better.</span></pre></td></tr><tr><td data-num="100"></td><td><pre>repl-diskless-sync no <span class="token comment">#默认使用方式一传输数据</span></pre></td></tr><tr><td data-num="101"></td><td><pre></pre></td></tr><tr><td data-num="102"></td><td><pre><span class="token comment"># When diskless replication is enabled, it is possible to configure the delay</span></pre></td></tr><tr><td data-num="103"></td><td><pre><span class="token comment"># the server waits in order to spawn the child that transfers the RDB via socket</span></pre></td></tr><tr><td data-num="104"></td><td><pre><span class="token comment"># to the replicas.</span></pre></td></tr><tr><td data-num="105"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token comment"># This is important since once the transfer starts, it is not possible to serve</span></pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token comment"># new replicas arriving, that will be queued for the next RDB transfer, so the</span></pre></td></tr><tr><td data-num="108"></td><td><pre><span class="token comment"># server waits a delay in order to let more replicas arrive.</span></pre></td></tr><tr><td data-num="109"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="110"></td><td><pre><span class="token comment"># The delay is specified in seconds, and by default is 5 seconds. To disable</span></pre></td></tr><tr><td data-num="111"></td><td><pre><span class="token comment"># it entirely just set it to 0 seconds and the transfer will start ASAP.</span></pre></td></tr><tr><td data-num="112"></td><td><pre>repl-diskless-sync-delay <span class="token number">5</span></pre></td></tr><tr><td data-num="113"></td><td><pre><span class="token comment"># -----------------------------------------------------------------------------</span></pre></td></tr><tr><td data-num="114"></td><td><pre><span class="token comment"># WARNING: RDB diskless load is experimental. Since in this setup the replica</span></pre></td></tr><tr><td data-num="115"></td><td><pre><span class="token comment"># does not immediately store an RDB on disk, it may cause data loss during</span></pre></td></tr><tr><td data-num="116"></td><td><pre><span class="token comment"># failovers. RDB diskless load + Redis modules not handling I/O reads may also</span></pre></td></tr><tr><td data-num="117"></td><td><pre><span class="token comment"># cause Redis to abort in case of I/O errors during the initial synchronization</span></pre></td></tr><tr><td data-num="118"></td><td><pre><span class="token comment"># stage with the master. Use only if your do what you are doing.</span></pre></td></tr><tr><td data-num="119"></td><td><pre><span class="token comment"># -----------------------------------------------------------------------------</span></pre></td></tr><tr><td data-num="120"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token comment"># Replica can load the RDB it reads from the replication link directly from the</span></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token comment"># socket, or store the RDB to a file and read that file after it was completely</span></pre></td></tr><tr><td data-num="123"></td><td><pre><span class="token comment"># received from the master.</span></pre></td></tr><tr><td data-num="124"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="125"></td><td><pre><span class="token comment"># In many cases the disk is slower than the network, and storing and loading</span></pre></td></tr><tr><td data-num="126"></td><td><pre><span class="token comment"># the RDB file may increase replication time (and even increase the master's</span></pre></td></tr><tr><td data-num="127"></td><td><pre><span class="token comment"># Copy on Write memory and salve buffers).</span></pre></td></tr><tr><td data-num="128"></td><td><pre><span class="token comment"># However, parsing the RDB file directly from the socket may mean that we have</span></pre></td></tr><tr><td data-num="129"></td><td><pre><span class="token comment"># to flush the contents of the current database before the full rdb was</span></pre></td></tr><tr><td data-num="130"></td><td><pre><span class="token comment"># received. For this reason we have the following options:</span></pre></td></tr><tr><td data-num="131"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="132"></td><td><pre><span class="token comment"># "disabled"    - Don't use diskless load (store the rdb file to the disk first)</span></pre></td></tr><tr><td data-num="133"></td><td><pre><span class="token comment"># "on-empty-db" - Use diskless load only when it is completely safe.</span></pre></td></tr><tr><td data-num="134"></td><td><pre><span class="token comment"># "swapdb"      - Keep a copy of the current db contents in RAM while parsing</span></pre></td></tr><tr><td data-num="135"></td><td><pre><span class="token comment">#                 the data directly from the socket. note that this requires</span></pre></td></tr><tr><td data-num="136"></td><td><pre><span class="token comment">#                 sufficient memory, if you don't have it, you risk an OOM kill.</span></pre></td></tr><tr><td data-num="137"></td><td><pre>repl-diskless-load disabled</pre></td></tr><tr><td data-num="138"></td><td><pre></pre></td></tr><tr><td data-num="139"></td><td><pre><span class="token comment"># Replicas send PINGs to server in a predefined interval. It's possible to</span></pre></td></tr><tr><td data-num="140"></td><td><pre><span class="token comment"># change this interval with the repl_ping_replica_period option. The default</span></pre></td></tr><tr><td data-num="141"></td><td><pre><span class="token comment"># value is 10 seconds.</span></pre></td></tr><tr><td data-num="142"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="143"></td><td><pre><span class="token comment"># repl-ping-replica-period 10</span></pre></td></tr><tr><td data-num="144"></td><td><pre></pre></td></tr><tr><td data-num="145"></td><td><pre><span class="token comment"># The following option sets the replication timeout for:</span></pre></td></tr><tr><td data-num="146"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="147"></td><td><pre><span class="token comment"># 1) Bulk transfer I/O during SYNC, from the point of view of replica.</span></pre></td></tr><tr><td data-num="148"></td><td><pre><span class="token comment"># 2) Master timeout from the point of view of replicas (data, pings).</span></pre></td></tr><tr><td data-num="149"></td><td><pre><span class="token comment"># 3) Replica timeout from the point of view of masters (REPLCONF ACK pings).</span></pre></td></tr><tr><td data-num="150"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="151"></td><td><pre><span class="token comment"># It is important to make sure that this value is greater than the value</span></pre></td></tr><tr><td data-num="152"></td><td><pre><span class="token comment"># specified for repl-ping-replica-period otherwise a timeout will be detected</span></pre></td></tr><tr><td data-num="153"></td><td><pre><span class="token comment"># every time there is low traffic between the master and the replica. The default</span></pre></td></tr><tr><td data-num="154"></td><td><pre><span class="token comment"># value is 60 seconds.</span></pre></td></tr><tr><td data-num="155"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="156"></td><td><pre><span class="token comment"># repl-timeout 60</span></pre></td></tr><tr><td data-num="157"></td><td><pre></pre></td></tr><tr><td data-num="158"></td><td><pre><span class="token comment"># Disable TCP_NODELAY on the replica socket after SYNC?</span></pre></td></tr><tr><td data-num="159"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="160"></td><td><pre><span class="token comment"># If you select "yes" Redis will use a smaller number of TCP packets and</span></pre></td></tr><tr><td data-num="161"></td><td><pre><span class="token comment"># less bandwidth to send data to replicas. But this can add a delay for</span></pre></td></tr><tr><td data-num="162"></td><td><pre><span class="token comment"># the data to appear on the replica side, up to 40 milliseconds with</span></pre></td></tr><tr><td data-num="163"></td><td><pre><span class="token comment"># Linux kernels using a default configuration.</span></pre></td></tr><tr><td data-num="164"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="165"></td><td><pre><span class="token comment"># If you select "no" the delay for data to appear on the replica side will</span></pre></td></tr><tr><td data-num="166"></td><td><pre><span class="token comment"># be reduced but more bandwidth will be used for replication.</span></pre></td></tr><tr><td data-num="167"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="168"></td><td><pre><span class="token comment"># By default we optimize for low latency, but in very high traffic conditions</span></pre></td></tr><tr><td data-num="169"></td><td><pre><span class="token comment"># or when the master and replicas are many hops away, turning this to "yes" may</span></pre></td></tr><tr><td data-num="170"></td><td><pre><span class="token comment"># be a good idea.</span></pre></td></tr><tr><td data-num="171"></td><td><pre>repl-disable-tcp-nodelay no</pre></td></tr><tr><td data-num="172"></td><td><pre></pre></td></tr><tr><td data-num="173"></td><td><pre><span class="token comment"># Set the replication backlog size. The backlog is a buffer that accumulates</span></pre></td></tr><tr><td data-num="174"></td><td><pre><span class="token comment"># replica data when replicas are disconnected for some time, so that when a</span></pre></td></tr><tr><td data-num="175"></td><td><pre><span class="token comment"># replica wants to reconnect again, often a full resync is not needed, but a</span></pre></td></tr><tr><td data-num="176"></td><td><pre><span class="token comment"># partial resync is enough, just passing the portion of data the replica</span></pre></td></tr><tr><td data-num="177"></td><td><pre><span class="token comment"># missed while disconnected.</span></pre></td></tr><tr><td data-num="178"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="179"></td><td><pre><span class="token comment"># The bigger the replication backlog, the longer the replica can endure the</span></pre></td></tr><tr><td data-num="180"></td><td><pre><span class="token comment"># disconnect and later be able to perform a partial resynchronization.</span></pre></td></tr><tr><td data-num="181"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="182"></td><td><pre><span class="token comment"># The backlog is only allocated if there is at least one replica connected.</span></pre></td></tr><tr><td data-num="183"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="184"></td><td><pre><span class="token comment"># repl-backlog-size 1mb #增量复制的数据大小（队列大小）</span></pre></td></tr><tr><td data-num="185"></td><td><pre></pre></td></tr><tr><td data-num="186"></td><td><pre><span class="token comment"># After a master has no connected replicas for some time, the backlog will be</span></pre></td></tr><tr><td data-num="187"></td><td><pre><span class="token comment"># freed. The following option configures the amount of seconds that need to</span></pre></td></tr><tr><td data-num="188"></td><td><pre><span class="token comment"># elapse, starting from the time the last replica disconnected, for the backlog</span></pre></td></tr><tr><td data-num="189"></td><td><pre><span class="token comment"># buffer to be freed.</span></pre></td></tr><tr><td data-num="190"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="191"></td><td><pre><span class="token comment"># Note that replicas never free the backlog for timeout, since they may be</span></pre></td></tr><tr><td data-num="192"></td><td><pre><span class="token comment"># promoted to masters later, and should be able to correctly "partially</span></pre></td></tr><tr><td data-num="193"></td><td><pre><span class="token comment"># resynchronize" with the replicas: hence they should always accumulate backlog.</span></pre></td></tr><tr><td data-num="194"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="195"></td><td><pre><span class="token comment"># A value of 0 means to never release the backlog.</span></pre></td></tr><tr><td data-num="196"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="197"></td><td><pre><span class="token comment"># repl-backlog-ttl 3600</span></pre></td></tr><tr><td data-num="198"></td><td><pre></pre></td></tr><tr><td data-num="199"></td><td><pre><span class="token comment"># The replica priority is an integer number published by Redis in the INFO</span></pre></td></tr><tr><td data-num="200"></td><td><pre><span class="token comment"># output. It is used by Redis Sentinel in order to select a replica to promote</span></pre></td></tr><tr><td data-num="201"></td><td><pre><span class="token comment"># into a master if the master is no longer working correctly.</span></pre></td></tr><tr><td data-num="202"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="203"></td><td><pre><span class="token comment"># A replica with a low priority number is considered better for promotion, so</span></pre></td></tr><tr><td data-num="204"></td><td><pre><span class="token comment"># for instance if there are three replicas with priority 10, 100, 25 Sentinel</span></pre></td></tr><tr><td data-num="205"></td><td><pre><span class="token comment"># will pick the one with priority 10, that is the lowest.</span></pre></td></tr><tr><td data-num="206"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="207"></td><td><pre><span class="token comment"># However a special priority of 0 marks the replica as not able to perform the</span></pre></td></tr><tr><td data-num="208"></td><td><pre><span class="token comment"># role of master, so a replica with priority of 0 will never be selected by</span></pre></td></tr><tr><td data-num="209"></td><td><pre><span class="token comment"># Redis Sentinel for promotion.</span></pre></td></tr><tr><td data-num="210"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="211"></td><td><pre><span class="token comment"># By default the priority is 100.</span></pre></td></tr><tr><td data-num="212"></td><td><pre>replica-priority <span class="token number">100</span></pre></td></tr><tr><td data-num="213"></td><td><pre></pre></td></tr><tr><td data-num="214"></td><td><pre><span class="token comment"># It is possible for a master to stop accepting writes if there are less than</span></pre></td></tr><tr><td data-num="215"></td><td><pre><span class="token comment"># N replicas connected, having a lag less or equal than M seconds.</span></pre></td></tr><tr><td data-num="216"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="217"></td><td><pre><span class="token comment"># The N replicas need to be in "online" state.</span></pre></td></tr><tr><td data-num="218"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="219"></td><td><pre><span class="token comment"># The lag in seconds, that must be &lt;= the specified value, is calculated from</span></pre></td></tr><tr><td data-num="220"></td><td><pre><span class="token comment"># the last ping received from the replica, that is usually sent every second.</span></pre></td></tr><tr><td data-num="221"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="222"></td><td><pre><span class="token comment"># This option does not GUARANTEE that N replicas will accept the write, but</span></pre></td></tr><tr><td data-num="223"></td><td><pre><span class="token comment"># will limit the window of exposure for lost writes in case not enough replicas</span></pre></td></tr><tr><td data-num="224"></td><td><pre><span class="token comment"># are available, to the specified number of seconds.</span></pre></td></tr><tr><td data-num="225"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="226"></td><td><pre><span class="token comment"># For example to require at least 3 replicas with a lag &lt;= 10 seconds use:</span></pre></td></tr><tr><td data-num="227"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="228"></td><td><pre><span class="token comment"># min-replicas-to-write 3  # 最少完成同步的从机数量，只有达到此数量才算是同步成功</span></pre></td></tr><tr><td data-num="229"></td><td><pre><span class="token comment"># min-replicas-max-lag 10</span></pre></td></tr><tr><td data-num="230"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="231"></td><td><pre><span class="token comment"># Setting one or the other to 0 disables the feature.</span></pre></td></tr><tr><td data-num="232"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="233"></td><td><pre><span class="token comment"># By default min-replicas-to-write is set to 0 (feature disabled) and</span></pre></td></tr><tr><td data-num="234"></td><td><pre><span class="token comment"># min-replicas-max-lag is set to 10.</span></pre></td></tr><tr><td data-num="235"></td><td><pre></pre></td></tr><tr><td data-num="236"></td><td><pre><span class="token comment"># A Redis master is able to list the address and port of the attached</span></pre></td></tr><tr><td data-num="237"></td><td><pre><span class="token comment"># replicas in different ways. For example the "INFO replication" section</span></pre></td></tr><tr><td data-num="238"></td><td><pre><span class="token comment"># offers this information, which is used, among other tools, by</span></pre></td></tr><tr><td data-num="239"></td><td><pre><span class="token comment"># Redis Sentinel in order to discover replica instances.</span></pre></td></tr><tr><td data-num="240"></td><td><pre><span class="token comment"># Another place where this info is available is in the output of the</span></pre></td></tr><tr><td data-num="241"></td><td><pre><span class="token comment"># "ROLE" command of a master.</span></pre></td></tr><tr><td data-num="242"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="243"></td><td><pre><span class="token comment"># The listed IP and address normally reported by a replica is obtained</span></pre></td></tr><tr><td data-num="244"></td><td><pre><span class="token comment"># in the following way:</span></pre></td></tr><tr><td data-num="245"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="246"></td><td><pre><span class="token comment">#   IP: The address is auto detected by checking the peer address</span></pre></td></tr><tr><td data-num="247"></td><td><pre><span class="token comment">#   of the socket used by the replica to connect with the master.</span></pre></td></tr><tr><td data-num="248"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="249"></td><td><pre><span class="token comment">#   Port: The port is communicated by the replica during the replication</span></pre></td></tr><tr><td data-num="250"></td><td><pre><span class="token comment">#   handshake, and is normally the port that the replica is using to</span></pre></td></tr><tr><td data-num="251"></td><td><pre><span class="token comment">#   listen for connections.</span></pre></td></tr><tr><td data-num="252"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="253"></td><td><pre><span class="token comment"># However when port forwarding or Network Address Translation (NAT) is</span></pre></td></tr><tr><td data-num="254"></td><td><pre><span class="token comment"># used, the replica may be actually reachable via different IP and port</span></pre></td></tr><tr><td data-num="255"></td><td><pre><span class="token comment"># pairs. The following two options can be used by a replica in order to</span></pre></td></tr><tr><td data-num="256"></td><td><pre><span class="token comment"># report to its master a specific set of IP and port, so that both INFO</span></pre></td></tr><tr><td data-num="257"></td><td><pre><span class="token comment"># and ROLE will report those values.</span></pre></td></tr><tr><td data-num="258"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="259"></td><td><pre><span class="token comment"># There is no need to use both the options if you need to override just</span></pre></td></tr><tr><td data-num="260"></td><td><pre><span class="token comment"># the port or the IP address.</span></pre></td></tr><tr><td data-num="261"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="262"></td><td><pre><span class="token comment"># replica-announce-ip 5.5.5.5</span></pre></td></tr><tr><td data-num="263"></td><td><pre><span class="token comment"># replica-announce-port 1234</span></pre></td></tr></table></figure><p><img data-src="https://gitee.com/bfanfanfan/img/raw/master/docsify/20201228235916.png" alt="image-20201228235912869"></p><p><img data-src="https://gitee.com/bfanfanfan/img/raw/master/docsify/image-20201229092033642.png" alt="image-20201229092033642"></p><h2 id="redis的高可用"><a class="anchor" href="#redis的高可用">#</a> redis 的高可用</h2><p><strong>由于主从复制，需要人为解决主机故障问题，为了解决这个问题，需要主机是高可用的。</strong></p><p><span class="exturl" data-url="aHR0cDovL3d3dy5yZWRpcy5jbi90b3BpY3Mvc2VudGluZWwuaHRtbA==">高可用性（High Availability）</span>：Redis Sentinel（哨兵）是 Redis 官方的高可用性解决方案。</p><p>Redis 的 Sentinel 系统用于管理多个 Redis 服务器（instance）， 该系统执行以下三个任务：</p><ul><li><strong>监控（Monitoring</strong>）： Sentinel 会不断地检查你的主服务器和从服务器是否运作正常。</li><li><strong>提醒（Notification）</strong>： 当被监控的某个 Redis 服务器出现问题时， Sentinel 可以通过 API 向管理员或者其他应用程序发送通知。</li><li><strong>自动故障迁移（Automatic failover）</strong>： 当一个主服务器不能正常工作时， Sentinel 会开始一次自动故障迁移操作， 它会将失效主服务器的其中一个从服务器升级为新的主服务器， 并让失效主服务器的其他从服务器改为复制新的主服务器； 当客户端试图连接失效的主服务器时， 集群也会向客户端返回新主服务器的地址， 使得集群可以使用新主服务器代替失效服务器。</li></ul><p>Redis Sentinel 是一个分布式系统， 你可以在一个架构中运行多个 Sentinel 进程（progress）， 这些进程使用流言协议（gossip protocols) 来接收关于主服务器是否下线的信息， 并使用投票协议（agreement protocols）来决定是否执行自动故障迁移， 以及选择哪个从服务器作为新的主服务器。</p><p>虽然 Redis Sentinel 释出为一个单独的可执行文件 redis-sentinel ， 但实际上它只是一个运行在特殊模式下的 Redis 服务器， 你可以在启动一个普通 Redis 服务器时通过给定 –sentinel 选项来启动 Redis Sentinel 。也就是说 sentinel 既可以作为一个服务 redis-sentinel 来启动，也可以作为 redis-server 的一部分在 redis-server 启动时给定 –sentinel 来启动。</p><p>演示：</p><p>新建三个 sentinel 文件</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># pwd</span></pre></td></tr><tr><td data-num="2"></td><td><pre>/root/test</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># vim 26379.conf</span></pre></td></tr><tr><td data-num="4"></td><td><pre>port <span class="token number">26379</span></pre></td></tr><tr><td data-num="5"></td><td><pre>sentinel monitor mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="6"></td><td><pre>:wq<span class="token operator">!</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># vim 26380.conf</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>port <span class="token number">26380</span></pre></td></tr><tr><td data-num="12"></td><td><pre>sentinel monitor mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span> <span class="token number">2</span>  <span class="token comment"># 指示 Sentinel 去监视一个名为 mymaster 的主服务器， 这个主服务器的 IP 地址为 127.0.0.1 ， 端口号为 6379 ， 而将这个主服务器判断为失效至少需要 2 个 Sentinel 同意 （只要同意 Sentinel 的数量不达标，自动故障迁移就不会执行）。</span></pre></td></tr><tr><td data-num="13"></td><td><pre>:wq<span class="token operator">!</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># vim 26381.conf</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>port <span class="token number">26381</span></pre></td></tr><tr><td data-num="18"></td><td><pre>sentinel monitor mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="19"></td><td><pre>:wq<span class="token operator">!</span></pre></td></tr></table></figure><p>窗口七：启动 26379 的哨兵</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># redis-server ./26379.conf --sentinel</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">3764</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">18</span>:54:07.521 <span class="token comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">3764</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">18</span>:54:07.521 <span class="token comment"># Redis version=6.0.6, bits=64, commit=00000000, modified=0, pid=3764, just started</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">3764</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">18</span>:54:07.521 <span class="token comment"># Configuration loaded</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">3764</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">18</span>:54:07.522 * Increased maximum number of <span class="token function">open</span> files to <span class="token number">10032</span> <span class="token punctuation">(</span>it was originally <span class="token builtin class-name">set</span> to <span class="token number">1024</span><span class="token punctuation">)</span>.</pre></td></tr><tr><td data-num="6"></td><td><pre>                _._                                                  </pre></td></tr><tr><td data-num="7"></td><td><pre>           _.-`<span class="token variable"><span class="token variable">`</span>__ <span class="token string">''</span>-._                                             </span></pre></td></tr><tr><td data-num="8"></td><td><pre>      _.-<span class="token variable">`</span><span class="token variable"><span class="token variable">`</span>    <span class="token variable">`</span></span><span class="token builtin class-name">.</span>  <span class="token variable"><span class="token variable">`</span>_.  <span class="token string">''</span>-._           Redis <span class="token number">6.0</span>.6 <span class="token punctuation">(</span>00000000/0<span class="token punctuation">)</span> <span class="token number">64</span> bit</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  .-<span class="token variable">`</span><span class="token variable"><span class="token variable">`</span> .-<span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>  <span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token punctuation">\</span>/    _.,_ <span class="token string">''</span>-._                                   </span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">(</span>    '      ,       .-<span class="token variable">`</span>  <span class="token operator">|</span> <span class="token variable"><span class="token variable">`</span>,    <span class="token punctuation">)</span>     Running <span class="token keyword">in</span> sentinel mode</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token operator">|</span><span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-<span class="token punctuation">..</span>.-<span class="token variable">`</span></span> __<span class="token punctuation">..</span>.-.`<span class="token variable"><span class="token variable">`</span>-._<span class="token operator">|</span>'<span class="token variable">`</span></span> _.-<span class="token string">'|     Port: 26379</span></pre></td></tr><tr><td data-num="12"></td><td><pre> |    `-._   `._    /     _.-'    <span class="token operator">|</span>     PID: <span class="token number">3764</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-._  <span class="token variable"><span class="token variable">`</span>-./  _.-<span class="token string">'    _.-'</span>                                   </span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token operator">|</span><span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-.__.-<span class="token string">'    _.-'</span>_.-<span class="token string">'|                                  </span></pre></td></tr><tr><td data-num="15"></td><td><pre> |    `-._`-._        _.-'_.-<span class="token string">'    |           http://redis.io        </span></pre></td></tr><tr><td data-num="16"></td><td><pre>  `-._    `-._`-.__.-'_.-<span class="token string">'    _.-'</span>                                   </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token operator">|</span><span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-._    <span class="token variable"><span class="token variable">`</span>-.__.-<span class="token string">'    _.-'</span>_.-'<span class="token operator">|</span>                                  </span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token operator">|</span>    <span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-._        _.-<span class="token string">'_.-'</span>    <span class="token operator">|</span>                                  </span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token variable">`</span>-._    <span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-.__.-<span class="token string">'_.-'</span>    _.-<span class="token string">'                                   </span></pre></td></tr><tr><td data-num="20"></td><td><pre>      `-._    `-.__.-'    _.-<span class="token string">'                                       </span></pre></td></tr><tr><td data-num="21"></td><td><pre>          `-._        _.-'                                           </pre></td></tr><tr><td data-num="22"></td><td><pre>              `-.__.-'                                               </pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token number">3764</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">18</span>:54:07.620 <span class="token comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token number">3764</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">18</span>:54:07.625 <span class="token comment"># Sentinel ID is 2ae5c3f9d9bcc4c136f1ca2ac2d58f999acd5607</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token number">3764</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">18</span>:54:07.625 <span class="token comment"># +monitor master mymaster 127.0.0.1 6379 quorum 2</span></pre></td></tr></table></figure><p>窗口八：启动 26380 的哨兵</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># redis-server ./26380.conf --sentinel</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">3828</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">18</span>:56:10.509 <span class="token comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">3828</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">18</span>:56:10.509 <span class="token comment"># Redis version=6.0.6, bits=64, commit=00000000, modified=0, pid=3828, just started</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">3828</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">18</span>:56:10.509 <span class="token comment"># Configuration loaded</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">3828</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">18</span>:56:10.510 * Increased maximum number of <span class="token function">open</span> files to <span class="token number">10032</span> <span class="token punctuation">(</span>it was originally <span class="token builtin class-name">set</span> to <span class="token number">1024</span><span class="token punctuation">)</span>.</pre></td></tr><tr><td data-num="6"></td><td><pre>                _._                                                  </pre></td></tr><tr><td data-num="7"></td><td><pre>           _.-`<span class="token variable"><span class="token variable">`</span>__ <span class="token string">''</span>-._                                             </span></pre></td></tr><tr><td data-num="8"></td><td><pre>      _.-<span class="token variable">`</span><span class="token variable"><span class="token variable">`</span>    <span class="token variable">`</span></span><span class="token builtin class-name">.</span>  <span class="token variable"><span class="token variable">`</span>_.  <span class="token string">''</span>-._           Redis <span class="token number">6.0</span>.6 <span class="token punctuation">(</span>00000000/0<span class="token punctuation">)</span> <span class="token number">64</span> bit</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  .-<span class="token variable">`</span><span class="token variable"><span class="token variable">`</span> .-<span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>  <span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token punctuation">\</span>/    _.,_ <span class="token string">''</span>-._                                   </span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">(</span>    '      ,       .-<span class="token variable">`</span>  <span class="token operator">|</span> <span class="token variable"><span class="token variable">`</span>,    <span class="token punctuation">)</span>     Running <span class="token keyword">in</span> sentinel mode</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token operator">|</span><span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-<span class="token punctuation">..</span>.-<span class="token variable">`</span></span> __<span class="token punctuation">..</span>.-.`<span class="token variable"><span class="token variable">`</span>-._<span class="token operator">|</span>'<span class="token variable">`</span></span> _.-<span class="token string">'|     Port: 26380</span></pre></td></tr><tr><td data-num="12"></td><td><pre> |    `-._   `._    /     _.-'    <span class="token operator">|</span>     PID: <span class="token number">3828</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-._  <span class="token variable"><span class="token variable">`</span>-./  _.-<span class="token string">'    _.-'</span>                                   </span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token operator">|</span><span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-.__.-<span class="token string">'    _.-'</span>_.-<span class="token string">'|                                  </span></pre></td></tr><tr><td data-num="15"></td><td><pre> |    `-._`-._        _.-'_.-<span class="token string">'    |           http://redis.io        </span></pre></td></tr><tr><td data-num="16"></td><td><pre>  `-._    `-._`-.__.-'_.-<span class="token string">'    _.-'</span>                                   </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token operator">|</span><span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-._    <span class="token variable"><span class="token variable">`</span>-.__.-<span class="token string">'    _.-'</span>_.-'<span class="token operator">|</span>                                  </span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token operator">|</span>    <span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-._        _.-<span class="token string">'_.-'</span>    <span class="token operator">|</span>                                  </span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token variable">`</span>-._    <span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-.__.-<span class="token string">'_.-'</span>    _.-<span class="token string">'                                   </span></pre></td></tr><tr><td data-num="20"></td><td><pre>      `-._    `-.__.-'    _.-<span class="token string">'                                       </span></pre></td></tr><tr><td data-num="21"></td><td><pre>          `-._        _.-'                                           </pre></td></tr><tr><td data-num="22"></td><td><pre>              `-.__.-'                                               </pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token number">3828</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">18</span>:56:10.512 <span class="token comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token number">3828</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">18</span>:56:10.514 <span class="token comment"># Sentinel ID is 7df4035261b917ca58ff5284f0f8123a75975a94</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token number">3828</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">18</span>:56:10.514 <span class="token comment"># +monitor master mymaster 127.0.0.1 6379 quorum 2</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token number">3828</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">18</span>:56:11.994 * +sentinel sentinel 2ae5c3f9d9bcc4c136f1ca2ac2d58f999acd5607 <span class="token number">127.0</span>.0.1 <span class="token number">26379</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span></pre></td></tr></table></figure><p>窗口九：启动 26381 的哨兵</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># redis-server ./26381.conf --sentinel</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:00:25.532 <span class="token comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:00:25.532 <span class="token comment"># Redis version=6.0.6, bits=64, commit=00000000, modified=0, pid=3907, just started</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:00:25.532 <span class="token comment"># Configuration loaded</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:00:25.533 * Increased maximum number of <span class="token function">open</span> files to <span class="token number">10032</span> <span class="token punctuation">(</span>it was originally <span class="token builtin class-name">set</span> to <span class="token number">1024</span><span class="token punctuation">)</span>.</pre></td></tr><tr><td data-num="6"></td><td><pre>                _._                                                  </pre></td></tr><tr><td data-num="7"></td><td><pre>           _.-`<span class="token variable"><span class="token variable">`</span>__ <span class="token string">''</span>-._                                             </span></pre></td></tr><tr><td data-num="8"></td><td><pre>      _.-<span class="token variable">`</span><span class="token variable"><span class="token variable">`</span>    <span class="token variable">`</span></span><span class="token builtin class-name">.</span>  <span class="token variable"><span class="token variable">`</span>_.  <span class="token string">''</span>-._           Redis <span class="token number">6.0</span>.6 <span class="token punctuation">(</span>00000000/0<span class="token punctuation">)</span> <span class="token number">64</span> bit</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  .-<span class="token variable">`</span><span class="token variable"><span class="token variable">`</span> .-<span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>  <span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token punctuation">\</span>/    _.,_ <span class="token string">''</span>-._                                   </span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">(</span>    '      ,       .-<span class="token variable">`</span>  <span class="token operator">|</span> <span class="token variable"><span class="token variable">`</span>,    <span class="token punctuation">)</span>     Running <span class="token keyword">in</span> sentinel mode</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token operator">|</span><span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-<span class="token punctuation">..</span>.-<span class="token variable">`</span></span> __<span class="token punctuation">..</span>.-.`<span class="token variable"><span class="token variable">`</span>-._<span class="token operator">|</span>'<span class="token variable">`</span></span> _.-<span class="token string">'|     Port: 26381</span></pre></td></tr><tr><td data-num="12"></td><td><pre> |    `-._   `._    /     _.-'    <span class="token operator">|</span>     PID: <span class="token number">3907</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-._  <span class="token variable"><span class="token variable">`</span>-./  _.-<span class="token string">'    _.-'</span>                                   </span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token operator">|</span><span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-.__.-<span class="token string">'    _.-'</span>_.-<span class="token string">'|                                  </span></pre></td></tr><tr><td data-num="15"></td><td><pre> |    `-._`-._        _.-'_.-<span class="token string">'    |           http://redis.io        </span></pre></td></tr><tr><td data-num="16"></td><td><pre>  `-._    `-._`-.__.-'_.-<span class="token string">'    _.-'</span>                                   </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token operator">|</span><span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-._    <span class="token variable"><span class="token variable">`</span>-.__.-<span class="token string">'    _.-'</span>_.-'<span class="token operator">|</span>                                  </span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token operator">|</span>    <span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-._        _.-<span class="token string">'_.-'</span>    <span class="token operator">|</span>                                  </span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token variable">`</span>-._    <span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-.__.-<span class="token string">'_.-'</span>    _.-<span class="token string">'                                   </span></pre></td></tr><tr><td data-num="20"></td><td><pre>      `-._    `-.__.-'    _.-<span class="token string">'                                       </span></pre></td></tr><tr><td data-num="21"></td><td><pre>          `-._        _.-'                                           </pre></td></tr><tr><td data-num="22"></td><td><pre>              `-.__.-'                                               </pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:00:25.534 <span class="token comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:00:25.537 <span class="token comment"># Sentinel ID is 4d024f441679841977a13b018555e0dc2543ed23</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:00:25.537 <span class="token comment"># +monitor master mymaster 127.0.0.1 6379 quorum 2</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:00:26.760 * +sentinel sentinel 2ae5c3f9d9bcc4c136f1ca2ac2d58f999acd5607 <span class="token number">127.0</span>.0.1 <span class="token number">26379</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:00:27.463 * +sentinel sentinel 7df4035261b917ca58ff5284f0f8123a75975a94 <span class="token number">127.0</span>.0.1 <span class="token number">26380</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span></pre></td></tr></table></figure><p>!&gt; 此时，让主机 6379 服务器挂掉（CTRL + C 结束服务），看 sentinel 哨兵能否将故障迁移，选出一个从机作为新的主机</p><p>窗口七：哨兵 26379 的日志输出</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">3764</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:35.587 <span class="token comment"># +sdown master mymaster 127.0.0.1 6379 #监测到主服务器 6379 挂掉了</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">3764</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:35.675 <span class="token comment"># +new-epoch 1 #开启一个新的纪元，即一个新的主服务器的版本号</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">3764</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:35.684 <span class="token comment"># +vote-for-leader 4d024f441679841977a13b018555e0dc2543ed23 1  #给新的主服务器（版本号）选票投一票</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">3764</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.295 <span class="token comment"># +config-update-from sentinel 4d024f441679841977a13b018555e0dc2543ed23 127.0.0.1 26381 @ mymaster 127.0.0.1 6379 #更新自己的配置文件</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">3764</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.295 <span class="token comment"># +switch-master mymaster 127.0.0.1 6379 127.0.0.1 6380 #监听转换到新的主机 6380</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">3764</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.295 * +slave slave <span class="token number">127.0</span>.0.1:6381 <span class="token number">127.0</span>.0.1 <span class="token number">6381</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6380</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">3764</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.295 * +slave slave <span class="token number">127.0</span>.0.1:6379 <span class="token number">127.0</span>.0.1 <span class="token number">6379</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6380</span> <span class="token comment">#原来的 6379 如果再次启动，那么也将作为从机</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">3764</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:13:06.297 <span class="token comment"># +sdown slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380</span></pre></td></tr></table></figure><p>哨兵 26379 的配置文件：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>port <span class="token number">26379</span></pre></td></tr><tr><td data-num="2"></td><td><pre>sentinel myid 2ae5c3f9d9bcc4c136f1ca2ac2d58f999acd5607</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># Generated by CONFIG REWRITE</span></pre></td></tr><tr><td data-num="4"></td><td><pre>protected-mode no</pre></td></tr><tr><td data-num="5"></td><td><pre>user default on nopass ~* +@all</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">dir</span> <span class="token string">"/root/test"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>sentinel deny-scripts-reconfig <span class="token function">yes</span></pre></td></tr><tr><td data-num="8"></td><td><pre>sentinel monitor mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6380</span> <span class="token number">2</span> <span class="token comment">#6380 获得两票被选为新主机</span></pre></td></tr><tr><td data-num="9"></td><td><pre>sentinel config-epoch mymaster <span class="token number">1</span></pre></td></tr><tr><td data-num="10"></td><td><pre>sentinel leader-epoch mymaster <span class="token number">1</span></pre></td></tr><tr><td data-num="11"></td><td><pre>sentinel known-replica mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6381</span></pre></td></tr><tr><td data-num="12"></td><td><pre>sentinel known-replica mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">#之所以能监听到其他哨兵，是因为新的主机开启了订阅功能，哨兵之间通过主机的发布订阅可以互相发现</span></pre></td></tr><tr><td data-num="14"></td><td><pre>sentinel known-sentinel mymaster <span class="token number">127.0</span>.0.1 <span class="token number">26381</span> 4d024f441679841977a13b018555e0dc2543ed23</pre></td></tr><tr><td data-num="15"></td><td><pre>sentinel known-sentinel mymaster <span class="token number">127.0</span>.0.1 <span class="token number">26380</span> 7df4035261b917ca58ff5284f0f8123a75975a94</pre></td></tr><tr><td data-num="16"></td><td><pre>sentinel current-epoch <span class="token number">1</span></pre></td></tr></table></figure><p>窗口八：哨兵 26380 的日志输出</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">3828</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:35.640 <span class="token comment"># +sdown master mymaster 127.0.0.1 6379</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">3828</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:35.680 <span class="token comment"># +new-epoch 1</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">3828</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:35.683 <span class="token comment"># +vote-for-leader 4d024f441679841977a13b018555e0dc2543ed23 1</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">3828</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:35.741 <span class="token comment"># +odown master mymaster 127.0.0.1 6379 #quorum 3/2</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">3828</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:35.742 <span class="token comment"># Next failover delay: I will not start a failover before Tue Dec 29 19:18:36 2020</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">3828</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.299 <span class="token comment"># +config-update-from sentinel 4d024f441679841977a13b018555e0dc2543ed23 127.0.0.1 26381 @ mymaster 127.0.0.1 6379</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">3828</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.299 <span class="token comment"># +switch-master mymaster 127.0.0.1 6379 127.0.0.1 6380</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">3828</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.299 * +slave slave <span class="token number">127.0</span>.0.1:6381 <span class="token number">127.0</span>.0.1 <span class="token number">6381</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6380</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">3828</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.299 * +slave slave <span class="token number">127.0</span>.0.1:6379 <span class="token number">127.0</span>.0.1 <span class="token number">6379</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6380</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">3828</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:13:06.370 <span class="token comment"># +sdown slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380</span></pre></td></tr></table></figure><p>哨兵 26380 的配置文件：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># vim 26380.conf </span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>port <span class="token number">26380</span></pre></td></tr><tr><td data-num="4"></td><td><pre>sentinel myid 7df4035261b917ca58ff5284f0f8123a75975a94</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># Generated by CONFIG REWRITE</span></pre></td></tr><tr><td data-num="6"></td><td><pre>protected-mode no</pre></td></tr><tr><td data-num="7"></td><td><pre>user default on nopass ~* +@all</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">dir</span> <span class="token string">"/root/test"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>sentinel deny-scripts-reconfig <span class="token function">yes</span></pre></td></tr><tr><td data-num="10"></td><td><pre>sentinel monitor mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6380</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="11"></td><td><pre>sentinel config-epoch mymaster <span class="token number">1</span></pre></td></tr><tr><td data-num="12"></td><td><pre>sentinel leader-epoch mymaster <span class="token number">1</span></pre></td></tr><tr><td data-num="13"></td><td><pre>sentinel known-replica mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span></pre></td></tr><tr><td data-num="14"></td><td><pre>sentinel known-replica mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6381</span></pre></td></tr><tr><td data-num="15"></td><td><pre>sentinel known-sentinel mymaster <span class="token number">127.0</span>.0.1 <span class="token number">26379</span> 2ae5c3f9d9bcc4c136f1ca2ac2d58f999acd5607 </pre></td></tr><tr><td data-num="16"></td><td><pre>sentinel known-sentinel mymaster <span class="token number">127.0</span>.0.1 <span class="token number">26381</span> 4d024f441679841977a13b018555e0dc2543ed23</pre></td></tr><tr><td data-num="17"></td><td><pre>sentinel current-epoch <span class="token number">1</span></pre></td></tr><tr><td data-num="18"></td><td><pre>~</pre></td></tr></table></figure><p>窗口九：哨兵 26381 的日志输出</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:35.597 <span class="token comment"># +sdown master mymaster 127.0.0.1 6379</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:35.657 <span class="token comment"># +odown master mymaster 127.0.0.1 6379 #quorum 2/2</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:35.657 <span class="token comment"># +new-epoch 1</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:35.657 <span class="token comment"># +try-failover master mymaster 127.0.0.1 6379</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:35.663 <span class="token comment"># +vote-for-leader 4d024f441679841977a13b018555e0dc2543ed23 1</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:35.684 <span class="token comment"># 7df4035261b917ca58ff5284f0f8123a75975a94 voted for 4d024f441679841977a13b018555e0dc2543ed23 1</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:35.684 <span class="token comment"># 2ae5c3f9d9bcc4c136f1ca2ac2d58f999acd5607 voted for 4d024f441679841977a13b018555e0dc2543ed23 1</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:35.755 <span class="token comment"># +elected-leader master mymaster 127.0.0.1 6379</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:35.755 <span class="token comment"># +failover-state-select-slave master mymaster 127.0.0.1 6379</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:35.827 <span class="token comment"># +selected-slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:35.827 * +failover-state-send-slaveof-noone slave <span class="token number">127.0</span>.0.1:6380 <span class="token number">127.0</span>.0.1 <span class="token number">6380</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:35.887 * +failover-state-wait-promotion slave <span class="token number">127.0</span>.0.1:6380 <span class="token number">127.0</span>.0.1 <span class="token number">6380</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.196 <span class="token comment"># +promoted-slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.196 <span class="token comment"># +failover-state-reconf-slaves master mymaster 127.0.0.1 6379</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.294 * +slave-reconf-sent slave <span class="token number">127.0</span>.0.1:6381 <span class="token number">127.0</span>.0.1 <span class="token number">6381</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.792 <span class="token comment"># -odown master mymaster 127.0.0.1 6379</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:37.258 * +slave-reconf-inprog slave <span class="token number">127.0</span>.0.1:6381 <span class="token number">127.0</span>.0.1 <span class="token number">6381</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:37.258 * +slave-reconf-done slave <span class="token number">127.0</span>.0.1:6381 <span class="token number">127.0</span>.0.1 <span class="token number">6381</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:37.313 <span class="token comment"># +failover-end master mymaster 127.0.0.1 6379</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:37.313 <span class="token comment"># +switch-master mymaster 127.0.0.1 6379 127.0.0.1 6380</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:37.313 * +slave slave <span class="token number">127.0</span>.0.1:6381 <span class="token number">127.0</span>.0.1 <span class="token number">6381</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6380</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:37.313 * +slave slave <span class="token number">127.0</span>.0.1:6379 <span class="token number">127.0</span>.0.1 <span class="token number">6379</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6380</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token number">3907</span>:X <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:13:07.329 <span class="token comment"># +sdown slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380</span></pre></td></tr></table></figure><p>哨兵 26381 的配置文件：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># vim 26381.conf </span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>port <span class="token number">26381</span></pre></td></tr><tr><td data-num="4"></td><td><pre>sentinel myid 4d024f441679841977a13b018555e0dc2543ed23</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># Generated by CONFIG REWRITE</span></pre></td></tr><tr><td data-num="6"></td><td><pre>protected-mode no</pre></td></tr><tr><td data-num="7"></td><td><pre>user default on nopass ~* +@all</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">dir</span> <span class="token string">"/root/test"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>sentinel deny-scripts-reconfig <span class="token function">yes</span></pre></td></tr><tr><td data-num="10"></td><td><pre>sentinel monitor mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6380</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="11"></td><td><pre>sentinel config-epoch mymaster <span class="token number">1</span></pre></td></tr><tr><td data-num="12"></td><td><pre>sentinel leader-epoch mymaster <span class="token number">1</span></pre></td></tr><tr><td data-num="13"></td><td><pre>sentinel known-replica mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span></pre></td></tr><tr><td data-num="14"></td><td><pre>sentinel known-replica mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6381</span></pre></td></tr><tr><td data-num="15"></td><td><pre>sentinel known-sentinel mymaster <span class="token number">127.0</span>.0.1 <span class="token number">26380</span> 7df4035261b917ca58ff5284f0f8123a75975a94</pre></td></tr><tr><td data-num="16"></td><td><pre>sentinel known-sentinel mymaster <span class="token number">127.0</span>.0.1 <span class="token number">26379</span> 2ae5c3f9d9bcc4c136f1ca2ac2d58f999acd5607</pre></td></tr><tr><td data-num="17"></td><td><pre>sentinel current-epoch <span class="token number">1</span></pre></td></tr><tr><td data-num="18"></td><td><pre>~</pre></td></tr></table></figure><p>窗口五：从机 6381 开始同步新的主机 6380 的数据</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">3957</span>:S <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.304 * REPLICAOF <span class="token number">127.0</span>.0.1:6380 enabled <span class="token punctuation">(</span>user request from <span class="token string">'id=7 addr=127.0.0.1:47408 fd=10 name=sentinel-4d024f44-cmd age=510 idle=0 flags=x db=0 sub=0 psub=0 multi=4 qbuf=329 qbuf-free=32439 obl=45 oll=0 omem=0 events=r cmd=exec user=default'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">3957</span>:S <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.307 <span class="token comment"># CONFIG REWRITE executed with success.</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">3957</span>:S <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.867 * Connecting to MASTER <span class="token number">127.0</span>.0.1:6380</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">3957</span>:S <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.867 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA <span class="token function">sync</span> started</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">3957</span>:S <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.867 * Non blocking connect <span class="token keyword">for</span> SYNC fired the event.</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">3957</span>:S <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.871 * Master replied to PING, replication can continue<span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">3957</span>:S <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.871 * Trying a partial resynchronization <span class="token punctuation">(</span>request 90dc73b40f1b0bb818fde2ac4570816b2a21568a:107336<span class="token punctuation">)</span>.</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">3957</span>:S <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.872 * Successful partial resynchronization with master.</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">3957</span>:S <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.872 <span class="token comment"># Master replication ID changed to 1e39e810ef5f08dda83e571cac5452bd3cd73257</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">3957</span>:S <span class="token number">29</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:12:36.872 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA sync: Master accepted a Partial Resynchronization.</pre></td></tr></table></figure><p>窗口四：通过主机 6380 的发布订阅功能，哨兵之间可以互相建立联系</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">0</span>></span> PSUBSCRIBE *</pre></td></tr><tr><td data-num="2"></td><td><pre>Reading messages<span class="token punctuation">..</span>. <span class="token punctuation">(</span>press Ctrl-C to quit<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"psubscribe"</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"*"</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"pmessage"</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"*"</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"__sentinel__:hello"</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"127.0.0.1,26380,7df4035261b917ca58ff5284f0f8123a75975a94,1,mymaster,127.0.0.1,6380,1"</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"pmessage"</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"*"</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"__sentinel__:hello"</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"127.0.0.1,26381,4d024f441679841977a13b018555e0dc2543ed23,1,mymaster,127.0.0.1,6380,1"</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"pmessage"</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"*"</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"__sentinel__:hello"</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"127.0.0.1,26379,2ae5c3f9d9bcc4c136f1ca2ac2d58f999acd5607,1,mymaster,127.0.0.1,6380,1"</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"pmessage"</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"*"</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"__sentinel__:hello"</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"127.0.0.1,26380,7df4035261b917ca58ff5284f0f8123a75975a94,1,mymaster,127.0.0.1,6380,1"</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"pmessage"</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"*"</span></pre></td></tr></table></figure><h2 id="redis的分区"><a class="anchor" href="#redis的分区">#</a> redis 的分区</h2><p><span class="exturl" data-url="aHR0cDovL3d3dy5yZWRpcy5jbi90b3BpY3MvcGFydGl0aW9uaW5nLmh0bWw=">分区（Partitioning）</span>：如何将你的数据分布在多个 Redis 里面。</p><p>redis 的主从复制只是解决了 redis 实例单点故障的问题，并没有解决单个 redis 实例的容量问题。如果单个 redis 实例过大的话，那么 redis 的持久化以及序列化的性能会降低。所以，需要将 redis 实例的大小根据业务来做调整，使得 redis 变得轻盈，充分发挥 redis 的性能。</p><p>分区是将你的数据分发到不同 redis 实例上的一个过程，每个 redis 实例只是你所有 key 的一个子集。所以，<strong>redis 的分区可以解决单个 redis 实例容量大小的问题。</strong></p><h3 id="分区基本概念"><a class="anchor" href="#分区基本概念">#</a> 分区基本概念</h3><p>有许多分区标准。假如我们有 4 个 Redis 实例<strong> R0</strong>, <strong>R1</strong>, <strong>R2</strong>, <strong>R3</strong>, 有一批用户数据 <code>user:1</code> , <code>user:2</code> , … , 那么有很多存储方案可以选择。从另一方面说，有很多<em> different systems to map</em> 方案可以决定用户映射到哪个 Redis 实例。</p><p>一种最简单的方法就是<strong>范围分区</strong>，就是将不同范围的对象映射到不同 Redis 实例。比如说，用户 ID 从 0 到 10000 的都被存储到<strong> R0</strong>, 用户 ID 从 10001 到 20000 被存储到<strong> R1</strong>, 依此类推。</p><p>这是一种可行方案并且很多人已经在使用。但是这种方案也有缺点，你需要建一张表存储数据到 redis 实例的映射关系。这张表需要非常谨慎地维护并且需要为每一类对象建立映射关系，所以 redis 范围分区通常并不像你想象的那样运行，比另外一种分区方案效率要低很多。</p><p>另一种可选的范围分区方案是<strong>散列分区</strong>，这种方案要求更低，不需要 key 必须是 <code>object_name:&lt;id&gt;</code> 的形式，如此简单：</p><ul><li>使用散列函数 (如 <code>crc32</code> ) 将键名称转换为一个数字。例：键 <code>foobar</code> , 使用 <code>crc32(foobar)</code> 函数将产生散列值 <code>93024922</code> 。</li><li>对转换后的散列值进行取模，以产生一个 0 到 3 的数字，以便可以使这个 key 映射到 4 个 Redis 实例当中的一个。 <code>93024922 % 4</code> 等于 <code>2</code> , 所以 <code>foobar</code> 会被存储到第 2 个 Redis 实例。 <strong>R2</strong> <em>注意：对一个数字进行取模，在大多数编程语言中是使用运算符 %</em></li></ul><p>还有很多分区方法，上面只是给出了两个简单示例。有一种比较高级的散列分区方法叫<strong>一致性哈希</strong>，并且有一些客户端和代理（proxies) 已经实现。</p><h3 id="客户端分区"><a class="anchor" href="#客户端分区">#</a> 客户端分区</h3><p>就是在客户端就已经决定数据会被存储到哪个 redis 节点或者从哪个 redis 节点读取。大多数客户端已经实现了客户端分区。</p><p>方式一：</p><p>客户端通过逻辑代码来进行业务拆分，使得不同的业务访问不同的 redis 实例</p><p><img data-src="https://gitee.com/bfanfanfan/img/raw/master/docsify/image-20201230085638454.png" alt="image-20201230085638454"></p><p>方式二：</p><p>2.1、业务逻辑中数据不可再拆分，此时将该业务的数据进行分片（sharding）：hash 算法，每个 key 对应的数据对 redis 实例个数取模，结果就是要存放数据的 redis 实例。hash 算法弊端：取模的数必须固定，该数影响分布式下的扩展性。比如：当 redis 实例个数增加后，模数也会发生变化，那么数据在各个 redis 实例中的分布就会发生变化，此时使用原有的方式取数据的话就无法取到数据</p><p><img data-src="https://gitee.com/bfanfanfan/img/raw/master/docsify/image-20201230085719229.png" alt="image-20201230085719229"></p><p>2.2、客户端随机将数据存入不同的 redis 实例，但是取的时候却无法按照需求取出数据。适合 key 为 list，且同一个 key 在各个 redis 实例中都存在的情况，这样另一个客户端只需要 pop 一下 list 中的 key 即可取出数据。可以作为消息队列的实现，此时 key 为 topic、redis 实例为 partition，这也是 kafka 的实现。</p><p><img data-src="https://gitee.com/bfanfanfan/img/raw/master/docsify/image-20201230085815862.png" alt="image-20201230085815862"></p><p>2.3、一致性哈希算法：kemata。不同于哈希取模算法，该算法是哈希映射算法，给出的字符串经过该算法后得到一个等长度的字符串。用在 redis 中要求 key 以及 redis 节点都参与该算法的运算，结果得到一个哈希环，哈希环上的每一个点都是数据以及节点参与运算的结果。</p><p><img data-src="https://gitee.com/bfanfanfan/img/raw/master/docsify/image-20201230085912049.png" alt="image-20201230085912049"></p><p>哈希环的优点：增加节点可以分担其他节点的压力，且不会造成整体数据在节点中的重新分布。</p><p>哈希环的缺点：由于虚拟节点是去离自己最近的物理节点去查询数据的，那么当在该虚拟节点和物理节点新增一个物理节点时，此时虚拟节点就会去新增的物理节点查询数据，而数据之前已经按照哈希一致性算法存入了之前的物理节点缓存中，所以在新增的物理节点缓存中无法查询到数据，此时就会击穿缓存去数据库查询。一个笨拙的解决方法就是每次去查询离虚拟节点最近的两个物理节点，只要有一个物理节点缓存中有相应的数据即可。</p><p><strong>以上方法的缺点：只能做分布式缓存，而不能作为分布式数据库。</strong></p><h3 id="代理分区"><a class="anchor" href="#代理分区">#</a> 代理分区</h3><p>意味着客户端将请求发送给代理，然后代理决定去哪个节点写数据或者读数据。代理根据分区规则决定请求哪些 Redis 实例，然后根据 Redis 的响应结果返回给客户端。</p><p>多客户端连接 redis 实例时的处理，以上 redis 容量问题解决中都是放在客户端来处理，此外还可以将处理放在代理层：</p><p><img data-src="https://gitee.com/bfanfanfan/img/raw/master/docsify/image-20201230100126792.png" alt="image-20201230100126792"></p><p><img data-src="https://gitee.com/bfanfanfan/img/raw/master/docsify/image-20201230101048403.png" alt="image-20201230101048403"></p><p><img data-src="https://gitee.com/bfanfanfan/img/raw/master/docsify/image-20201230100258443.png" alt="image-20201230100258443"></p><p>redis 和 memcached 的一种代理实现就是<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R3aXR0ZXIvdHdlbXByb3h5"> Twemproxy</span>。</p><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R3aXR0ZXIvdHdlbXByb3h5">Twemproxy 是 Twitter 维护的（缓存）代理系统</span>，代理 Memcached 的 ASCII 协议和 Redis 协议。它是单线程程序，使用 c 语言编写，运行起来非常快。它是采用 Apache 2.0 license 的开源软件。</p><p>Twemproxy 支持自动分区，如果其代理的其中一个 Redis 节点不可用时，会自动将该节点排除（这将改变原来的 keys-instances 的映射关系，所以你应该仅在把 Redis 当缓存时使用 Twemproxy)。</p><p>Twemproxy 本身不存在单点问题，因为你可以启动多个 Twemproxy 实例，然后让你的客户端去连接任意一个 Twemproxy 实例。</p><p>Twemproxy 是 Redis 客户端和服务器端的一个中间层，由它来处理分区功能应该不算复杂，并且应该算比较可靠的。</p><p>更多关于 Twemproxy <span class="exturl" data-url="aHR0cDovL2FudGlyZXouY29tL25ld3MvNDQ=">in this antirez blog post</span>.</p><p>还有其他一些 redis 代理也实现了自动分区：predixy、codis、redis-cerberus 等。</p><h4 id="twemproxy"><a class="anchor" href="#twemproxy">#</a> twemproxy</h4><p>接下来演示 twemproxy 的使用：</p><p>下载 twemproxy 并解压</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#有网络的话直接使用 wget 下载即可，没有网络的话就去 github 下载然后传输到 linux 中解压即可</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># wget https://github.com/twitter/twemproxy.git</span></pre></td></tr><tr><td data-num="3"></td><td><pre>--2020-12-31 00:22:54--  https://github.com/twitter/twemproxy.git</pre></td></tr><tr><td data-num="4"></td><td><pre>正在解析主机 github.com <span class="token punctuation">(</span>github.com<span class="token punctuation">)</span><span class="token punctuation">..</span>. <span class="token number">13.229</span>.188.59</pre></td></tr><tr><td data-num="5"></td><td><pre>正在连接 github.com <span class="token punctuation">(</span>github.com<span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">13.229</span>.188.59<span class="token operator">|</span>:443<span class="token punctuation">..</span>. 已连接。</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">#需要事先安装两个 rpm：automake 和 libtool  （没有网络的话就只能手动去 rpm 相关网站去下载，但是相互依赖不好解决）</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># yum install automake libtool -y</span></pre></td></tr><tr><td data-num="9"></td><td><pre>CentOS-8 - AppStream                                       <span class="token number">1.7</span> kB/s <span class="token operator">|</span> <span class="token number">4.3</span> kB     00:02    </pre></td></tr><tr><td data-num="10"></td><td><pre>CentOS-8 - AppStream                                       <span class="token number">719</span> kB/s <span class="token operator">|</span> <span class="token number">6.3</span> MB     00:08    </pre></td></tr><tr><td data-num="11"></td><td><pre>CentOS-8 - Base                                            <span class="token number">316</span>  B/s <span class="token operator">|</span> <span class="token number">3.9</span> kB     00:12    </pre></td></tr><tr><td data-num="12"></td><td><pre>CentOS-8 - Base                                            <span class="token number">407</span> kB/s <span class="token operator">|</span> <span class="token number">2.3</span> MB     00:05    </pre></td></tr><tr><td data-num="13"></td><td><pre>CentOS-8 - Extras                                          <span class="token number">427</span>  B/s <span class="token operator">|</span> <span class="token number">1.5</span> kB     00:03                                                                                                            </pre></td></tr><tr><td data-num="14"></td><td><pre>Package automake-1.16.1-6.el8.noarch is already installed.</pre></td></tr><tr><td data-num="15"></td><td><pre>Package libtool-2.4.6-25.el8.x86_64 is already installed.</pre></td></tr><tr><td data-num="16"></td><td><pre>依赖关系解决。</pre></td></tr><tr><td data-num="17"></td><td><pre>无需任何处理。</pre></td></tr><tr><td data-num="18"></td><td><pre>完毕！</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cd twemproxy-master/</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@localhost twemproxy-master<span class="token punctuation">]</span><span class="token comment"># ll</span></pre></td></tr><tr><td data-num="3"></td><td><pre>总用量 <span class="token number">72</span></pre></td></tr><tr><td data-num="4"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">5709</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 ChangeLog</pre></td></tr><tr><td data-num="5"></td><td><pre>drwxr-xr-x. <span class="token number">2</span> root root    <span class="token number">82</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 conf</pre></td></tr><tr><td data-num="6"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">6082</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 configure.ac</pre></td></tr><tr><td data-num="7"></td><td><pre>drwxr-xr-x. <span class="token number">3</span> root root    <span class="token number">68</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 contrib</pre></td></tr><tr><td data-num="8"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root   <span class="token number">188</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 Dockerfile</pre></td></tr><tr><td data-num="9"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">10173</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 LICENSE</pre></td></tr><tr><td data-num="10"></td><td><pre>drwxr-xr-x. <span class="token number">2</span> root root    <span class="token number">24</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 m4</pre></td></tr><tr><td data-num="11"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root   <span class="token number">242</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 Makefile.am</pre></td></tr><tr><td data-num="12"></td><td><pre>drwxr-xr-x. <span class="token number">2</span> root root    <span class="token number">26</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 <span class="token function">man</span></pre></td></tr><tr><td data-num="13"></td><td><pre>drwxr-xr-x. <span class="token number">2</span> root root   <span class="token number">143</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 notes</pre></td></tr><tr><td data-num="14"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">6308</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 NOTICE</pre></td></tr><tr><td data-num="15"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">16792</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 README.md</pre></td></tr><tr><td data-num="16"></td><td><pre>drwxr-xr-x. <span class="token number">2</span> root root   <span class="token number">270</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 scripts</pre></td></tr><tr><td data-num="17"></td><td><pre>drwxr-xr-x. <span class="token number">5</span> root root  <span class="token number">4096</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 src</pre></td></tr><tr><td data-num="18"></td><td><pre>drwxr-xr-x. <span class="token number">9</span> root root   <span class="token number">151</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 tests</pre></td></tr><tr><td data-num="19"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root   <span class="token number">722</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 travis.sh</pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">[</span>root@localhost twemproxy-master<span class="token punctuation">]</span><span class="token comment"># autoreconf -fvi</span></pre></td></tr><tr><td data-num="21"></td><td><pre>autoreconf: Entering directory <span class="token variable"><span class="token variable">`</span>.'</span></pre></td></tr><tr><td data-num="22"></td><td><pre>autoreconf: configure.ac: not using Gettext</pre></td></tr><tr><td data-num="23"></td><td><pre>autoreconf: running: aclocal --force -I m4</pre></td></tr><tr><td data-num="24"></td><td><pre>autoreconf: configure.ac: tracing</pre></td></tr><tr><td data-num="25"></td><td><pre>autoreconf: configure.ac: adding subdirectory contrib/yaml-0.1.4 to autoreconf</pre></td></tr><tr><td data-num="26"></td><td><pre>autoreconf: Entering directory <span class="token variable">`</span>contrib/yaml-0.1.4<span class="token string">'</span></pre></td></tr><tr><td data-num="27"></td><td><pre>autoreconf: configure.ac: not using Autoconf</pre></td></tr><tr><td data-num="28"></td><td><pre>autoreconf: Leaving directory `contrib/yaml-0.1.4'</pre></td></tr><tr><td data-num="29"></td><td><pre>autoreconf: configure.ac: creating directory config</pre></td></tr><tr><td data-num="30"></td><td><pre>autoreconf: running: libtoolize --copy --force</pre></td></tr><tr><td data-num="31"></td><td><pre>libtoolize: putting auxiliary files <span class="token keyword">in</span> AC_CONFIG_AUX_DIR, <span class="token string">'config'</span><span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="32"></td><td><pre>libtoolize: copying <span class="token function">file</span> <span class="token string">'config/ltmain.sh'</span></pre></td></tr><tr><td data-num="33"></td><td><pre>libtoolize: putting macros <span class="token keyword">in</span> AC_CONFIG_MACRO_DIRS, <span class="token string">'m4'</span><span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="34"></td><td><pre>libtoolize: copying <span class="token function">file</span> <span class="token string">'m4/libtool.m4'</span></pre></td></tr><tr><td data-num="35"></td><td><pre>libtoolize: copying <span class="token function">file</span> <span class="token string">'m4/ltoptions.m4'</span></pre></td></tr><tr><td data-num="36"></td><td><pre>libtoolize: copying <span class="token function">file</span> <span class="token string">'m4/ltsugar.m4'</span></pre></td></tr><tr><td data-num="37"></td><td><pre>libtoolize: copying <span class="token function">file</span> <span class="token string">'m4/ltversion.m4'</span></pre></td></tr><tr><td data-num="38"></td><td><pre>libtoolize: copying <span class="token function">file</span> <span class="token string">'m4/lt~obsolete.m4'</span></pre></td></tr><tr><td data-num="39"></td><td><pre>libtoolize: <span class="token string">'AC_PROG_RANLIB'</span> is rendered obsolete by <span class="token string">'LT_INIT'</span></pre></td></tr><tr><td data-num="40"></td><td><pre>autoreconf: running: /usr/bin/autoconf --force</pre></td></tr><tr><td data-num="41"></td><td><pre>autoreconf: running: /usr/bin/autoheader --force</pre></td></tr><tr><td data-num="42"></td><td><pre>autoreconf: running: automake --add-missing --copy --force-missing</pre></td></tr><tr><td data-num="43"></td><td><pre>configure.ac:29: installing <span class="token string">'config/compile'</span></pre></td></tr><tr><td data-num="44"></td><td><pre>configure.ac:36: installing <span class="token string">'config/config.guess'</span></pre></td></tr><tr><td data-num="45"></td><td><pre>configure.ac:36: installing <span class="token string">'config/config.sub'</span></pre></td></tr><tr><td data-num="46"></td><td><pre>configure.ac:16: installing <span class="token string">'config/install-sh'</span></pre></td></tr><tr><td data-num="47"></td><td><pre>configure.ac:16: installing <span class="token string">'config/missing'</span></pre></td></tr><tr><td data-num="48"></td><td><pre>src/Makefile.am: installing <span class="token string">'config/depcomp'</span></pre></td></tr><tr><td data-num="49"></td><td><pre>autoreconf: Leaving directory `.'</pre></td></tr></table></figure><p>如果执行 autoreconf -fvi 报错：autoconf（autoreconf 属于 autoconf）版本过低，此时需要更换一个仓库的 yum 源指向，因为使用 yum 安装的 rpm 是基于本 linux 系统版本的 rpm，要想安装新版本的 rpm，可以添加一个高版本的 yum 源即可。此时，可以添加一个高版本的 yum 源，推荐使用<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYWxpeXVuLmNvbS9taXJyb3IvZXBlbD9zcG09YTJjNmguMTM2NTExMDIuMC4wLjNlMjIxYjExUVNkN2JG">阿里云的镜像</span>。</p><p><img data-src="https://gitee.com/bfanfanfan/img/raw/master/docsify/image-20201230163638422.png" alt="image-20201230163638422"></p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#添加一个 yum 源</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@localhost twemproxy-master<span class="token punctuation">]</span><span class="token comment"># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></pre></td></tr><tr><td data-num="3"></td><td><pre>--2020-12-31 00:43:55--  http://mirrors.aliyun.com/repo/epel-6.repo</pre></td></tr><tr><td data-num="4"></td><td><pre>正在解析主机 mirrors.aliyun.com <span class="token punctuation">(</span>mirrors.aliyun.com<span class="token punctuation">)</span><span class="token punctuation">..</span>. <span class="token number">183.131</span>.210.249, <span class="token number">115.231</span>.40.111, <span class="token number">183.131</span>.210.240, <span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="5"></td><td><pre>正在连接 mirrors.aliyun.com <span class="token punctuation">(</span>mirrors.aliyun.com<span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">183.131</span>.210.249<span class="token operator">|</span>:80<span class="token punctuation">..</span>. 已连接。</pre></td></tr><tr><td data-num="6"></td><td><pre>已发出 HTTP 请求，正在等待回应<span class="token punctuation">..</span>. <span class="token number">200</span> OK</pre></td></tr><tr><td data-num="7"></td><td><pre>长度：664 <span class="token punctuation">[</span>application/octet-stream<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre>正在保存至: “/etc/yum.repos.d/epel.repo”</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>/etc/yum.repos.d/epel.repo              <span class="token number">100</span>%<span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span><span class="token punctuation">]</span>     <span class="token number">664</span>  --.-KB/s  用时 0s      </pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token number">2020</span>-12-31 00:43:55 <span class="token punctuation">(</span><span class="token number">28.9</span> MB/s<span class="token punctuation">)</span> - 已保存 “/etc/yum.repos.d/epel.repo” <span class="token punctuation">[</span><span class="token number">664</span>/664<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">#在 /etc/yum.repos.d/ 目录下多了一个 yum 源 epel.repo</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">[</span>root@localhost twemproxy-master<span class="token punctuation">]</span><span class="token comment"># cd /etc/yum.repos.d/</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>root@localhost yum.repos.d<span class="token punctuation">]</span><span class="token comment"># ll</span></pre></td></tr><tr><td data-num="17"></td><td><pre>总用量 <span class="token number">60</span></pre></td></tr><tr><td data-num="18"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">731</span> <span class="token number">8</span>月  <span class="token number">14</span> <span class="token number">2019</span> CentOS-AppStream.repo</pre></td></tr><tr><td data-num="19"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">712</span> <span class="token number">8</span>月  <span class="token number">14</span> <span class="token number">2019</span> CentOS-Base.repo</pre></td></tr><tr><td data-num="20"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">798</span> <span class="token number">8</span>月  <span class="token number">14</span> <span class="token number">2019</span> CentOS-centosplus.repo</pre></td></tr><tr><td data-num="21"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1320</span> <span class="token number">8</span>月  <span class="token number">14</span> <span class="token number">2019</span> CentOS-CR.repo</pre></td></tr><tr><td data-num="22"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">668</span> <span class="token number">8</span>月  <span class="token number">14</span> <span class="token number">2019</span> CentOS-Debuginfo.repo</pre></td></tr><tr><td data-num="23"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">756</span> <span class="token number">8</span>月  <span class="token number">14</span> <span class="token number">2019</span> CentOS-Extras.repo</pre></td></tr><tr><td data-num="24"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">338</span> <span class="token number">8</span>月  <span class="token number">14</span> <span class="token number">2019</span> CentOS-fasttrack.repo</pre></td></tr><tr><td data-num="25"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">928</span> <span class="token number">8</span>月  <span class="token number">14</span> <span class="token number">2019</span> CentOS-Media.repo</pre></td></tr><tr><td data-num="26"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">736</span> <span class="token number">8</span>月  <span class="token number">14</span> <span class="token number">2019</span> CentOS-PowerTools.repo</pre></td></tr><tr><td data-num="27"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1382</span> <span class="token number">8</span>月  <span class="token number">14</span> <span class="token number">2019</span> CentOS-Sources.repo</pre></td></tr><tr><td data-num="28"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root   <span class="token number">74</span> <span class="token number">8</span>月  <span class="token number">14</span> <span class="token number">2019</span> CentOS-Vault.repo</pre></td></tr><tr><td data-num="29"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">664</span> <span class="token number">5</span>月  <span class="token number">11</span> <span class="token number">2018</span> epel.repo</pre></td></tr><tr><td data-num="30"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">9154</span> <span class="token number">4</span>月  <span class="token number">27</span> <span class="token number">2020</span> pgdg-redhat-all.repo</pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment">#清空 yum 缓存</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">[</span>root@localhost twemproxy-master<span class="token punctuation">]</span><span class="token comment"># yum clean all</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token number">55</span> 文件已删除</pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment">#查询 autoconf 版本，此时会自动下载</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">[</span>root@localhost twemproxy-master<span class="token punctuation">]</span><span class="token comment"># yum search autoconf</span></pre></td></tr><tr><td data-num="37"></td><td><pre>CentOS-8 - AppStream                                                                                                         <span class="token number">190</span> kB/s <span class="token operator">|</span> <span class="token number">6.3</span> MB     00:33    </pre></td></tr><tr><td data-num="38"></td><td><pre>CentOS-8 - Base                                                                                                              <span class="token number">351</span> kB/s <span class="token operator">|</span> <span class="token number">2.3</span> MB     00:06    </pre></td></tr><tr><td data-num="39"></td><td><pre>CentOS-8 - Extras                                                                                                            <span class="token number">1.6</span> kB/s <span class="token operator">|</span> <span class="token number">8.6</span> kB     00:05   </pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> 名称 精准匹配：autoconf <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span></pre></td></tr><tr><td data-num="41"></td><td><pre>autoconf.noarch <span class="token builtin class-name">:</span> A GNU tool <span class="token keyword">for</span> automatically configuring <span class="token builtin class-name">source</span> code</pre></td></tr><tr><td data-num="42"></td><td><pre>autoconf.noarch <span class="token builtin class-name">:</span> A GNU tool <span class="token keyword">for</span> automatically configuring <span class="token builtin class-name">source</span> code</pre></td></tr><tr><td data-num="43"></td><td><pre> </pre></td></tr><tr><td data-num="44"></td><td><pre> <span class="token comment">#安装 autoconf，如果是 autoconf268.noarch，那么就执行 yum install autoconf268</span></pre></td></tr><tr><td data-num="45"></td><td><pre> <span class="token punctuation">[</span>root@localhost twemproxy-master<span class="token punctuation">]</span><span class="token comment"># yum install autoconf</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token comment">#此时再次执行，如果安装的是 autoconf268，那么就执行 autoconf268 -fvi</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token punctuation">[</span>root@localhost twemproxy-master<span class="token punctuation">]</span><span class="token comment"># autoreconf -fvi</span></pre></td></tr></table></figure><p>执行 autoreconf -fvi 后目录下多了一个 configure</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost twemproxy-master<span class="token punctuation">]</span><span class="token comment"># ll</span></pre></td></tr><tr><td data-num="2"></td><td><pre>总用量 <span class="token number">776</span></pre></td></tr><tr><td data-num="3"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">42036</span> <span class="token number">12</span>月 <span class="token number">31</span> 00:33 aclocal.m4</pre></td></tr><tr><td data-num="4"></td><td><pre>drwxr-xr-x. <span class="token number">2</span> root root    <span class="token number">118</span> <span class="token number">12</span>月 <span class="token number">31</span> 00:34 autom4te.cache</pre></td></tr><tr><td data-num="5"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root   <span class="token number">5709</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 ChangeLog</pre></td></tr><tr><td data-num="6"></td><td><pre>drwxr-xr-x. <span class="token number">2</span> root root     <span class="token number">82</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 conf</pre></td></tr><tr><td data-num="7"></td><td><pre>drwxr-xr-x. <span class="token number">2</span> root root    <span class="token number">124</span> <span class="token number">12</span>月 <span class="token number">31</span> 00:34 config</pre></td></tr><tr><td data-num="8"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root   <span class="token number">9486</span> <span class="token number">12</span>月 <span class="token number">31</span> 00:33 config.h.in</pre></td></tr><tr><td data-num="9"></td><td><pre>-rwxr-xr-x. <span class="token number">1</span> root root <span class="token number">630239</span> <span class="token number">12</span>月 <span class="token number">31</span> 00:33 configure</pre></td></tr><tr><td data-num="10"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root   <span class="token number">6082</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 configure.ac</pre></td></tr><tr><td data-num="11"></td><td><pre>drwxr-xr-x. <span class="token number">3</span> root root     <span class="token number">87</span> <span class="token number">12</span>月 <span class="token number">31</span> 00:34 contrib</pre></td></tr><tr><td data-num="12"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root    <span class="token number">188</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 Dockerfile</pre></td></tr><tr><td data-num="13"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">10173</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 LICENSE</pre></td></tr><tr><td data-num="14"></td><td><pre>drwxr-xr-x. <span class="token number">2</span> root root    <span class="token number">122</span> <span class="token number">12</span>月 <span class="token number">31</span> 00:33 m4</pre></td></tr><tr><td data-num="15"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root    <span class="token number">242</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 Makefile.am</pre></td></tr><tr><td data-num="16"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">29146</span> <span class="token number">12</span>月 <span class="token number">31</span> 00:34 Makefile.in</pre></td></tr><tr><td data-num="17"></td><td><pre>drwxr-xr-x. <span class="token number">2</span> root root     <span class="token number">26</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 <span class="token function">man</span></pre></td></tr><tr><td data-num="18"></td><td><pre>drwxr-xr-x. <span class="token number">2</span> root root    <span class="token number">143</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 notes</pre></td></tr><tr><td data-num="19"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root   <span class="token number">6308</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 NOTICE</pre></td></tr><tr><td data-num="20"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">16792</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 README.md</pre></td></tr><tr><td data-num="21"></td><td><pre>drwxr-xr-x. <span class="token number">2</span> root root    <span class="token number">270</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 scripts</pre></td></tr><tr><td data-num="22"></td><td><pre>drwxr-xr-x. <span class="token number">5</span> root root   <span class="token number">4096</span> <span class="token number">12</span>月 <span class="token number">31</span> 00:34 src</pre></td></tr><tr><td data-num="23"></td><td><pre>drwxr-xr-x. <span class="token number">9</span> root root    <span class="token number">151</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 tests</pre></td></tr><tr><td data-num="24"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root    <span class="token number">722</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 travis.sh</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost twemproxy-master<span class="token punctuation">]</span><span class="token comment"># ./configure </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#编译之后会在 src 目录下生成一个可执行文件 nutcracker</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@localhost twemproxy-master<span class="token punctuation">]</span><span class="token comment"># make</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@localhost twemproxy-master<span class="token punctuation">]</span><span class="token comment"># cd src/</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@localhost src<span class="token punctuation">]</span><span class="token comment"># ll</span></pre></td></tr><tr><td data-num="8"></td><td><pre>总用量 <span class="token number">2692</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="10"></td><td><pre>-rwxr-xr-x. <span class="token number">1</span> root root <span class="token number">1101776</span> <span class="token number">12</span>月 <span class="token number">31</span> 01:09 nutcracker</pre></td></tr><tr><td data-num="11"></td><td><pre>drwxr-xr-x. <span class="token number">3</span> root root     <span class="token number">187</span> <span class="token number">12</span>月 <span class="token number">31</span> 01:09 proto</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">#将 twemproxy 注册为服务</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">[</span>root@localhost src<span class="token punctuation">]</span><span class="token comment"># cd ..</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">[</span>root@localhost twemproxy-master<span class="token punctuation">]</span><span class="token comment"># cd scripts/</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span>root@localhost scripts<span class="token punctuation">]</span><span class="token comment"># ll</span></pre></td></tr><tr><td data-num="18"></td><td><pre>总用量 <span class="token number">100</span></pre></td></tr><tr><td data-num="19"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">1142</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 benchmark-mget.py</pre></td></tr><tr><td data-num="20"></td><td><pre>-rwxr-xr-x. <span class="token number">1</span> root root  <span class="token number">6476</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 makesrpm.sh</pre></td></tr><tr><td data-num="21"></td><td><pre>-rwxr-xr-x. <span class="token number">1</span> root root   <span class="token number">526</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 multi_get.sh</pre></td></tr><tr><td data-num="22"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">1467</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 nutcracker.init</pre></td></tr><tr><td data-num="23"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">1828</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 nutcracker.init.debian</pre></td></tr><tr><td data-num="24"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">5427</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 nutcracker.spec</pre></td></tr><tr><td data-num="25"></td><td><pre>-rwxr-xr-x. <span class="token number">1</span> root root   <span class="token number">496</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 pipelined_read.sh</pre></td></tr><tr><td data-num="26"></td><td><pre>-rwxr-xr-x. <span class="token number">1</span> root root   <span class="token number">639</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 pipelined_write.sh</pre></td></tr><tr><td data-num="27"></td><td><pre>-rwxr-xr-x. <span class="token number">1</span> root root   <span class="token number">495</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 populate_memcached.sh</pre></td></tr><tr><td data-num="28"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root   <span class="token number">665</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 redis-check.py</pre></td></tr><tr><td data-num="29"></td><td><pre>-rwxr-xr-x. <span class="token number">1</span> root root <span class="token number">52914</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 redis-check.sh</pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">[</span>root@localhost scripts<span class="token punctuation">]</span><span class="token comment"># cp nutcracker.init /etc/init.d/twemproxy</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">[</span>root@localhost scripts<span class="token punctuation">]</span><span class="token comment"># cd /etc/init.d/</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">[</span>root@localhost init.d<span class="token punctuation">]</span><span class="token comment"># ls</span></pre></td></tr><tr><td data-num="33"></td><td><pre>functions  mysql  README  redis_6379  redis_6380  redis_6381  twemproxy</pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment">#赋予服务 twemproxy 可执行权限</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">[</span>root@localhost init.d<span class="token punctuation">]</span><span class="token comment"># chmod +x twemproxy </span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">[</span>root@localhost init.d<span class="token punctuation">]</span><span class="token comment"># ls</span></pre></td></tr><tr><td data-num="37"></td><td><pre>functions  mysql  README  redis_6379  redis_6380  redis_6381  twemproxy</pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment">#创建一个目录，将 twemproxy 解压目录下的 config 文件夹中的配置文件拷贝到新创建的目录下（nutcracker.init 文件中的 OPTIONS 属性指定的目录，也可以修改该属性的值指向 config 文件夹中的配置）</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">[</span>root@localhost init.d<span class="token punctuation">]</span><span class="token comment"># mkdir /etc/nutcracker</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">[</span>root@localhost init.d<span class="token punctuation">]</span><span class="token comment"># cd </span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cd twemproxy-master/</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">[</span>root@localhost twemproxy-master<span class="token punctuation">]</span><span class="token comment"># cd conf</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">[</span>root@localhost conf<span class="token punctuation">]</span><span class="token comment"># ll</span></pre></td></tr><tr><td data-num="46"></td><td><pre>总用量 <span class="token number">12</span></pre></td></tr><tr><td data-num="47"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">209</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 nutcracker.leaf.yml</pre></td></tr><tr><td data-num="48"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">151</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 nutcracker.root.yml</pre></td></tr><tr><td data-num="49"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1301</span> <span class="token number">11</span>月  <span class="token number">6</span> 04:22 nutcracker.yml</pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">[</span>root@localhost conf<span class="token punctuation">]</span><span class="token comment"># cp ./* /etc/nutcracker/</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token comment">#将可执行程序 nutcracker 拷贝到 /usr/bin 目录，使得在任何位置都能执行该程序（nutcracker.init 文件中的 prog 属性，默认执行 /usr/bin 目录下的 nutcracker，也可以自行修改）</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">[</span>root@localhost conf<span class="token punctuation">]</span><span class="token comment"># cd ..</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token punctuation">[</span>root@localhost twemproxy-master<span class="token punctuation">]</span><span class="token comment"># cd src/</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token punctuation">[</span>root@localhost src<span class="token punctuation">]</span><span class="token comment"># cp nutcracker /usr/bin/</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token comment">#修改 nutcracker.yml 配置，准备开始使用</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token punctuation">[</span>root@localhost src<span class="token punctuation">]</span><span class="token comment"># cd /etc/nutcracker/</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">[</span>root@localhost nutcracker<span class="token punctuation">]</span><span class="token comment"># ll</span></pre></td></tr><tr><td data-num="60"></td><td><pre>总用量 <span class="token number">12</span></pre></td></tr><tr><td data-num="61"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">209</span> <span class="token number">12</span>月 <span class="token number">31</span> 01:23 nutcracker.leaf.yml</pre></td></tr><tr><td data-num="62"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">151</span> <span class="token number">12</span>月 <span class="token number">31</span> 01:23 nutcracker.root.yml</pre></td></tr><tr><td data-num="63"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1301</span> <span class="token number">12</span>月 <span class="token number">31</span> 01:23 nutcracker.yml</pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token comment">#保险起见，备份要修改的文件</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">[</span>root@localhost nutcracker<span class="token punctuation">]</span><span class="token comment"># cp nutcracker.yml nutcracker.yml.bak</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token punctuation">[</span>root@localhost nutcracker<span class="token punctuation">]</span><span class="token comment"># ll</span></pre></td></tr><tr><td data-num="67"></td><td><pre>总用量 <span class="token number">16</span></pre></td></tr><tr><td data-num="68"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">209</span> <span class="token number">12</span>月 <span class="token number">31</span> 01:23 nutcracker.leaf.yml</pre></td></tr><tr><td data-num="69"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">151</span> <span class="token number">12</span>月 <span class="token number">31</span> 01:23 nutcracker.root.yml</pre></td></tr><tr><td data-num="70"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1301</span> <span class="token number">12</span>月 <span class="token number">31</span> 01:23 nutcracker.yml</pre></td></tr><tr><td data-num="71"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1301</span> <span class="token number">12</span>月 <span class="token number">31</span> 01:30 nutcracker.yml.bak</pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token punctuation">[</span>root@localhost nutcracker<span class="token punctuation">]</span><span class="token comment"># vim nutcracker.yml</span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre>alpha:  <span class="token comment">#希腊字母表第一个字母</span></pre></td></tr><tr><td data-num="75"></td><td><pre>  listen: <span class="token number">127.0</span>.0.1:22121 <span class="token comment">#设置代理地址，供被代理的 redis 实例连接</span></pre></td></tr><tr><td data-num="76"></td><td><pre>  hash: fnv1a_64 <span class="token comment">#对 key 进行 fnv1a_64 哈希算法</span></pre></td></tr><tr><td data-num="77"></td><td><pre>  distribution: ketama <span class="token comment">#对 key 的分布进行哈希一致性算法 ketama 后分布到不同的 redis 实例中</span></pre></td></tr><tr><td data-num="78"></td><td><pre>  auto_eject_hosts: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="79"></td><td><pre>  redis: <span class="token boolean">true</span> <span class="token comment">#可以代理 redis 或者 memcached</span></pre></td></tr><tr><td data-num="80"></td><td><pre>  server_retry_timeout: <span class="token number">2000</span></pre></td></tr><tr><td data-num="81"></td><td><pre>  server_failure_limit: <span class="token number">1</span></pre></td></tr><tr><td data-num="82"></td><td><pre>  servers: <span class="token comment">#要代理的 redis 实例的地址和端口</span></pre></td></tr><tr><td data-num="83"></td><td><pre>   - <span class="token number">127.0</span>.0.1:6379:1 <span class="token comment">#ip: 端口：权重</span></pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre>beta:</pre></td></tr><tr><td data-num="86"></td><td><pre>  listen: <span class="token number">127.0</span>.0.1:22122</pre></td></tr><tr><td data-num="87"></td><td><pre>  hash: fnv1a_64</pre></td></tr><tr><td data-num="88"></td><td><pre>  hash_tag: <span class="token string">"&#123;&#125;"</span></pre></td></tr><tr><td data-num="89"></td><td><pre>  distribution: ketama</pre></td></tr><tr><td data-num="90"></td><td><pre>  auto_eject_hosts: <span class="token boolean">false</span></pre></td></tr><tr><td data-num="91"></td><td><pre>  timeout: <span class="token number">400</span></pre></td></tr><tr><td data-num="92"></td><td><pre>  redis: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="93"></td><td><pre>  servers:</pre></td></tr><tr><td data-num="94"></td><td><pre>   - <span class="token number">127.0</span>.0.1:6380:1 server1</pre></td></tr><tr><td data-num="95"></td><td><pre>   - <span class="token number">127.0</span>.0.1:6381:1 server2</pre></td></tr><tr><td data-num="96"></td><td><pre>   - <span class="token number">127.0</span>.0.1:6382:1 server3</pre></td></tr><tr><td data-num="97"></td><td><pre>   - <span class="token number">127.0</span>.0.1:6383:1 server4</pre></td></tr><tr><td data-num="98"></td><td><pre></pre></td></tr><tr><td data-num="99"></td><td><pre>gamma:</pre></td></tr><tr><td data-num="100"></td><td><pre>  listen: <span class="token number">127.0</span>.0.1:22123</pre></td></tr><tr><td data-num="101"></td><td><pre>  hash: fnv1a_64</pre></td></tr><tr><td data-num="102"></td><td><pre>  distribution: ketama</pre></td></tr><tr><td data-num="103"></td><td><pre>  timeout: <span class="token number">400</span></pre></td></tr><tr><td data-num="104"></td><td><pre> backlog: <span class="token number">1024</span></pre></td></tr><tr><td data-num="105"></td><td><pre>  preconnect: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="106"></td><td><pre>  auto_eject_hosts: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="107"></td><td><pre>  server_retry_timeout: <span class="token number">2000</span></pre></td></tr><tr><td data-num="108"></td><td><pre>  server_failure_limit: <span class="token number">3</span></pre></td></tr><tr><td data-num="109"></td><td><pre>  servers:</pre></td></tr><tr><td data-num="110"></td><td><pre>   - <span class="token number">127.0</span>.0.1:11212:1</pre></td></tr><tr><td data-num="111"></td><td><pre>   - <span class="token number">127.0</span>.0.1:11213:1</pre></td></tr><tr><td data-num="112"></td><td><pre></pre></td></tr><tr><td data-num="113"></td><td><pre>delta:</pre></td></tr><tr><td data-num="114"></td><td><pre>  listen: <span class="token number">127.0</span>.0.1:22124</pre></td></tr><tr><td data-num="115"></td><td><pre>  hash: fnv1a_64</pre></td></tr><tr><td data-num="116"></td><td><pre>  distribution: ketama</pre></td></tr><tr><td data-num="117"></td><td><pre>  timeout: <span class="token number">100</span></pre></td></tr><tr><td data-num="118"></td><td><pre>  auto_eject_hosts: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="119"></td><td><pre>  server_retry_timeout: <span class="token number">2000</span></pre></td></tr><tr><td data-num="120"></td><td><pre>  server_failure_limit: <span class="token number">1</span></pre></td></tr><tr><td data-num="121"></td><td><pre>  servers:</pre></td></tr><tr><td data-num="122"></td><td><pre> - <span class="token number">127.0</span>.0.1:11214:1</pre></td></tr><tr><td data-num="123"></td><td><pre>   - <span class="token number">127.0</span>.0.1:11215:1</pre></td></tr><tr><td data-num="124"></td><td><pre>   - <span class="token number">127.0</span>.0.1:11216:1</pre></td></tr><tr><td data-num="125"></td><td><pre>   - <span class="token number">127.0</span>.0.1:11217:1</pre></td></tr><tr><td data-num="126"></td><td><pre>   - <span class="token number">127.0</span>.0.1:11218:1</pre></td></tr><tr><td data-num="127"></td><td><pre>   - <span class="token number">127.0</span>.0.1:11219:1</pre></td></tr><tr><td data-num="128"></td><td><pre>   - <span class="token number">127.0</span>.0.1:11220:1</pre></td></tr><tr><td data-num="129"></td><td><pre>   - <span class="token number">127.0</span>.0.1:11221:1</pre></td></tr><tr><td data-num="130"></td><td><pre>   - <span class="token number">127.0</span>.0.1:11222:1</pre></td></tr><tr><td data-num="131"></td><td><pre>   - <span class="token number">127.0</span>.0.1:11223:1</pre></td></tr><tr><td data-num="132"></td><td><pre></pre></td></tr><tr><td data-num="133"></td><td><pre>omega:</pre></td></tr><tr><td data-num="134"></td><td><pre>  listen: /tmp/gamma</pre></td></tr><tr><td data-num="135"></td><td><pre>  hash: hsieh</pre></td></tr><tr><td data-num="136"></td><td><pre>  distribution: ketama</pre></td></tr><tr><td data-num="137"></td><td><pre>  auto_eject_hosts: <span class="token boolean">false</span></pre></td></tr><tr><td data-num="138"></td><td><pre>  servers:</pre></td></tr><tr><td data-num="139"></td><td><pre>   - <span class="token number">127.0</span>.0.1:11214:100000</pre></td></tr><tr><td data-num="140"></td><td><pre>   - <span class="token number">127.0</span>.0.1:11215:1</pre></td></tr><tr><td data-num="141"></td><td><pre></pre></td></tr><tr><td data-num="142"></td><td><pre><span class="token comment">#我们要演示的是只监听一个客户端并代理多个 redis，所以，只需要 alpha 就行，其他都删除</span></pre></td></tr><tr><td data-num="143"></td><td><pre><span class="token punctuation">[</span>root@localhost nutcracker<span class="token punctuation">]</span><span class="token comment"># vim nutcracker.yml</span></pre></td></tr><tr><td data-num="144"></td><td><pre></pre></td></tr><tr><td data-num="145"></td><td><pre>alpha:</pre></td></tr><tr><td data-num="146"></td><td><pre>  listen: <span class="token number">127.0</span>.0.1:22121</pre></td></tr><tr><td data-num="147"></td><td><pre>  hash: fnv1a_64</pre></td></tr><tr><td data-num="148"></td><td><pre>  distribution: ketama</pre></td></tr><tr><td data-num="149"></td><td><pre>  auto_eject_hosts: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="150"></td><td><pre>  redis: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="151"></td><td><pre>  server_retry_timeout: <span class="token number">2000</span></pre></td></tr><tr><td data-num="152"></td><td><pre>  server_failure_limit: <span class="token number">1</span></pre></td></tr><tr><td data-num="153"></td><td><pre>  servers: <span class="token comment">#这里代理两个 redis 实例</span></pre></td></tr><tr><td data-num="154"></td><td><pre>   - <span class="token number">127.0</span>.0.1:6379:1</pre></td></tr><tr><td data-num="155"></td><td><pre>   - <span class="token number">127.0</span>.0.1:6380:1</pre></td></tr><tr><td data-num="156"></td><td><pre>:wq<span class="token operator">!</span> <span class="token comment">#保存回车退出</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost nutcracker<span class="token punctuation">]</span><span class="token comment"># cd </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># mkdir data</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cd data/</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">#新建文件夹用于存放 redis 实例的数据</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>root@localhost data<span class="token punctuation">]</span><span class="token comment"># mkdir 6379</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@localhost data<span class="token punctuation">]</span><span class="token comment"># mkdir 6380</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>root@localhost data<span class="token punctuation">]</span><span class="token comment"># ll</span></pre></td></tr><tr><td data-num="8"></td><td><pre>总用量 <span class="token number">0</span></pre></td></tr><tr><td data-num="9"></td><td><pre>drwxr-xr-x. <span class="token number">2</span> root root <span class="token number">6</span> <span class="token number">12</span>月 <span class="token number">31</span> 02:29 <span class="token number">6379</span></pre></td></tr><tr><td data-num="10"></td><td><pre>drwxr-xr-x. <span class="token number">2</span> root root <span class="token number">6</span> <span class="token number">12</span>月 <span class="token number">31</span> 02:29 <span class="token number">6380</span></pre></td></tr></table></figure><p>窗口一：启动 6379redis 实例</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#启动 6379redis 实例，执行 redis-server 命令，会将 redis 数据存放在当前目录下</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@localhost data<span class="token punctuation">]</span><span class="token comment"># cd 6379/</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@localhost <span class="token number">6379</span><span class="token punctuation">]</span><span class="token comment"># redis-server --port 6379</span></pre></td></tr></table></figure><p>窗口二：启动 6380redis 实例</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cd data/6380/</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@localhost <span class="token number">6380</span><span class="token punctuation">]</span><span class="token comment"># redis-server --port 6380</span></pre></td></tr></table></figure><p>窗口三：启动 twemproxy 服务</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># service twemproxy start</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Reloading systemd:                                         <span class="token punctuation">[</span>  OK  <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre>Starting twemproxy <span class="token punctuation">(</span>via systemctl<span class="token punctuation">)</span>:                        <span class="token punctuation">[</span>  OK  <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#连接代理 twemproxy，并设置一些值</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -p 22121</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">127.0</span>.0.1:2212<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token builtin class-name">set</span> k1 hello</pre></td></tr><tr><td data-num="8"></td><td><pre>OK</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">127.0</span>.0.1:2212<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token builtin class-name">set</span> k2 aaa</pre></td></tr><tr><td data-num="10"></td><td><pre>OK</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">127.0</span>.0.1:2212<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token builtin class-name">set</span> k3 hhh</pre></td></tr><tr><td data-num="12"></td><td><pre>OK</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">#以上的值被分区到各个 redis 实例，且在当前客户端无法看到。此外，由于数据被随机分区到各个 redis 实例中，所以也不支持事务</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token number">127.0</span>.0.1:2212<span class="token operator"><span class="token file-descriptor important">1</span>></span> keys *</pre></td></tr><tr><td data-num="15"></td><td><pre>Error: Server closed the connection</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token number">127.0</span>.0.1:2212<span class="token operator"><span class="token file-descriptor important">1</span>></span> WATCH k1</pre></td></tr><tr><td data-num="17"></td><td><pre>Error: Server closed the connection</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token number">127.0</span>.0.1:2212<span class="token operator"><span class="token file-descriptor important">1</span>></span> MULTI</pre></td></tr><tr><td data-num="19"></td><td><pre>Error: Server closed the connection</pre></td></tr></table></figure><p>窗口四：连接 redsi 实例 6379，看是否有代理传输的数据</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -p 6379</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> keys *</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">(</span>empty array<span class="token punctuation">)</span></pre></td></tr></table></figure><p>窗口五：连接 redis 实例 6380，看是否有代理传输的数据。可以看到数据都被分区到了 6380 实例</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -p 6380</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">0</span>></span> keys *</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"k2"</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"k3"</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"k1"</span></pre></td></tr></table></figure><h4 id="predixy"><a class="anchor" href="#predixy">#</a> predixy</h4><p>在演示一下 predixy 的使用：</p><p>直接下载编译好的压缩包解压：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2pveWllbGRJbmMvcHJlZGl4eS9yZWxlYXNlcw==">下载地址</span></p><p>开发者提供了<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2pveWllbGRJbmMvcHJlZGl4eS9ibG9iL21hc3Rlci9kb2MvY29uZmlnX0NOLm1k">中文文档</span></p><p>predixy 支持 Redis Sentinel 和 Redis Cluster 来使用 redis，一个配置里这两种形式只能出现一种。这里演示哨兵 sentinel：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost conf<span class="token punctuation">]</span><span class="token comment"># pwd</span></pre></td></tr><tr><td data-num="2"></td><td><pre>/root/predixy-1.0.5/conf</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@localhost conf<span class="token punctuation">]</span><span class="token comment"># ll</span></pre></td></tr><tr><td data-num="4"></td><td><pre>总用量 <span class="token number">36</span></pre></td></tr><tr><td data-num="5"></td><td><pre>-rw-rw-r--. <span class="token number">1</span> <span class="token number">501</span> <span class="token number">501</span> <span class="token number">2395</span> <span class="token number">10</span>月 <span class="token number">20</span> <span class="token number">2018</span> auth.conf</pre></td></tr><tr><td data-num="6"></td><td><pre>-rw-rw-r--. <span class="token number">1</span> <span class="token number">501</span> <span class="token number">501</span> <span class="token number">1041</span> <span class="token number">10</span>月 <span class="token number">20</span> <span class="token number">2018</span> cluster.conf</pre></td></tr><tr><td data-num="7"></td><td><pre>-rw-rw-r--. <span class="token number">1</span> <span class="token number">501</span> <span class="token number">501</span> <span class="token number">3426</span> <span class="token number">10</span>月 <span class="token number">20</span> <span class="token number">2018</span> command.conf</pre></td></tr><tr><td data-num="8"></td><td><pre>-rw-rw-r--. <span class="token number">1</span> <span class="token number">501</span> <span class="token number">501</span>  <span class="token number">781</span> <span class="token number">10</span>月 <span class="token number">20</span> <span class="token number">2018</span> dc.conf</pre></td></tr><tr><td data-num="9"></td><td><pre>-rw-rw-r--. <span class="token number">1</span> <span class="token number">501</span> <span class="token number">501</span> <span class="token number">2121</span> <span class="token number">10</span>月 <span class="token number">20</span> <span class="token number">2018</span> latency.conf</pre></td></tr><tr><td data-num="10"></td><td><pre>-rw-rw-r--. <span class="token number">1</span> <span class="token number">501</span> <span class="token number">501</span> <span class="token number">2547</span> <span class="token number">10</span>月 <span class="token number">20</span> <span class="token number">2018</span> predixy.conf</pre></td></tr><tr><td data-num="11"></td><td><pre>-rw-rw-r--. <span class="token number">1</span> <span class="token number">501</span> <span class="token number">501</span> <span class="token number">1421</span> <span class="token number">10</span>月 <span class="token number">20</span> <span class="token number">2018</span> sentinel.conf</pre></td></tr><tr><td data-num="12"></td><td><pre>-rw-rw-r--. <span class="token number">1</span> <span class="token number">501</span> <span class="token number">501</span> <span class="token number">2016</span> <span class="token number">10</span>月 <span class="token number">20</span> <span class="token number">2018</span> standalone.conf</pre></td></tr><tr><td data-num="13"></td><td><pre>-rw-rw-r--. <span class="token number">1</span> <span class="token number">501</span> <span class="token number">501</span>   <span class="token number">98</span> <span class="token number">10</span>月 <span class="token number">20</span> <span class="token number">2018</span> try.conf</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">#修改 predixy 的配置</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">[</span>root@localhost conf<span class="token punctuation">]</span><span class="token comment"># vim predixy.conf </span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="17"></td><td><pre> Bind <span class="token number">127.0</span>.0.1:7617  <span class="token comment">#第 10 行设置 prefix 代理的地址</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># Include cluster.conf</span></pre></td></tr><tr><td data-num="20"></td><td><pre> Include sentinel.conf <span class="token comment">#第 84 行使用哨兵模式</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">#Include try.conf</span></pre></td></tr><tr><td data-num="22"></td><td><pre>:wq<span class="token operator">!</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">#修改哨兵的配置</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">[</span>root@localhost conf<span class="token punctuation">]</span><span class="token comment"># vim sentinel.conf </span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">#光标定位到 29 行，复制一份给出的例子，直接修改该例子即可。</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment">#复制方式：光标定位到要开始复制的第 29 行，Shift+: . , $y 回车，代表从光标开始复制到最后一行</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>:.,<span class="token variable">$y</span> <span class="token comment">#回车，然后按大写 G 键让光标移动到最后一行，然后按 p 键粘贴刚才复制的内容。粘贴完后光标应该在 52 行，此时，Shift+: . , $s/#// 回车，代表将当前行到最后一行中所有的 #替换为空</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>:.,<span class="token variable">$s</span>/<span class="token comment">#//  #回车     </span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment"># 修改 Sentinels 属性的内容，这里将以三个哨兵为例。Group 后面的 shard001 和 shard002 代表要监控的 redis 实例主机的名字，也就是说两个 group 代表 sentinel 同时可以监控两套 redis 主从机</span></pre></td></tr><tr><td data-num="35"></td><td><pre>SentinelServerPool <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    Databases <span class="token number">16</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    Hash crc16</pre></td></tr><tr><td data-num="38"></td><td><pre>    HashTag <span class="token string">"&#123;&#125;"</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    Distribution modula</pre></td></tr><tr><td data-num="40"></td><td><pre>    MasterReadPriority <span class="token number">60</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    StaticSlaveReadPriority <span class="token number">50</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    DynamicSlaveReadPriority <span class="token number">50</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    RefreshInterval <span class="token number">1</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    ServerTimeout <span class="token number">1</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    ServerFailureLimit <span class="token number">10</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    ServerRetryTimeout <span class="token number">1</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    KeepAlive <span class="token number">120</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    Sentinels <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        + <span class="token number">127.0</span>.0.1:26379</pre></td></tr><tr><td data-num="50"></td><td><pre>        + <span class="token number">127.0</span>.0.1:26380</pre></td></tr><tr><td data-num="51"></td><td><pre>        + <span class="token number">127.0</span>.0.1:26381</pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    Group shard001 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    Group shard002 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>:wq<span class="token operator">!</span></pre></td></tr></table></figure><p>创建哨兵，这里在之前创建的哨兵上修改</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cd test/</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># ll</span></pre></td></tr><tr><td data-num="3"></td><td><pre>总用量 <span class="token number">264</span></pre></td></tr><tr><td data-num="4"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root   <span class="token number">606</span> <span class="token number">12</span>月 <span class="token number">29</span> <span class="token number">19</span>:12 <span class="token number">26379</span>.conf</pre></td></tr><tr><td data-num="5"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root   <span class="token number">606</span> <span class="token number">12</span>月 <span class="token number">29</span> <span class="token number">19</span>:12 <span class="token number">26380</span>.conf</pre></td></tr><tr><td data-num="6"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root   <span class="token number">606</span> <span class="token number">12</span>月 <span class="token number">29</span> <span class="token number">19</span>:12 <span class="token number">26381</span>.conf</pre></td></tr><tr><td data-num="7"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">83468</span> <span class="token number">12</span>月 <span class="token number">29</span> <span class="token number">17</span>:53 <span class="token number">6379</span>.conf</pre></td></tr><tr><td data-num="8"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">83525</span> <span class="token number">12</span>月 <span class="token number">29</span> <span class="token number">19</span>:12 <span class="token number">6380</span>.conf</pre></td></tr><tr><td data-num="9"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">83550</span> <span class="token number">12</span>月 <span class="token number">29</span> <span class="token number">19</span>:12 <span class="token number">6381</span>.conf</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># vim 26379.conf </span></pre></td></tr><tr><td data-num="11"></td><td><pre>port <span class="token number">26379</span></pre></td></tr><tr><td data-num="12"></td><td><pre>sentinel monitor shard001 <span class="token number">127.0</span>.0.1 <span class="token number">36379</span> <span class="token number">2</span> <span class="token comment">#26379 的哨兵将监控 master 主机名称为 shard001 且主机 IP 以及端口为 127.0.0.1:36379 的 redis 实例</span></pre></td></tr><tr><td data-num="13"></td><td><pre>sentinel monitor shard002 <span class="token number">127.0</span>.0.1 <span class="token number">46379</span> <span class="token number">2</span> <span class="token comment">#26379 的哨兵将监控 master 主机名称为 shard002 且主机 IP 以及端口为 127.0.0.1:46379 的 redis 实例</span></pre></td></tr><tr><td data-num="14"></td><td><pre>~                                                    </pre></td></tr><tr><td data-num="15"></td><td><pre>:wq<span class="token operator">!</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">#26380 以及 26381 的哨兵同理</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># vim 26380.conf </span></pre></td></tr><tr><td data-num="19"></td><td><pre>port <span class="token number">26380</span></pre></td></tr><tr><td data-num="20"></td><td><pre>sentinel monitor shard001 <span class="token number">127.0</span>.0.1 <span class="token number">36379</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="21"></td><td><pre>sentinel monitor shard002 <span class="token number">127.0</span>.0.1 <span class="token number">46379</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="22"></td><td><pre>~                                                                                                                                                            </pre></td></tr><tr><td data-num="23"></td><td><pre>~    </pre></td></tr><tr><td data-num="24"></td><td><pre>:wq<span class="token operator">!</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># vim 26381.conf </span></pre></td></tr><tr><td data-num="27"></td><td><pre>port <span class="token number">26381</span></pre></td></tr><tr><td data-num="28"></td><td><pre>sentinel monitor shard001 <span class="token number">127.0</span>.0.1 <span class="token number">36379</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="29"></td><td><pre>sentinel monitor shard002 <span class="token number">127.0</span>.0.1 <span class="token number">46379</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="30"></td><td><pre>:wq<span class="token operator">!</span></pre></td></tr></table></figure><p>窗口一：启动哨兵 26379</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># redis-server ./26379.conf --sentinel</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">5293</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:09:13.956 <span class="token comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">5293</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:09:13.956 <span class="token comment"># Redis version=6.0.6, bits=64, commit=00000000, modified=0, pid=5293, just started</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">5293</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:09:13.956 <span class="token comment"># Configuration loaded</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">5293</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:09:13.956 * Increased maximum number of <span class="token function">open</span> files to <span class="token number">10032</span> <span class="token punctuation">(</span>it was originally <span class="token builtin class-name">set</span> to <span class="token number">1024</span><span class="token punctuation">)</span>.</pre></td></tr><tr><td data-num="6"></td><td><pre>                _._                                                  </pre></td></tr><tr><td data-num="7"></td><td><pre>           _.-`<span class="token variable"><span class="token variable">`</span>__ <span class="token string">''</span>-._                                             </span></pre></td></tr><tr><td data-num="8"></td><td><pre>      _.-<span class="token variable">`</span><span class="token variable"><span class="token variable">`</span>    <span class="token variable">`</span></span><span class="token builtin class-name">.</span>  <span class="token variable"><span class="token variable">`</span>_.  <span class="token string">''</span>-._           Redis <span class="token number">6.0</span>.6 <span class="token punctuation">(</span>00000000/0<span class="token punctuation">)</span> <span class="token number">64</span> bit</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  .-<span class="token variable">`</span><span class="token variable"><span class="token variable">`</span> .-<span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>  <span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token punctuation">\</span>/    _.,_ <span class="token string">''</span>-._                                   </span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">(</span>    '      ,       .-<span class="token variable">`</span>  <span class="token operator">|</span> <span class="token variable"><span class="token variable">`</span>,    <span class="token punctuation">)</span>     Running <span class="token keyword">in</span> sentinel mode</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token operator">|</span><span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-<span class="token punctuation">..</span>.-<span class="token variable">`</span></span> __<span class="token punctuation">..</span>.-.`<span class="token variable"><span class="token variable">`</span>-._<span class="token operator">|</span>'<span class="token variable">`</span></span> _.-<span class="token string">'|     Port: 26379</span></pre></td></tr><tr><td data-num="12"></td><td><pre> |    `-._   `._    /     _.-'    <span class="token operator">|</span>     PID: <span class="token number">5293</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-._  <span class="token variable"><span class="token variable">`</span>-./  _.-<span class="token string">'    _.-'</span>                                   </span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token operator">|</span><span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-.__.-<span class="token string">'    _.-'</span>_.-<span class="token string">'|                                  </span></pre></td></tr><tr><td data-num="15"></td><td><pre> |    `-._`-._        _.-'_.-<span class="token string">'    |           http://redis.io        </span></pre></td></tr><tr><td data-num="16"></td><td><pre>  `-._    `-._`-.__.-'_.-<span class="token string">'    _.-'</span>                                   </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token operator">|</span><span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-._    <span class="token variable"><span class="token variable">`</span>-.__.-<span class="token string">'    _.-'</span>_.-'<span class="token operator">|</span>                                  </span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token operator">|</span>    <span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-._        _.-<span class="token string">'_.-'</span>    <span class="token operator">|</span>                                  </span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token variable">`</span>-._    <span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-.__.-<span class="token string">'_.-'</span>    _.-<span class="token string">'                                   </span></pre></td></tr><tr><td data-num="20"></td><td><pre>      `-._    `-.__.-'    _.-<span class="token string">'                                       </span></pre></td></tr><tr><td data-num="21"></td><td><pre>          `-._        _.-'                                           </pre></td></tr><tr><td data-num="22"></td><td><pre>              `-.__.-'                                               </pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token number">5293</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:09:14.009 <span class="token comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token number">5293</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:09:14.011 <span class="token comment"># Sentinel ID is b6d21fe37d6597b323244d42db7932a890b4e772</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token number">5293</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:09:14.011 <span class="token comment"># +monitor master shard001 127.0.0.1 36379 quorum 2</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token number">5293</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:09:14.011 <span class="token comment"># +monitor master shard002 127.0.0.1 46379 quorum 2</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token number">5293</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:09:44.033 <span class="token comment"># +sdown master shard001 127.0.0.1 36379</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token number">5293</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:09:44.033 <span class="token comment"># +sdown master shard002 127.0.0.1 46379</span></pre></td></tr></table></figure><p>窗口二：启动哨兵 26380</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># redis-server ./26380.conf --sentinel</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">5355</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:11:15.834 <span class="token comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">5355</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:11:15.834 <span class="token comment"># Redis version=6.0.6, bits=64, commit=00000000, modified=0, pid=5355, just started</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">5355</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:11:15.834 <span class="token comment"># Configuration loaded</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">5355</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:11:15.834 * Increased maximum number of <span class="token function">open</span> files to <span class="token number">10032</span> <span class="token punctuation">(</span>it was originally <span class="token builtin class-name">set</span> to <span class="token number">1024</span><span class="token punctuation">)</span>.</pre></td></tr><tr><td data-num="6"></td><td><pre>                _._                                                  </pre></td></tr><tr><td data-num="7"></td><td><pre>           _.-`<span class="token variable"><span class="token variable">`</span>__ <span class="token string">''</span>-._                                             </span></pre></td></tr><tr><td data-num="8"></td><td><pre>      _.-<span class="token variable">`</span><span class="token variable"><span class="token variable">`</span>    <span class="token variable">`</span></span><span class="token builtin class-name">.</span>  <span class="token variable"><span class="token variable">`</span>_.  <span class="token string">''</span>-._           Redis <span class="token number">6.0</span>.6 <span class="token punctuation">(</span>00000000/0<span class="token punctuation">)</span> <span class="token number">64</span> bit</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  .-<span class="token variable">`</span><span class="token variable"><span class="token variable">`</span> .-<span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>  <span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token punctuation">\</span>/    _.,_ <span class="token string">''</span>-._                                   </span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">(</span>    '      ,       .-<span class="token variable">`</span>  <span class="token operator">|</span> <span class="token variable"><span class="token variable">`</span>,    <span class="token punctuation">)</span>     Running <span class="token keyword">in</span> sentinel mode</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token operator">|</span><span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-<span class="token punctuation">..</span>.-<span class="token variable">`</span></span> __<span class="token punctuation">..</span>.-.`<span class="token variable"><span class="token variable">`</span>-._<span class="token operator">|</span>'<span class="token variable">`</span></span> _.-<span class="token string">'|     Port: 26380</span></pre></td></tr><tr><td data-num="12"></td><td><pre> |    `-._   `._    /     _.-'    <span class="token operator">|</span>     PID: <span class="token number">5355</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-._  <span class="token variable"><span class="token variable">`</span>-./  _.-<span class="token string">'    _.-'</span>                                   </span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token operator">|</span><span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-.__.-<span class="token string">'    _.-'</span>_.-<span class="token string">'|                                  </span></pre></td></tr><tr><td data-num="15"></td><td><pre> |    `-._`-._        _.-'_.-<span class="token string">'    |           http://redis.io        </span></pre></td></tr><tr><td data-num="16"></td><td><pre>  `-._    `-._`-.__.-'_.-<span class="token string">'    _.-'</span>                                   </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token operator">|</span><span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-._    <span class="token variable"><span class="token variable">`</span>-.__.-<span class="token string">'    _.-'</span>_.-'<span class="token operator">|</span>                                  </span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token operator">|</span>    <span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-._        _.-<span class="token string">'_.-'</span>    <span class="token operator">|</span>                                  </span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token variable">`</span>-._    <span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-.__.-<span class="token string">'_.-'</span>    _.-<span class="token string">'                                   </span></pre></td></tr><tr><td data-num="20"></td><td><pre>      `-._    `-.__.-'    _.-<span class="token string">'                                       </span></pre></td></tr><tr><td data-num="21"></td><td><pre>          `-._        _.-'                                           </pre></td></tr><tr><td data-num="22"></td><td><pre>              `-.__.-'                                               </pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token number">5355</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:11:15.876 <span class="token comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token number">5355</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:11:15.879 <span class="token comment"># Sentinel ID is 0385e1f81c98a8c43bae85a73cf71d18703050aa</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token number">5355</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:11:15.879 <span class="token comment"># +monitor master shard002 127.0.0.1 46379 quorum 2</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token number">5355</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:11:15.879 <span class="token comment"># +monitor master shard001 127.0.0.1 36379 quorum 2</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token number">5355</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:11:45.842 <span class="token comment"># +sdown master shard002 127.0.0.1 46379</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token number">5355</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:11:45.842 <span class="token comment"># +sdown master shard001 127.0.0.1 36379</span></pre></td></tr></table></figure><p>窗口三：启动哨兵 26381</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># redis-server ./26381.conf --sentinel</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:13:03.937 <span class="token comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:13:03.937 <span class="token comment"># Redis version=6.0.6, bits=64, commit=00000000, modified=0, pid=5412, just started</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:13:03.937 <span class="token comment"># Configuration loaded</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:13:03.938 * Increased maximum number of <span class="token function">open</span> files to <span class="token number">10032</span> <span class="token punctuation">(</span>it was originally <span class="token builtin class-name">set</span> to <span class="token number">1024</span><span class="token punctuation">)</span>.</pre></td></tr><tr><td data-num="6"></td><td><pre>                _._                                                  </pre></td></tr><tr><td data-num="7"></td><td><pre>           _.-`<span class="token variable"><span class="token variable">`</span>__ <span class="token string">''</span>-._                                             </span></pre></td></tr><tr><td data-num="8"></td><td><pre>      _.-<span class="token variable">`</span><span class="token variable"><span class="token variable">`</span>    <span class="token variable">`</span></span><span class="token builtin class-name">.</span>  <span class="token variable"><span class="token variable">`</span>_.  <span class="token string">''</span>-._           Redis <span class="token number">6.0</span>.6 <span class="token punctuation">(</span>00000000/0<span class="token punctuation">)</span> <span class="token number">64</span> bit</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  .-<span class="token variable">`</span><span class="token variable"><span class="token variable">`</span> .-<span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>  <span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token punctuation">\</span>/    _.,_ <span class="token string">''</span>-._                                   </span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">(</span>    '      ,       .-<span class="token variable">`</span>  <span class="token operator">|</span> <span class="token variable"><span class="token variable">`</span>,    <span class="token punctuation">)</span>     Running <span class="token keyword">in</span> sentinel mode</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token operator">|</span><span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-<span class="token punctuation">..</span>.-<span class="token variable">`</span></span> __<span class="token punctuation">..</span>.-.`<span class="token variable"><span class="token variable">`</span>-._<span class="token operator">|</span>'<span class="token variable">`</span></span> _.-<span class="token string">'|     Port: 26381</span></pre></td></tr><tr><td data-num="12"></td><td><pre> |    `-._   `._    /     _.-'    <span class="token operator">|</span>     PID: <span class="token number">5412</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-._  <span class="token variable"><span class="token variable">`</span>-./  _.-<span class="token string">'    _.-'</span>                                   </span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token operator">|</span><span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-.__.-<span class="token string">'    _.-'</span>_.-<span class="token string">'|                                  </span></pre></td></tr><tr><td data-num="15"></td><td><pre> |    `-._`-._        _.-'_.-<span class="token string">'    |           http://redis.io        </span></pre></td></tr><tr><td data-num="16"></td><td><pre>  `-._    `-._`-.__.-'_.-<span class="token string">'    _.-'</span>                                   </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token operator">|</span><span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-._    <span class="token variable"><span class="token variable">`</span>-.__.-<span class="token string">'    _.-'</span>_.-'<span class="token operator">|</span>                                  </span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token operator">|</span>    <span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-._        _.-<span class="token string">'_.-'</span>    <span class="token operator">|</span>                                  </span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token variable">`</span>-._    <span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-.__.-<span class="token string">'_.-'</span>    _.-<span class="token string">'                                   </span></pre></td></tr><tr><td data-num="20"></td><td><pre>      `-._    `-.__.-'    _.-<span class="token string">'                                       </span></pre></td></tr><tr><td data-num="21"></td><td><pre>          `-._        _.-'                                           </pre></td></tr><tr><td data-num="22"></td><td><pre>              `-.__.-'                                               </pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:13:03.939 <span class="token comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:13:03.942 <span class="token comment"># Sentinel ID is dab0ccb793eb724233786545def094e5d02eacc2</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:13:03.942 <span class="token comment"># +monitor master shard001 127.0.0.1 36379 quorum 2</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:13:03.942 <span class="token comment"># +monitor master shard002 127.0.0.1 46379 quorum 2</span></pre></td></tr></table></figure><p>创建存放主从机数据的文件夹</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cd test/</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># ll</span></pre></td></tr><tr><td data-num="3"></td><td><pre>总用量 <span class="token number">264</span></pre></td></tr><tr><td data-num="4"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root   <span class="token number">443</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">19</span>:09 <span class="token number">26379</span>.conf</pre></td></tr><tr><td data-num="5"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root   <span class="token number">443</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">19</span>:11 <span class="token number">26380</span>.conf</pre></td></tr><tr><td data-num="6"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root   <span class="token number">443</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">19</span>:13 <span class="token number">26381</span>.conf</pre></td></tr><tr><td data-num="7"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">83468</span> <span class="token number">12</span>月 <span class="token number">29</span> <span class="token number">17</span>:53 <span class="token number">6379</span>.conf</pre></td></tr><tr><td data-num="8"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">83525</span> <span class="token number">12</span>月 <span class="token number">29</span> <span class="token number">19</span>:12 <span class="token number">6380</span>.conf</pre></td></tr><tr><td data-num="9"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">83550</span> <span class="token number">12</span>月 <span class="token number">29</span> <span class="token number">19</span>:12 <span class="token number">6381</span>.conf</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># mkdir 36379</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># mkdir 36380</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># mkdir 46379</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># mkdir 46380</span></pre></td></tr></table></figure><p>窗口四：启动 36379redis 主机实例，启动后 sentinel 就可以监控到该主机</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost <span class="token number">36379</span><span class="token punctuation">]</span><span class="token comment"># redis-server --port 36379</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">5710</span>:C <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:33:54.782 <span class="token comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">5710</span>:C <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:33:54.782 <span class="token comment"># Redis version=6.0.6, bits=64, commit=00000000, modified=0, pid=5710, just started</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">5710</span>:C <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:33:54.782 <span class="token comment"># Configuration loaded</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">5710</span>:M <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:33:54.782 * Increased maximum number of <span class="token function">open</span> files to <span class="token number">10032</span> <span class="token punctuation">(</span>it was originally <span class="token builtin class-name">set</span> to <span class="token number">1024</span><span class="token punctuation">)</span>.</pre></td></tr><tr><td data-num="6"></td><td><pre>                _._                                                  </pre></td></tr><tr><td data-num="7"></td><td><pre>           _.-`<span class="token variable"><span class="token variable">`</span>__ <span class="token string">''</span>-._                                             </span></pre></td></tr><tr><td data-num="8"></td><td><pre>      _.-<span class="token variable">`</span><span class="token variable"><span class="token variable">`</span>    <span class="token variable">`</span></span><span class="token builtin class-name">.</span>  <span class="token variable"><span class="token variable">`</span>_.  <span class="token string">''</span>-._           Redis <span class="token number">6.0</span>.6 <span class="token punctuation">(</span>00000000/0<span class="token punctuation">)</span> <span class="token number">64</span> bit</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  .-<span class="token variable">`</span><span class="token variable"><span class="token variable">`</span> .-<span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>  <span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token punctuation">\</span>/    _.,_ <span class="token string">''</span>-._                                   </span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">(</span>    '      ,       .-<span class="token variable">`</span>  <span class="token operator">|</span> <span class="token variable"><span class="token variable">`</span>,    <span class="token punctuation">)</span>     Running <span class="token keyword">in</span> standalone mode</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token operator">|</span><span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-<span class="token punctuation">..</span>.-<span class="token variable">`</span></span> __<span class="token punctuation">..</span>.-.`<span class="token variable"><span class="token variable">`</span>-._<span class="token operator">|</span>'<span class="token variable">`</span></span> _.-<span class="token string">'|     Port: 36379</span></pre></td></tr><tr><td data-num="12"></td><td><pre> |    `-._   `._    /     _.-'    <span class="token operator">|</span>     PID: <span class="token number">5710</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-._  <span class="token variable"><span class="token variable">`</span>-./  _.-<span class="token string">'    _.-'</span>                                   </span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token operator">|</span><span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-.__.-<span class="token string">'    _.-'</span>_.-<span class="token string">'|                                  </span></pre></td></tr><tr><td data-num="15"></td><td><pre> |    `-._`-._        _.-'_.-<span class="token string">'    |           http://redis.io        </span></pre></td></tr><tr><td data-num="16"></td><td><pre>  `-._    `-._`-.__.-'_.-<span class="token string">'    _.-'</span>                                   </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token operator">|</span><span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-._    <span class="token variable"><span class="token variable">`</span>-.__.-<span class="token string">'    _.-'</span>_.-'<span class="token operator">|</span>                                  </span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token operator">|</span>    <span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-._        _.-<span class="token string">'_.-'</span>    <span class="token operator">|</span>                                  </span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token variable">`</span>-._    <span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-.__.-<span class="token string">'_.-'</span>    _.-<span class="token string">'                                   </span></pre></td></tr><tr><td data-num="20"></td><td><pre>      `-._    `-.__.-'    _.-<span class="token string">'                                       </span></pre></td></tr><tr><td data-num="21"></td><td><pre>          `-._        _.-'                                           </pre></td></tr><tr><td data-num="22"></td><td><pre>              `-.__.-<span class="token string">'                                               </span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>5710:M 31 Dec 2020 19:33:54.783 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</pre></td></tr><tr><td data-num="25"></td><td><pre>5710:M 31 Dec 2020 19:33:54.783 # Server initialized</pre></td></tr><tr><td data-num="26"></td><td><pre>5710:M 31 Dec 2020 19:33:54.783 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory <span class="token operator">=</span> <span class="token number">1</span><span class="token string">' to /etc/sysctl.conf and then reboot or run the command '</span>sysctl vm.overcommit_memory<span class="token operator">=</span><span class="token number">1</span><span class="token string">' for this to take effect.</span></pre></td></tr><tr><td data-num="27"></td><td><pre>5710:M 31 Dec 2020 19:33:54.783 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command '<span class="token builtin class-name">echo</span> never <span class="token operator">></span> /sys/kernel/mm/transparent_hugepage/enabled' as root, and <span class="token function">add</span> it to your /etc/rc.local <span class="token keyword">in</span> order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token number">5710</span>:M <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">19</span>:33:54.783 * Ready to accept connections</pre></td></tr></table></figure><p>窗口五：启动 redis 主机实例 36379 的从机 redis 实例 36380</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># cd 36380/</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@localhost <span class="token number">36380</span><span class="token punctuation">]</span><span class="token comment"># redis-server --port 36380 --replicaof 127.0.0.1 36379</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">6620</span>:C <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:13:00.775 <span class="token comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">6620</span>:C <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:13:00.775 <span class="token comment"># Redis version=6.0.6, bits=64, commit=00000000, modified=0, pid=6620, just started</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">6620</span>:C <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:13:00.775 <span class="token comment"># Configuration loaded</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">6620</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:13:00.775 * Increased maximum number of <span class="token function">open</span> files to <span class="token number">10032</span> <span class="token punctuation">(</span>it was originally <span class="token builtin class-name">set</span> to <span class="token number">1024</span><span class="token punctuation">)</span>.</pre></td></tr><tr><td data-num="7"></td><td><pre>                _._                                                  </pre></td></tr><tr><td data-num="8"></td><td><pre>           _.-`<span class="token variable"><span class="token variable">`</span>__ <span class="token string">''</span>-._                                             </span></pre></td></tr><tr><td data-num="9"></td><td><pre>      _.-<span class="token variable">`</span><span class="token variable"><span class="token variable">`</span>    <span class="token variable">`</span></span><span class="token builtin class-name">.</span>  <span class="token variable"><span class="token variable">`</span>_.  <span class="token string">''</span>-._           Redis <span class="token number">6.0</span>.6 <span class="token punctuation">(</span>00000000/0<span class="token punctuation">)</span> <span class="token number">64</span> bit</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  .-<span class="token variable">`</span><span class="token variable"><span class="token variable">`</span> .-<span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>  <span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token punctuation">\</span>/    _.,_ <span class="token string">''</span>-._                                   </span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token punctuation">(</span>    '      ,       .-<span class="token variable">`</span>  <span class="token operator">|</span> <span class="token variable"><span class="token variable">`</span>,    <span class="token punctuation">)</span>     Running <span class="token keyword">in</span> standalone mode</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token operator">|</span><span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-<span class="token punctuation">..</span>.-<span class="token variable">`</span></span> __<span class="token punctuation">..</span>.-.`<span class="token variable"><span class="token variable">`</span>-._<span class="token operator">|</span>'<span class="token variable">`</span></span> _.-<span class="token string">'|     Port: 36380</span></pre></td></tr><tr><td data-num="13"></td><td><pre> |    `-._   `._    /     _.-'    <span class="token operator">|</span>     PID: <span class="token number">6620</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-._  <span class="token variable"><span class="token variable">`</span>-./  _.-<span class="token string">'    _.-'</span>                                   </span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token operator">|</span><span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-.__.-<span class="token string">'    _.-'</span>_.-<span class="token string">'|                                  </span></pre></td></tr><tr><td data-num="16"></td><td><pre> |    `-._`-._        _.-'_.-<span class="token string">'    |           http://redis.io        </span></pre></td></tr><tr><td data-num="17"></td><td><pre>  `-._    `-._`-.__.-'_.-<span class="token string">'    _.-'</span>                                   </pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token operator">|</span><span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-._    <span class="token variable"><span class="token variable">`</span>-.__.-<span class="token string">'    _.-'</span>_.-'<span class="token operator">|</span>                                  </span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token operator">|</span>    <span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-._        _.-<span class="token string">'_.-'</span>    <span class="token operator">|</span>                                  </span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token variable">`</span>-._    <span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-.__.-<span class="token string">'_.-'</span>    _.-<span class="token string">'                                   </span></pre></td></tr><tr><td data-num="21"></td><td><pre>      `-._    `-.__.-'    _.-<span class="token string">'                                       </span></pre></td></tr><tr><td data-num="22"></td><td><pre>          `-._        _.-'                                           </pre></td></tr><tr><td data-num="23"></td><td><pre>              `-.__.-<span class="token string">'                                               </span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>6620:S 31 Dec 2020 21:13:00.776 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</pre></td></tr><tr><td data-num="26"></td><td><pre>6620:S 31 Dec 2020 21:13:00.776 # Server initialized</pre></td></tr><tr><td data-num="27"></td><td><pre>6620:S 31 Dec 2020 21:13:00.776 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory <span class="token operator">=</span> <span class="token number">1</span><span class="token string">' to /etc/sysctl.conf and then reboot or run the command '</span>sysctl vm.overcommit_memory<span class="token operator">=</span><span class="token number">1</span><span class="token string">' for this to take effect.</span></pre></td></tr><tr><td data-num="28"></td><td><pre>6620:S 31 Dec 2020 21:13:00.776 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command '<span class="token builtin class-name">echo</span> never <span class="token operator">></span> /sys/kernel/mm/transparent_hugepage/enabled' as root, and <span class="token function">add</span> it to your /etc/rc.local <span class="token keyword">in</span> order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token number">6620</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:13:00.776 * Ready to accept connections</pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token number">6620</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:13:00.776 * Connecting to MASTER <span class="token number">127.0</span>.0.1:36379</pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token number">6620</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:13:00.777 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA <span class="token function">sync</span> started</pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token number">6620</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:13:00.777 * Non blocking connect <span class="token keyword">for</span> SYNC fired the event.</pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token number">6620</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:13:00.777 * Master replied to PING, replication can continue<span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token number">6620</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:13:00.778 * Partial resynchronization not possible <span class="token punctuation">(</span>no cached master<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token number">6620</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:13:00.886 * Full resync from master: c1325db54988484b211ed9874d584db5cd9b67f6:0</pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token number">6620</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:13:00.925 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA sync: receiving <span class="token number">175</span> bytes from master to disk</pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token number">6620</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:13:00.925 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA sync: Flushing old data</pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token number">6620</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:13:00.925 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA sync: Loading DB <span class="token keyword">in</span> memory</pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token number">6620</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:13:00.925 * Loading RDB produced by version <span class="token number">6.0</span>.6</pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token number">6620</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:13:00.925 * RDB age <span class="token number">0</span> seconds</pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token number">6620</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:13:00.925 * RDB memory usage when created <span class="token number">1.98</span> Mb</pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token number">6620</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:13:00.925 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA sync: Finished with success</pre></td></tr></table></figure><p>窗口六：启动 46379redis 主机实例</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost <span class="token number">46379</span><span class="token punctuation">]</span><span class="token comment"># redis-server --port 46379</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">6721</span>:C <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:19:28.583 <span class="token comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">6721</span>:C <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:19:28.583 <span class="token comment"># Redis version=6.0.6, bits=64, commit=00000000, modified=0, pid=6721, just started</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">6721</span>:C <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:19:28.583 <span class="token comment"># Configuration loaded</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">6721</span>:M <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:19:28.583 * Increased maximum number of <span class="token function">open</span> files to <span class="token number">10032</span> <span class="token punctuation">(</span>it was originally <span class="token builtin class-name">set</span> to <span class="token number">1024</span><span class="token punctuation">)</span>.</pre></td></tr><tr><td data-num="6"></td><td><pre>                _._                                                  </pre></td></tr><tr><td data-num="7"></td><td><pre>           _.-`<span class="token variable"><span class="token variable">`</span>__ <span class="token string">''</span>-._                                             </span></pre></td></tr><tr><td data-num="8"></td><td><pre>      _.-<span class="token variable">`</span><span class="token variable"><span class="token variable">`</span>    <span class="token variable">`</span></span><span class="token builtin class-name">.</span>  <span class="token variable"><span class="token variable">`</span>_.  <span class="token string">''</span>-._           Redis <span class="token number">6.0</span>.6 <span class="token punctuation">(</span>00000000/0<span class="token punctuation">)</span> <span class="token number">64</span> bit</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  .-<span class="token variable">`</span><span class="token variable"><span class="token variable">`</span> .-<span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>  <span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token punctuation">\</span>/    _.,_ <span class="token string">''</span>-._                                   </span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">(</span>    '      ,       .-<span class="token variable">`</span>  <span class="token operator">|</span> <span class="token variable"><span class="token variable">`</span>,    <span class="token punctuation">)</span>     Running <span class="token keyword">in</span> standalone mode</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token operator">|</span><span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-<span class="token punctuation">..</span>.-<span class="token variable">`</span></span> __<span class="token punctuation">..</span>.-.`<span class="token variable"><span class="token variable">`</span>-._<span class="token operator">|</span>'<span class="token variable">`</span></span> _.-<span class="token string">'|     Port: 46379</span></pre></td></tr><tr><td data-num="12"></td><td><pre> |    `-._   `._    /     _.-'    <span class="token operator">|</span>     PID: <span class="token number">6721</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-._  <span class="token variable"><span class="token variable">`</span>-./  _.-<span class="token string">'    _.-'</span>                                   </span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token operator">|</span><span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-.__.-<span class="token string">'    _.-'</span>_.-<span class="token string">'|                                  </span></pre></td></tr><tr><td data-num="15"></td><td><pre> |    `-._`-._        _.-'_.-<span class="token string">'    |           http://redis.io        </span></pre></td></tr><tr><td data-num="16"></td><td><pre>  `-._    `-._`-.__.-'_.-<span class="token string">'    _.-'</span>                                   </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token operator">|</span><span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-._    <span class="token variable"><span class="token variable">`</span>-.__.-<span class="token string">'    _.-'</span>_.-'<span class="token operator">|</span>                                  </span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token operator">|</span>    <span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-._        _.-<span class="token string">'_.-'</span>    <span class="token operator">|</span>                                  </span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token variable">`</span>-._    <span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-.__.-<span class="token string">'_.-'</span>    _.-<span class="token string">'                                   </span></pre></td></tr><tr><td data-num="20"></td><td><pre>      `-._    `-.__.-'    _.-<span class="token string">'                                       </span></pre></td></tr><tr><td data-num="21"></td><td><pre>          `-._        _.-'                                           </pre></td></tr><tr><td data-num="22"></td><td><pre>              `-.__.-<span class="token string">'                                               </span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>6721:M 31 Dec 2020 21:19:28.583 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</pre></td></tr><tr><td data-num="25"></td><td><pre>6721:M 31 Dec 2020 21:19:28.583 # Server initialized</pre></td></tr><tr><td data-num="26"></td><td><pre>6721:M 31 Dec 2020 21:19:28.583 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory <span class="token operator">=</span> <span class="token number">1</span><span class="token string">' to /etc/sysctl.conf and then reboot or run the command '</span>sysctl vm.overcommit_memory<span class="token operator">=</span><span class="token number">1</span><span class="token string">' for this to take effect.</span></pre></td></tr><tr><td data-num="27"></td><td><pre>6721:M 31 Dec 2020 21:19:28.584 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command '<span class="token builtin class-name">echo</span> never <span class="token operator">></span> /sys/kernel/mm/transparent_hugepage/enabled' as root, and <span class="token function">add</span> it to your /etc/rc.local <span class="token keyword">in</span> order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token number">6721</span>:M <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:19:28.584 * Ready to accept connections</pre></td></tr></table></figure><p>窗口七：启动 46379redis 主机实例的从机 redis 实例 46380</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost test<span class="token punctuation">]</span><span class="token comment"># cd 46380/</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>root@localhost <span class="token number">46380</span><span class="token punctuation">]</span><span class="token comment"># ll</span></pre></td></tr><tr><td data-num="3"></td><td><pre>总用量 <span class="token number">0</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>root@localhost <span class="token number">46380</span><span class="token punctuation">]</span><span class="token comment"># redis-server --port 46380 --replicaof 127.0.0.1 46379</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">6787</span>:C <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:21:40.061 <span class="token comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">6787</span>:C <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:21:40.061 <span class="token comment"># Redis version=6.0.6, bits=64, commit=00000000, modified=0, pid=6787, just started</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">6787</span>:C <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:21:40.061 <span class="token comment"># Configuration loaded</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">6787</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:21:40.062 * Increased maximum number of <span class="token function">open</span> files to <span class="token number">10032</span> <span class="token punctuation">(</span>it was originally <span class="token builtin class-name">set</span> to <span class="token number">1024</span><span class="token punctuation">)</span>.</pre></td></tr><tr><td data-num="9"></td><td><pre>                _._                                                  </pre></td></tr><tr><td data-num="10"></td><td><pre>           _.-`<span class="token variable"><span class="token variable">`</span>__ <span class="token string">''</span>-._                                             </span></pre></td></tr><tr><td data-num="11"></td><td><pre>      _.-<span class="token variable">`</span><span class="token variable"><span class="token variable">`</span>    <span class="token variable">`</span></span><span class="token builtin class-name">.</span>  <span class="token variable"><span class="token variable">`</span>_.  <span class="token string">''</span>-._           Redis <span class="token number">6.0</span>.6 <span class="token punctuation">(</span>00000000/0<span class="token punctuation">)</span> <span class="token number">64</span> bit</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  .-<span class="token variable">`</span><span class="token variable"><span class="token variable">`</span> .-<span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>  <span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token punctuation">\</span>/    _.,_ <span class="token string">''</span>-._                                   </span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token punctuation">(</span>    '      ,       .-<span class="token variable">`</span>  <span class="token operator">|</span> <span class="token variable"><span class="token variable">`</span>,    <span class="token punctuation">)</span>     Running <span class="token keyword">in</span> standalone mode</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token operator">|</span><span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-<span class="token punctuation">..</span>.-<span class="token variable">`</span></span> __<span class="token punctuation">..</span>.-.`<span class="token variable"><span class="token variable">`</span>-._<span class="token operator">|</span>'<span class="token variable">`</span></span> _.-<span class="token string">'|     Port: 46380</span></pre></td></tr><tr><td data-num="15"></td><td><pre> |    `-._   `._    /     _.-'    <span class="token operator">|</span>     PID: <span class="token number">6787</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-._  <span class="token variable"><span class="token variable">`</span>-./  _.-<span class="token string">'    _.-'</span>                                   </span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token operator">|</span><span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-.__.-<span class="token string">'    _.-'</span>_.-<span class="token string">'|                                  </span></pre></td></tr><tr><td data-num="18"></td><td><pre> |    `-._`-._        _.-'_.-<span class="token string">'    |           http://redis.io        </span></pre></td></tr><tr><td data-num="19"></td><td><pre>  `-._    `-._`-.__.-'_.-<span class="token string">'    _.-'</span>                                   </pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token operator">|</span><span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-._    <span class="token variable"><span class="token variable">`</span>-.__.-<span class="token string">'    _.-'</span>_.-'<span class="token operator">|</span>                                  </span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token operator">|</span>    <span class="token variable">`</span>-._<span class="token variable"><span class="token variable">`</span>-._        _.-<span class="token string">'_.-'</span>    <span class="token operator">|</span>                                  </span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token variable">`</span>-._    <span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-.__.-<span class="token string">'_.-'</span>    _.-<span class="token string">'                                   </span></pre></td></tr><tr><td data-num="23"></td><td><pre>      `-._    `-.__.-'    _.-<span class="token string">'                                       </span></pre></td></tr><tr><td data-num="24"></td><td><pre>          `-._        _.-'                                           </pre></td></tr><tr><td data-num="25"></td><td><pre>              `-.__.-<span class="token string">'                                               </span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>6787:S 31 Dec 2020 21:21:40.062 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</pre></td></tr><tr><td data-num="28"></td><td><pre>6787:S 31 Dec 2020 21:21:40.062 # Server initialized</pre></td></tr><tr><td data-num="29"></td><td><pre>6787:S 31 Dec 2020 21:21:40.062 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory <span class="token operator">=</span> <span class="token number">1</span><span class="token string">' to /etc/sysctl.conf and then reboot or run the command '</span>sysctl vm.overcommit_memory<span class="token operator">=</span><span class="token number">1</span><span class="token string">' for this to take effect.</span></pre></td></tr><tr><td data-num="30"></td><td><pre>6787:S 31 Dec 2020 21:21:40.062 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command '<span class="token builtin class-name">echo</span> never <span class="token operator">></span> /sys/kernel/mm/transparent_hugepage/enabled' as root, and <span class="token function">add</span> it to your /etc/rc.local <span class="token keyword">in</span> order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token number">6787</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:21:40.063 * Ready to accept connections</pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token number">6787</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:21:40.063 * Connecting to MASTER <span class="token number">127.0</span>.0.1:46379</pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token number">6787</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:21:40.063 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA <span class="token function">sync</span> started</pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token number">6787</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:21:40.063 * Non blocking connect <span class="token keyword">for</span> SYNC fired the event.</pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token number">6787</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:21:40.064 * Master replied to PING, replication can continue<span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token number">6787</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:21:40.065 * Partial resynchronization not possible <span class="token punctuation">(</span>no cached master<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token number">6787</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:21:40.241 * Full resync from master: 6a5fde4365205efd018da9c9bd274af620b286ad:0</pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token number">6787</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:21:40.363 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA sync: receiving <span class="token number">175</span> bytes from master to disk</pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token number">6787</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:21:40.363 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA sync: Flushing old data</pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token number">6787</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:21:40.363 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA sync: Loading DB <span class="token keyword">in</span> memory</pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token number">6787</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:21:40.363 * Loading RDB produced by version <span class="token number">6.0</span>.6</pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token number">6787</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:21:40.363 * RDB age <span class="token number">0</span> seconds</pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token number">6787</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:21:40.363 * RDB memory usage when created <span class="token number">1.98</span> Mb</pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token number">6787</span>:S <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">21</span>:21:40.363 * MASTER <span class="token operator">&lt;</span>-<span class="token operator">></span> REPLICA sync: Finished with success</pre></td></tr></table></figure><p>窗口八：启动 predixy 代理</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost bin<span class="token punctuation">]</span><span class="token comment"># pwd</span></pre></td></tr><tr><td data-num="2"></td><td><pre>/root/predixy-1.0.5/bin</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@localhost bin<span class="token punctuation">]</span><span class="token comment"># ./predixy ../conf/predixy.conf </span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">21</span>:42:04.137826 N Proxy.cpp:112 predixy listen <span class="token keyword">in</span> <span class="token number">127.0</span>.0.1:7617</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">21</span>:42:04.138153 N Proxy.cpp:143 predixy running with Name:PredixyExample Workers:1</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">21</span>:42:04.138602 N Handler.cpp:454 h <span class="token number">0</span> create connection pool <span class="token keyword">for</span> server <span class="token number">127.0</span>.0.1:26379</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">21</span>:42:04.138732 N ConnectConnectionPool.cpp:42 h <span class="token number">0</span> create server connection <span class="token number">127.0</span>.0.1:26379 <span class="token number">5</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">21</span>:42:04.139191 N Handler.cpp:454 h <span class="token number">0</span> create connection pool <span class="token keyword">for</span> server <span class="token number">127.0</span>.0.1:26380</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">21</span>:42:04.139323 N ConnectConnectionPool.cpp:42 h <span class="token number">0</span> create server connection <span class="token number">127.0</span>.0.1:26380 <span class="token number">6</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">21</span>:42:04.139666 N Handler.cpp:454 h <span class="token number">0</span> create connection pool <span class="token keyword">for</span> server <span class="token number">127.0</span>.0.1:26381</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">21</span>:42:04.139715 N ConnectConnectionPool.cpp:42 h <span class="token number">0</span> create server connection <span class="token number">127.0</span>.0.1:26381 <span class="token number">7</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">21</span>:42:04.143787 N StandaloneServerPool.cpp:422 sentinel server pool group shard001 create master server <span class="token number">127.0</span>.0.1:36379 </pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">21</span>:42:04.143862 N StandaloneServerPool.cpp:472 sentinel server pool group shard001 create slave server <span class="token number">127.0</span>.0.1:36380 </pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">21</span>:42:04.143872 N StandaloneServerPool.cpp:422 sentinel server pool group shard002 create master server <span class="token number">127.0</span>.0.1:46379 </pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">21</span>:42:04.143973 N StandaloneServerPool.cpp:472 sentinel server pool group shard002 create slave server <span class="token number">127.0</span>.0.1:46380</pre></td></tr></table></figure><p>窗口九：通过 redis 客户端连接代理所在端口 7617，并设置一些数据</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -p 7617</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">127.0</span>.0.1:761<span class="token operator"><span class="token file-descriptor important">7</span>></span> <span class="token builtin class-name">set</span> k1 aaa</pre></td></tr><tr><td data-num="3"></td><td><pre>OK</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">127.0</span>.0.1:761<span class="token operator"><span class="token file-descriptor important">7</span>></span> <span class="token builtin class-name">set</span> k2 bbb</pre></td></tr><tr><td data-num="5"></td><td><pre>OK</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">127.0</span>.0.1:761<span class="token operator"><span class="token file-descriptor important">7</span>></span> <span class="token builtin class-name">set</span> k3 ccc</pre></td></tr><tr><td data-num="7"></td><td><pre>OK</pre></td></tr></table></figure><p>窗口十：查看 redis 主机实例 36379 中是否有代理的数据</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -p 36379</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">127.0</span>.0.1:3637<span class="token operator"><span class="token file-descriptor important">9</span>></span> keys *</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"k3"</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"k1"</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">127.0</span>.0.1:3637<span class="token operator"><span class="token file-descriptor important">9</span>></span></pre></td></tr></table></figure><p>窗口十一：查看 redis 主机实例 46379 中是否有代理的数据</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -p 46379</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">127.0</span>.0.1:4637<span class="token operator"><span class="token file-descriptor important">9</span>></span> keys *</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"k2"</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">127.0</span>.0.1:4637<span class="token operator"><span class="token file-descriptor important">9</span>></span></pre></td></tr></table></figure><p>!&gt; 所以，通过 predixy 代理可以自动实现数据的分区以及哨兵监控</p><p>此外，前缀相同的 key 会被存进同一个 redis 实例，例如：</p><p>窗口九：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -p 7617</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">127.0</span>.0.1:761<span class="token operator"><span class="token file-descriptor important">7</span>></span> <span class="token builtin class-name">set</span> <span class="token punctuation">&#123;</span>xx<span class="token punctuation">&#125;</span>k1 aaa</pre></td></tr><tr><td data-num="4"></td><td><pre>OK</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">127.0</span>.0.1:761<span class="token operator"><span class="token file-descriptor important">7</span>></span> <span class="token builtin class-name">set</span> <span class="token punctuation">&#123;</span>xx<span class="token punctuation">&#125;</span>k2 bbb</pre></td></tr><tr><td data-num="6"></td><td><pre>OK</pre></td></tr></table></figure><p>窗口十一：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -p 46379</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">127.0</span>.0.1:4637<span class="token operator"><span class="token file-descriptor important">9</span>></span> keys *</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"k2"</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"&#123;xx&#125;k1"</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"&#123;xx&#125;k2"</span></pre></td></tr></table></figure><p>!&gt;predixy 只支持存在单个 group 时的事务，有多个 group 时不再支持事务</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -p 7617</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">127.0</span>.0.1:761<span class="token operator"><span class="token file-descriptor important">7</span>></span> WATCH k1</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">(</span>error<span class="token punctuation">)</span> ERR forbid transaction <span class="token keyword">in</span> current server pool</pre></td></tr></table></figure><p>停掉窗口八中的 predixy 服务，然后在 sentinel.conf 配置文件中注释掉一个 group</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>SentinelServerPool <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    Databases <span class="token number">16</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    Hash crc16</pre></td></tr><tr><td data-num="4"></td><td><pre>    HashTag <span class="token string">"&#123;&#125;"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    Distribution modula</pre></td></tr><tr><td data-num="6"></td><td><pre>    MasterReadPriority <span class="token number">60</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    StaticSlaveReadPriority <span class="token number">50</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    DynamicSlaveReadPriority <span class="token number">50</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    RefreshInterval <span class="token number">1</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    ServerTimeout <span class="token number">1</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    ServerFailureLimit <span class="token number">10</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    ServerRetryTimeout <span class="token number">1</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    KeepAlive <span class="token number">120</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    Sentinels <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        + <span class="token number">127.0</span>.0.1:26379</pre></td></tr><tr><td data-num="16"></td><td><pre>        + <span class="token number">127.0</span>.0.1:26380</pre></td></tr><tr><td data-num="17"></td><td><pre>        + <span class="token number">127.0</span>.0.1:26381</pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    Group shard001 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">#    Group shard002 &#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">#    &#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>保存该配置文件后重新启动 predixy 服务</p><p>窗口八：可以看到，此时只有 36379 主机以及 36380 从机</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost bin<span class="token punctuation">]</span><span class="token comment"># ./predixy ../conf/predixy.conf </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">22</span>:07:57.241246 N Proxy.cpp:112 predixy listen <span class="token keyword">in</span> <span class="token number">127.0</span>.0.1:7617</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">22</span>:07:57.241300 N Proxy.cpp:143 predixy running with Name:PredixyExample Workers:1</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">22</span>:07:57.241379 N Handler.cpp:454 h <span class="token number">0</span> create connection pool <span class="token keyword">for</span> server <span class="token number">127.0</span>.0.1:26379</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">22</span>:07:57.241427 N ConnectConnectionPool.cpp:42 h <span class="token number">0</span> create server connection <span class="token number">127.0</span>.0.1:26379 <span class="token number">5</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">22</span>:07:57.241677 N Handler.cpp:454 h <span class="token number">0</span> create connection pool <span class="token keyword">for</span> server <span class="token number">127.0</span>.0.1:26380</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">22</span>:07:57.241695 N ConnectConnectionPool.cpp:42 h <span class="token number">0</span> create server connection <span class="token number">127.0</span>.0.1:26380 <span class="token number">6</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">22</span>:07:57.244082 N StandaloneServerPool.cpp:422 sentinel server pool group shard001 create master server <span class="token number">127.0</span>.0.1:36379 </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">22</span>:07:57.244102 N StandaloneServerPool.cpp:472 sentinel server pool group shard001 create slave server <span class="token number">127.0</span>.0.1:36380 </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">22</span>:07:58.254502 N Handler.cpp:454 h <span class="token number">0</span> create connection pool <span class="token keyword">for</span> server <span class="token number">127.0</span>.0.1:26381</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">2020</span>-12-31 <span class="token number">22</span>:07:58.254565 N ConnectConnectionPool.cpp:42 h <span class="token number">0</span> create server connection <span class="token number">127.0</span>.0.1:26381 <span class="token number">7</span></pre></td></tr></table></figure><p>窗口九：可以看到，此时支持事务</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:761<span class="token operator"><span class="token file-descriptor important">7</span>></span> <span class="token builtin class-name">set</span> k1 aaa</pre></td></tr><tr><td data-num="2"></td><td><pre>OK</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">127.0</span>.0.1:761<span class="token operator"><span class="token file-descriptor important">7</span>></span> WATCH k1</pre></td></tr><tr><td data-num="4"></td><td><pre>OK</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">127.0</span>.0.1:761<span class="token operator"><span class="token file-descriptor important">7</span>></span> MULTI</pre></td></tr><tr><td data-num="6"></td><td><pre>OK</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">127.0</span>.0.1:761<span class="token operator"><span class="token file-descriptor important">7</span>></span> get k1</pre></td></tr><tr><td data-num="8"></td><td><pre>QUEUED</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">127.0</span>.0.1:761<span class="token operator"><span class="token file-descriptor important">7</span>></span> EXEC</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"aaa"</span></pre></td></tr></table></figure><p>!&gt; 验证主机 36379 挂掉后，predixy 能否通过哨兵监控并自动选出新的主机</p><p>窗口四：Ctrl + C 结束掉主机 36379</p><p>稍等数秒后从窗口一二三都可以看到，选出了新的主机 36380</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:13:57.426 <span class="token comment"># +sdown master shard001 127.0.0.1 36379</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:13:57.528 <span class="token comment"># +odown master shard001 127.0.0.1 36379 #quorum 2/2</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:13:57.528 <span class="token comment"># +new-epoch 1</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:13:57.528 <span class="token comment"># +try-failover master shard001 127.0.0.1 36379</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:13:57.531 <span class="token comment"># +vote-for-leader dab0ccb793eb724233786545def094e5d02eacc2 1</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:13:57.544 <span class="token comment"># 0385e1f81c98a8c43bae85a73cf71d18703050aa voted for dab0ccb793eb724233786545def094e5d02eacc2 1</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:13:57.547 <span class="token comment"># b6d21fe37d6597b323244d42db7932a890b4e772 voted for dab0ccb793eb724233786545def094e5d02eacc2 1</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:13:57.631 <span class="token comment"># +elected-leader master shard001 127.0.0.1 36379</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:13:57.631 <span class="token comment"># +failover-state-select-slave master shard001 127.0.0.1 36379</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:13:57.716 <span class="token comment"># +selected-slave slave 127.0.0.1:36380 127.0.0.1 36380 @ shard001 127.0.0.1 36379</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:13:57.716 * +failover-state-send-slaveof-noone slave <span class="token number">127.0</span>.0.1:36380 <span class="token number">127.0</span>.0.1 <span class="token number">36380</span> @ shard001 <span class="token number">127.0</span>.0.1 <span class="token number">36379</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:13:57.775 * +failover-state-wait-promotion slave <span class="token number">127.0</span>.0.1:36380 <span class="token number">127.0</span>.0.1 <span class="token number">36380</span> @ shard001 <span class="token number">127.0</span>.0.1 <span class="token number">36379</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:13:58.285 <span class="token comment"># +promoted-slave slave 127.0.0.1:36380 127.0.0.1 36380 @ shard001 127.0.0.1 36379</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:13:58.285 <span class="token comment"># +failover-state-reconf-slaves master shard001 127.0.0.1 36379</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:13:58.386 <span class="token comment"># +failover-end master shard001 127.0.0.1 36379</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:13:58.386 <span class="token comment"># +switch-master shard001 127.0.0.1 36379 127.0.0.1 36380</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:13:58.386 * +slave slave <span class="token number">127.0</span>.0.1:36379 <span class="token number">127.0</span>.0.1 <span class="token number">36379</span> @ shard001 <span class="token number">127.0</span>.0.1 <span class="token number">36380</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token number">5412</span>:X <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:14:28.421 <span class="token comment"># +sdown slave 127.0.0.1:36379 127.0.0.1 36379 @ shard001 127.0.0.1 36380</span></pre></td></tr></table></figure><p>窗口五：36380 从机转换为了主机模式</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">6620</span>:M <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:13:57.775 <span class="token comment"># Setting secondary replication ID to c1325db54988484b211ed9874d584db5cd9b67f6, valid up to offset: 719988. New replication ID is ce14bc06ada831cf2d3b116f7353d256dc82fbf4</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">6620</span>:M <span class="token number">31</span> Dec <span class="token number">2020</span> <span class="token number">22</span>:13:57.775 * MASTER MODE enabled <span class="token punctuation">(</span>user request from <span class="token string">'id=5 addr=127.0.0.1:48708 fd=9 name=sentinel-dab0ccb7-cmd age=3648 idle=0 flags=x db=0 sub=0 psub=0 multi=4 qbuf=188 qbuf-free=32580 obl=45 oll=0 omem=0 events=r cmd=exec user=default'</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>窗口九：此时通过代理客户端也可以获取 key，不会因为主机的转换而受影响</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -p 7617</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">127.0</span>.0.1:761<span class="token operator"><span class="token file-descriptor important">7</span>></span> get k1</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token string">"aaa"</span></pre></td></tr></table></figure><blockquote><p>![tip]</p><p>总结：代理的好处对于开发人员来说，无需关心有多少的 redis 实例，也无需关心代理了哪些 redis 实例或者哪些 redis 实例因挂掉不可用，面对开发人员的只有代理的客户端，只需要在代理的客户端操作数据即可。</p></blockquote><h3 id="分区的优点"><a class="anchor" href="#分区的优点">#</a> 分区的优点</h3><ul><li>分区可以让 Redis 管理更大的内存，Redis 将可以使用所有机器的内存。如果没有分区，你最多只能使用一台机器的内存。</li><li>分区使 Redis 的计算能力通过简单地增加计算机得到成倍提升，Redis 的网络带宽也会随着计算机和网卡的增加而成倍增长。</li></ul><h3 id="分区的缺点"><a class="anchor" href="#分区的缺点">#</a> 分区的缺点</h3><p>有些特性在分区的情况下将受到限制:</p><ul><li>涉及多个 key 的操作通常不会被支持。例如你不能对两个集合求交集，因为他们可能被存储到不同的 Redis 实例（实际上这种情况也有办法，但是不能直接使用交集指令）。</li><li>同时操作多个 key, 则不能使用 Redis 事务.</li><li>分区使用的粒度是 key，不能使用一个非常长的排序 key 存储一个数据集（The partitioning granularity is the key, so it is not possible to shard a dataset with a single huge key like a very big sorted set）.</li><li>当使用分区的时候，数据处理会非常复杂，例如为了备份你必须从不同的 Redis 实例和主机同时收集 RDB / AOF 文件。</li><li>分区时动态扩容或缩容可能非常复杂。Redis 集群在运行时增加或者删除 Redis 节点，能做到最大程度对用户透明地数据再平衡，但其他一些客户端分区或者代理分区方法则不支持这种特性。然而，有一种<em>预分片</em>的技术也可以较好的解决这个问题。</li></ul><h3 id="预分片"><a class="anchor" href="#预分片">#</a> 预分片</h3><p>从上面获知，除非我们把 Redis 当做缓存使用，否则（在生产环境动态）增加和删除节点将非常麻烦，但是使用固定的 keys-instances 则比较简单。</p><p>一般情况下随着时间的推移，数据存储需求总会发生变化。今天可能 10 个 Redis 节点就够了，但是明天可能就需要增加到 50 个节点。</p><p>既然 Redis 是如此的轻量（单实例只使用 1M 内存）, 为防止以后的扩容，最好的办法就是一开始就启动较多实例。即便你只有一台服务器，你也可以一开始就让 Redis 以分布式的方式运行，使用分区，在同一台服务器上启动多个实例。</p><p>一开始就多设置几个 Redis 实例，例如 32 或者 64 个实例，对大多数用户来说这操作起来可能比较麻烦，但是从长久来看做这点牺牲是值得的。</p><p>这样的话，当你的数据不断增长，需要更多的 Redis 服务器时，你需要做的就是仅仅将 Redis 实例从一台服务迁移到另外一台服务器而已（而不用考虑重新分区的问题）。一旦你添加了另一台服务器，你需要将你一半的 Redis 实例从第一台机器迁移到第二台机器。</p><p>使用 Redis 复制技术，你可以做到极短或者不停机地对用户提供服务：</p><ul><li>在你新服务器启动一个空 Redis 实例。</li><li>把新 Redis 实例配置为原实例的 slave 节点</li><li>停止你的客户端</li><li>更新你客户端配置，以便启用新的 redis 实例（更新 IP）。</li><li>在新 Redis 实例中执行 <code>SLAVEOF NO ONE</code> 命令</li><li>（更新配置后）重启你的客户端</li><li>停止你原服务器的 Redis 实例</li></ul><h3 id="持久化数据还是缓存"><a class="anchor" href="#持久化数据还是缓存">#</a> 持久化数据还是缓存</h3><p>无论是把 Redis 当做持久化的数据存储还是当作一个缓存，从分区的角度来看是没有区别的。当把 Redis 当做一个持久化的存储（服务）时，一个 key 必须严格地每次被映射到同一个 Redis 实例。当把 Redis 当做一个缓存（服务）时，即使 Redis 的其中一个节点不可用而把请求转给另外一个 Redis 实例，也不对我们的系统产生什么影响，我们可用任意的规则更改映射，进而提高系统的<em>高可用</em>（即系统的响应能力）。</p><p>一致性哈希能够实现当一个 key 的首选的节点不可用时切换至其他节点。同样地，如果你增加了一个新节点，立刻就会有新的 key 被分配至这个新节点。</p><p>重要结论如下:</p><ul><li>如果 Redis 被当做缓存使用，使用一致性哈希实现<strong>动态扩容缩容</strong>。</li><li>如果 Redis 被当做一个持久化存储使用，<strong>必须使用固定的 keys-to-nodes 映射关系，节点的数量一旦确定不能变化</strong>。否则的话 (即 Redis 节点需要动态变化的情况），必须使用可以在运行时进行数据再平衡的一套系统，而当前只有 Redis 集群可以做到这样 - Redis 集群已经可用 <span class="exturl" data-url="aHR0cHM6Ly9ncm91cHMuZ29vZ2xlLmNvbS9kL21zZy9yZWRpcy1kYi9kTzBiRnlEX1RIUS9Vb28yR2pJeDZxZ0o=">2015.4.1</span>.</li></ul><h2 id="redis的集群"><a class="anchor" href="#redis的集群">#</a> redis 的集群</h2><ul><li><span class="exturl" data-url="aHR0cDovL3d3dy5yZWRpcy5jbi90b3BpY3MvY2x1c3Rlci10dXRvcmlhbC5odG1s">Redis 集群教程</span>：入门级的 Redis 集群使用指南。</li><li><span class="exturl" data-url="aHR0cDovL3d3dy5yZWRpcy5jbi90b3BpY3MvY2x1c3Rlci1zcGVjLmh0bWw=">Redis 集群规范</span>：进阶版的 Redis 集群使用规范。</li></ul><p>**redis 集群属于 redis 分区的一种具体实现。**Redis 集群是 <em>query routing</em> 和 <em>client side partitioning</em> 的一种混合实现。</p><p>Redis 集群是自动分片和高可用的首选方案。新的集群方案 2015 年 4 月 1 日就已经可用。<span class="exturl" data-url="aHR0cHM6Ly9ncm91cHMuZ29vZ2xlLmNvbS9kL21zZy9yZWRpcy1kYi9kTzBiRnlEX1RIUS9Vb28yR2pJeDZxZ0o=">2015.4.1 Google 论文</span>。你可以从这里<span class="exturl" data-url="aHR0cDovL3d3dy5yZWRpcy5jbi90b3BpY3MvY2x1c3Rlci10dXRvcmlhbA=="> Cluster tutorial</span> 了解更多。</p><p>当 Redis 集群可用，并且有兼容 Redis 集群客户端可用于你的编程语言，Redis 集群将成为 Redis 分区的实际标准。</p><p>图例：</p><p>key 通过 mapping 去映射到 redis 实例，每个 redis 实例中有哈希算法以及其他 redis 实例的 mapping 映射，如果请求的 key 不在本 redis 实例，那么该 key 将通过本 redis 实例中的哈希算法计算出 key 在本 redis 实例中的哪个 mapping 映射当中，随后返回所在的 mapping 映射，然后再去该 mapping 映射所在的 redis 实例中查找 key 以及值。<strong>这种方式属于 redis 分区方式中的查找路由：意思是客户端随机地请求任意一个 redis 实例，然后由 Redis 将请求转发给正确的 Redis 节点。Redis Cluster 实现了一种混合形式的查询路由，但并不是直接将请求从一个 redis 节点转发到另一个 redis 节点，而是在客户端的帮助下直接<em> redirected</em> 到正确的 redis 节点。</strong></p><p><img data-src="https://gitee.com/bfanfanfan/img/raw/master/docsify/image-20201230134842435.png" alt="image-20201230134842435"></p><h3 id="redis集群介绍"><a class="anchor" href="#redis集群介绍">#</a> Redis 集群介绍</h3><p>Redis 集群是一个提供在<strong>多个 Redis 间节点间共享数据</strong>的程序集。</p><p>Redis 集群并不支持处理多个 keys 的命令，因为这需要在不同的节点间移动数据，从而达不到像 Redis 那样的性能，在高负载的情况下可能会导致不可预料的错误.</p><p>Redis 集群通过分区来提供<strong>一定程度的可用性</strong>，在实际环境中当某个节点宕机或者不可达的情况下继续处理命令. Redis 集群的优势:</p><ul><li>自动分割数据到不同的节点上。</li><li>整个集群的部分节点失败或者不可达的情况下能够继续处理命令。</li></ul><h3 id="redis-集群的数据分片"><a class="anchor" href="#redis-集群的数据分片">#</a> Redis 集群的数据分片</h3><p>Redis 集群没有使用一致性 hash, 而是引入了 <strong>哈希槽</strong>的概念.</p><p>Redis 集群有 16384 个哈希槽，每个 key 通过 CRC16 校验后对 16384 取模来决定放置哪个槽。集群的每个节点负责一部分 hash 槽，举个例子，比如当前集群有 3 个节点，那么:</p><ul><li>节点 A 包含 0 到 5500 号哈希槽.</li><li>节点 B 包含 5501 到 11000 号哈希槽.</li><li>节点 C 包含 11001 到 16384 号哈希槽.</li></ul><p>这种结构很容易添加或者删除节点。比如如果我想新添加个节点 D, 我需要从节点 A, B, C 中得部分槽到 D 上。如果我想移除节点 A, 需要将 A 中的槽移到 B 和 C 节点上，然后将没有任何槽的 A 节点从集群中移除即可。由于从一个节点将哈希槽移动到另一个节点并不会停止服务，所以无论添加删除或者改变某个节点的哈希槽的数量都不会造成集群不可用的状态.</p><h3 id="redis-集群的主从复制模型"><a class="anchor" href="#redis-集群的主从复制模型">#</a> Redis 集群的主从复制模型</h3><p>为了使在部分节点失败或者大部分节点无法通信的情况下集群仍然可用，所以集群使用了主从复制模型，每个节点都会有 N-1 个复制品.</p><p>在我们例子中具有 A，B，C 三个节点的集群，在没有复制模型的情况下，如果节点 B 失败了，那么整个集群就会因为缺少 5501-11000 这个范围的槽而不可用.</p><p>然而如果在集群创建的时候（或者过一段时间）我们为每个节点添加一个从节点 A1，B1，C1, 那么整个集群便有三个 master 节点和三个 slave 节点组成，这样在节点 B 失败后，集群便会选举 B1 为新的主节点继续服务，整个集群便不会因为槽找不到而不可用了，不过当 B 和 B1 都失败后，集群是不可用的。</p><h3 id="redis-一致性保证"><a class="anchor" href="#redis-一致性保证">#</a> Redis 一致性保证</h3><p>Redis 并不能保证数据的<strong>强一致性</strong>。这意味这在实际中集群在特定的条件下可能会丢失写操作.</p><p>第一个原因是因为集群是用了异步复制的写操作过程:</p><ul><li>客户端向主节点 B 写入一条命令.</li><li>主节点 B 向客户端回复命令状态.</li><li>主节点将写操作复制给他的从节点 B1, B2 和 B3.</li></ul><p>主节点对命令的复制工作发生在返回命令回复之后， 因为如果每次处理命令请求都需要等待复制操作完成的话， 那么主节点处理命令请求的速度将极大地降低 —— 我们必须在性能和一致性之间做出权衡。 注意：Redis 集群可能会在将来提供同步写的方法。 Redis 集群另外一种可能会丢失命令的情况是集群出现了网络分区， 并且一个客户端与至少包括一个主节点在内的少数实例被孤立。</p><p>举个例子 假设集群包含 A 、 B 、 C 、 A1 、 B1 、 C1 六个节点， 其中 A 、B 、C 为主节点， A1 、B1 、C1 为 A，B，C 的从节点， 还有一个客户端 Z1 假设集群中发生网络分区，那么集群可能会分为两方，大部分的一方包含节点 A 、C 、A1 、B1 和 C1 ，小部分的一方则包含节点 B 和客户端 Z1 。</p><p>Z1 仍然能够向主节点 B 中写入，如果网络分区发生时间较短，那么集群将会继续正常运作，如果分区的时间足够让大部分的一方将 B1 选举为新的 master，那么 Z1 写入 B 中得数据便丢失了。</p><p>注意， 在网络分裂出现期间， 客户端 Z1 可以向主节点 B 发送写命令的最大时间是有限制的， 这一时间限制称为节点超时时间（node timeout）， 是 Redis 集群的一个重要的配置选项。</p><h3 id="redis集群搭建"><a class="anchor" href="#redis集群搭建">#</a> redis 集群搭建</h3><p>搭建集群的第一件事情我们需要一些运行在 集群模式的 Redis 实例。这意味这集群并不是由一些普通的 Redis 实例组成的，集群模式需要通过配置启用，开启集群模式后的 Redis 实例便可以使用集群特有的命令和特性了。</p><p>搭建方式可以参考 redis 安装目录下的一个说明文件</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost create-cluster<span class="token punctuation">]</span><span class="token comment"># pwd</span></pre></td></tr><tr><td data-num="2"></td><td><pre>/usr/local/redis-6.0.6/utils/create-cluster</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@localhost create-cluster<span class="token punctuation">]</span><span class="token comment"># vim README </span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>Create-custer is a small script used to easily start a big number of Redis</pre></td></tr><tr><td data-num="6"></td><td><pre>instances configured to run <span class="token keyword">in</span> cluster mode. Its main goal is to allow manual</pre></td></tr><tr><td data-num="7"></td><td><pre>testing <span class="token keyword">in</span> a condition <span class="token function">which</span> is not easy to replicate with the Redis cluster</pre></td></tr><tr><td data-num="8"></td><td><pre>unit tests, <span class="token keyword">for</span> example when a lot of instances are needed <span class="token keyword">in</span> order to trigger</pre></td></tr><tr><td data-num="9"></td><td><pre>a given bug.</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>The tool can also be used just to easily create a number of instances <span class="token keyword">in</span> a</pre></td></tr><tr><td data-num="12"></td><td><pre>Redis Cluster <span class="token keyword">in</span> order to experiment a bit with the system.</pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>USAGE</pre></td></tr><tr><td data-num="15"></td><td><pre>---</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>To create a cluster, follow these steps:</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token number">1</span>. Edit create-cluster and change the start / end port, depending on the</pre></td></tr><tr><td data-num="20"></td><td><pre>number of instances you want to create.</pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token number">2</span>. Use <span class="token string">"./create-cluster start"</span> <span class="token keyword">in</span> order to run the instances.</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token number">3</span>. Use <span class="token string">"./create-cluster create"</span> <span class="token keyword">in</span> order to execute redis-cli --cluster create, so that</pre></td></tr><tr><td data-num="23"></td><td><pre>an actual Redis cluster will be created. <span class="token punctuation">(</span>If you're accessing your setup via a <span class="token builtin class-name">local</span> container, ensure that the CLUSTER_HOST value is changed to your <span class="token builtin class-name">local</span> IP<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token number">4</span>. Now you are ready to play with the cluster. AOF files and logs <span class="token keyword">for</span> each instances are created <span class="token keyword">in</span> the current directory.</pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>In order to stop a cluster:</pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token number">1</span>. Use <span class="token string">"./create-cluster stop"</span> to stop all the instances. After you stopped the instances you can use <span class="token string">"./create-cluster start"</span> to restart them <span class="token keyword">if</span> you change your mind.</pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token number">2</span>. Use <span class="token string">"./create-cluster clean"</span> to remove all the AOF / log files to restart with a clean environment.</pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>Use the <span class="token builtin class-name">command</span> <span class="token string">"./create-cluster help"</span> to get the full list of features.</pre></td></tr></table></figure><p>查看集群脚本 create-cluster（这里用默认的配置，不用更改）</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost create-cluster<span class="token punctuation">]</span><span class="token comment"># vim create-cluster </span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#!/bin/bash</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># Settings</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token assign-left variable">BIN_PATH</span><span class="token operator">=</span><span class="token string">"../../src/"</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token assign-left variable">CLUSTER_HOST</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token number">30000</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token assign-left variable">TIMEOUT</span><span class="token operator">=</span><span class="token number">2000</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token assign-left variable">NODES</span><span class="token operator">=</span><span class="token number">6</span> <span class="token comment">#6 个 redis 节点实例</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token assign-left variable">REPLICAS</span><span class="token operator">=</span><span class="token number">1</span> <span class="token comment">#6/（1+1）=3，代表三个主机节点实例，三个从机节点实例</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token assign-left variable">PROTECTED_MODE</span><span class="token operator">=</span>yes</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token assign-left variable">ADDITIONAL_OPTIONS</span><span class="token operator">=</span><span class="token string">""</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr></table></figure><p>执行 create-cluster 相关命令启动 redis 实例以及进行槽位分配、主从分配（命令可以参照 README 文件）</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost create-cluster<span class="token punctuation">]</span><span class="token comment"># ./create-cluster start   #启动 redis 节点实例，节点个数在 create-cluster 脚本中配置</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Starting <span class="token number">30001</span></pre></td></tr><tr><td data-num="3"></td><td><pre>Starting <span class="token number">30002</span></pre></td></tr><tr><td data-num="4"></td><td><pre>Starting <span class="token number">30003</span></pre></td></tr><tr><td data-num="5"></td><td><pre>Starting <span class="token number">30004</span></pre></td></tr><tr><td data-num="6"></td><td><pre>Starting <span class="token number">30005</span></pre></td></tr><tr><td data-num="7"></td><td><pre>Starting <span class="token number">30006</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@localhost create-cluster<span class="token punctuation">]</span><span class="token comment"># ./create-cluster create  #给 redis 节点分配槽位以及主从</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> Performing <span class="token builtin class-name">hash</span> slots allocation on <span class="token number">6</span> nodes<span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="10"></td><td><pre>Master<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> -<span class="token operator">></span> Slots <span class="token number">0</span> - <span class="token number">5460</span>  <span class="token comment">#第一个 redis 主节点分配 0-5460 哈希槽位，总共 16384 个槽位</span></pre></td></tr><tr><td data-num="11"></td><td><pre>Master<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> -<span class="token operator">></span> Slots <span class="token number">5461</span> - <span class="token number">10922</span></pre></td></tr><tr><td data-num="12"></td><td><pre>Master<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> -<span class="token operator">></span> Slots <span class="token number">10923</span> - <span class="token number">16383</span></pre></td></tr><tr><td data-num="13"></td><td><pre>Adding replica <span class="token number">127.0</span>.0.1:30005 to <span class="token number">127.0</span>.0.1:30001 <span class="token comment"># 主机点为 30001、30002、30003，从机节点为其余三个节点</span></pre></td></tr><tr><td data-num="14"></td><td><pre>Adding replica <span class="token number">127.0</span>.0.1:30006 to <span class="token number">127.0</span>.0.1:30002</pre></td></tr><tr><td data-num="15"></td><td><pre>Adding replica <span class="token number">127.0</span>.0.1:30004 to <span class="token number">127.0</span>.0.1:30003</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> Trying to optimize slaves allocation <span class="token keyword">for</span> anti-affinity</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> Some slaves are <span class="token keyword">in</span> the same <span class="token function">host</span> as their master</pre></td></tr><tr><td data-num="18"></td><td><pre>M: 142648077a095759905ff10b1fda60db81542873 <span class="token number">127.0</span>.0.1:30001</pre></td></tr><tr><td data-num="19"></td><td><pre>   slots:<span class="token punctuation">[</span><span class="token number">0</span>-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master</pre></td></tr><tr><td data-num="20"></td><td><pre>M: ca7aaca12bc9a56d7019fd0c92c5e1cf52770e1a <span class="token number">127.0</span>.0.1:30002</pre></td></tr><tr><td data-num="21"></td><td><pre>   slots:<span class="token punctuation">[</span><span class="token number">5461</span>-10922<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5462</span> slots<span class="token punctuation">)</span> master</pre></td></tr><tr><td data-num="22"></td><td><pre>M: bfe8bc70cfa76a5109d9d92b224318fad947e058 <span class="token number">127.0</span>.0.1:30003</pre></td></tr><tr><td data-num="23"></td><td><pre>   slots:<span class="token punctuation">[</span><span class="token number">10923</span>-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master</pre></td></tr><tr><td data-num="24"></td><td><pre>S: 4b510e388019132010db80d5c30ccfe993dc107d <span class="token number">127.0</span>.0.1:30004</pre></td></tr><tr><td data-num="25"></td><td><pre>   replicates bfe8bc70cfa76a5109d9d92b224318fad947e058</pre></td></tr><tr><td data-num="26"></td><td><pre>S: c0ba44240a0fa4691ad60a8efa01a22715bf745e <span class="token number">127.0</span>.0.1:30005</pre></td></tr><tr><td data-num="27"></td><td><pre>   replicates 142648077a095759905ff10b1fda60db81542873</pre></td></tr><tr><td data-num="28"></td><td><pre>S: 7062fa1374e70b12704df087f6d8680c81f00539 <span class="token number">127.0</span>.0.1:30006</pre></td></tr><tr><td data-num="29"></td><td><pre>   replicates ca7aaca12bc9a56d7019fd0c92c5e1cf52770e1a</pre></td></tr><tr><td data-num="30"></td><td><pre>Can I <span class="token builtin class-name">set</span> the above configuration? <span class="token punctuation">(</span>type <span class="token string">'yes'</span> to accept<span class="token punctuation">)</span>: <span class="token function">yes</span> <span class="token comment">#输入 yes 后回车</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> Nodes configuration updated</pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> Assign a different config epoch to each node</pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> Sending CLUSTER MEET messages to <span class="token function">join</span> the cluster</pre></td></tr><tr><td data-num="34"></td><td><pre>Waiting <span class="token keyword">for</span> the cluster to <span class="token function">join</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> Performing Cluster Check <span class="token punctuation">(</span>using node <span class="token number">127.0</span>.0.1:30001<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>M: 142648077a095759905ff10b1fda60db81542873 <span class="token number">127.0</span>.0.1:30001</pre></td></tr><tr><td data-num="38"></td><td><pre>   slots:<span class="token punctuation">[</span><span class="token number">0</span>-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master</pre></td></tr><tr><td data-num="39"></td><td><pre>   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>M: ca7aaca12bc9a56d7019fd0c92c5e1cf52770e1a <span class="token number">127.0</span>.0.1:30002</pre></td></tr><tr><td data-num="41"></td><td><pre>   slots:<span class="token punctuation">[</span><span class="token number">5461</span>-10922<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5462</span> slots<span class="token punctuation">)</span> master</pre></td></tr><tr><td data-num="42"></td><td><pre>   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>M: bfe8bc70cfa76a5109d9d92b224318fad947e058 <span class="token number">127.0</span>.0.1:30003</pre></td></tr><tr><td data-num="44"></td><td><pre>   slots:<span class="token punctuation">[</span><span class="token number">10923</span>-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master</pre></td></tr><tr><td data-num="45"></td><td><pre>   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>S: c0ba44240a0fa4691ad60a8efa01a22715bf745e <span class="token number">127.0</span>.0.1:30005</pre></td></tr><tr><td data-num="47"></td><td><pre>   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave</pre></td></tr><tr><td data-num="48"></td><td><pre>   replicates 142648077a095759905ff10b1fda60db81542873</pre></td></tr><tr><td data-num="49"></td><td><pre>S: 7062fa1374e70b12704df087f6d8680c81f00539 <span class="token number">127.0</span>.0.1:30006</pre></td></tr><tr><td data-num="50"></td><td><pre>   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave</pre></td></tr><tr><td data-num="51"></td><td><pre>   replicates ca7aaca12bc9a56d7019fd0c92c5e1cf52770e1a</pre></td></tr><tr><td data-num="52"></td><td><pre>S: 4b510e388019132010db80d5c30ccfe993dc107d <span class="token number">127.0</span>.0.1:30004</pre></td></tr><tr><td data-num="53"></td><td><pre>   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave</pre></td></tr><tr><td data-num="54"></td><td><pre>   replicates bfe8bc70cfa76a5109d9d92b224318fad947e058</pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All nodes agree about slots configuration.</pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> Check <span class="token keyword">for</span> <span class="token function">open</span> slots<span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> Check slots coverage<span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All <span class="token number">16384</span> slots covered.</pre></td></tr></table></figure><p>窗口一：启动一个主节点测试</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -c -p 30001</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">127.0</span>.0.1:3000<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token builtin class-name">set</span> k1 aaa</pre></td></tr><tr><td data-num="3"></td><td><pre>-<span class="token operator">></span> Redirected to slot <span class="token punctuation">[</span><span class="token number">12706</span><span class="token punctuation">]</span> located at <span class="token number">127.0</span>.0.1:30003  <span class="token comment">#key 通过 CRC16 哈希算法后对 16384 取模的结果落在了 12706 槽位，所以会自动跳转到 12706 槽位所在的主机 30003 去存储 key</span></pre></td></tr><tr><td data-num="4"></td><td><pre>OK</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">127.0</span>.0.1:3000<span class="token operator"><span class="token file-descriptor important">3</span>></span></pre></td></tr></table></figure><p>redis 的自带的集群对于事务的操作要格外小心，否则就会报错</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -c -p 30001</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">127.0</span>.0.1:3000<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token builtin class-name">set</span> k1 aaa</pre></td></tr><tr><td data-num="3"></td><td><pre>-<span class="token operator">></span> Redirected to slot <span class="token punctuation">[</span><span class="token number">12706</span><span class="token punctuation">]</span> located at <span class="token number">127.0</span>.0.1:30003</pre></td></tr><tr><td data-num="4"></td><td><pre>OK</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">127.0</span>.0.1:3000<span class="token operator"><span class="token file-descriptor important">3</span>></span> <span class="token builtin class-name">set</span> k2 bbb</pre></td></tr><tr><td data-num="6"></td><td><pre>-<span class="token operator">></span> Redirected to slot <span class="token punctuation">[</span><span class="token number">449</span><span class="token punctuation">]</span> located at <span class="token number">127.0</span>.0.1:30001</pre></td></tr><tr><td data-num="7"></td><td><pre>OK</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">127.0</span>.0.1:3000<span class="token operator"><span class="token file-descriptor important">1</span>></span> WATCH k1 <span class="token comment">#主机 30001 上开启了 WATCH</span></pre></td></tr><tr><td data-num="9"></td><td><pre>-<span class="token operator">></span> Redirected to slot <span class="token punctuation">[</span><span class="token number">12706</span><span class="token punctuation">]</span> located at <span class="token number">127.0</span>.0.1:30003</pre></td></tr><tr><td data-num="10"></td><td><pre>OK</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">127.0</span>.0.1:3000<span class="token operator"><span class="token file-descriptor important">3</span>></span> get k2</pre></td></tr><tr><td data-num="12"></td><td><pre>-<span class="token operator">></span> Redirected to slot <span class="token punctuation">[</span><span class="token number">449</span><span class="token punctuation">]</span> located at <span class="token number">127.0</span>.0.1:30001</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token string">"bbb"</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token number">127.0</span>.0.1:3000<span class="token operator"><span class="token file-descriptor important">1</span>></span> MULTI <span class="token comment">#主机 30001 上开启了事务</span></pre></td></tr><tr><td data-num="15"></td><td><pre>OK</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token number">127.0</span>.0.1:3000<span class="token operator"><span class="token file-descriptor important">1</span>></span> get k2</pre></td></tr><tr><td data-num="17"></td><td><pre>QUEUED</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token number">127.0</span>.0.1:3000<span class="token operator"><span class="token file-descriptor important">1</span>></span> get k1</pre></td></tr><tr><td data-num="19"></td><td><pre>-<span class="token operator">></span> Redirected to slot <span class="token punctuation">[</span><span class="token number">12706</span><span class="token punctuation">]</span> located at <span class="token number">127.0</span>.0.1:30003</pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token string">"aaa"</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token number">127.0</span>.0.1:3000<span class="token operator"><span class="token file-descriptor important">3</span>></span> EXEC  <span class="token comment">#主机 30003 上执行事务就会报错，因为事务是在主机 30001 上开启的，主机 30003 上不存在事务</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">(</span>error<span class="token punctuation">)</span> ERR EXEC without MULTI</pre></td></tr></table></figure><p>事务解决的办法就是，给 key 加一个统一的前缀，这样 key 通过哈希算法后就会被分配到同一个 redis 实例中，在同一个 redis 实例中进行事务操作就不会有以上的错误</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:3000<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token builtin class-name">set</span> <span class="token punctuation">&#123;</span>oo<span class="token punctuation">&#125;</span>k1 aaa <span class="token comment">#给所有 key 加一个前缀 &#123;oo&#125;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>OK</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">127.0</span>.0.1:3000<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token builtin class-name">set</span> <span class="token punctuation">&#123;</span>oo<span class="token punctuation">&#125;</span>k2 bbb</pre></td></tr><tr><td data-num="4"></td><td><pre>OK</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">127.0</span>.0.1:3000<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token builtin class-name">set</span> <span class="token punctuation">&#123;</span>oo<span class="token punctuation">&#125;</span>k3 ccc</pre></td></tr><tr><td data-num="6"></td><td><pre>OK</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">127.0</span>.0.1:3000<span class="token operator"><span class="token file-descriptor important">1</span>></span> WATCH <span class="token punctuation">&#123;</span>oo<span class="token punctuation">&#125;</span>k1</pre></td></tr><tr><td data-num="8"></td><td><pre>OK</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">127.0</span>.0.1:3000<span class="token operator"><span class="token file-descriptor important">1</span>></span> MULTI</pre></td></tr><tr><td data-num="10"></td><td><pre>OK</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">127.0</span>.0.1:3000<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token builtin class-name">set</span> <span class="token punctuation">&#123;</span>oo<span class="token punctuation">&#125;</span>k2 bbbbbb</pre></td></tr><tr><td data-num="12"></td><td><pre>QUEUED</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">127.0</span>.0.1:3000<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token builtin class-name">set</span> <span class="token punctuation">&#123;</span>oo<span class="token punctuation">&#125;</span>k3 cccccc</pre></td></tr><tr><td data-num="14"></td><td><pre>QUEUED</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token number">127.0</span>.0.1:3000<span class="token operator"><span class="token file-descriptor important">1</span>></span> get <span class="token punctuation">&#123;</span>oo<span class="token punctuation">&#125;</span>k2</pre></td></tr><tr><td data-num="16"></td><td><pre>QUEUED</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token number">127.0</span>.0.1:3000<span class="token operator"><span class="token file-descriptor important">1</span>></span> get <span class="token punctuation">&#123;</span>oo<span class="token punctuation">&#125;</span>k3</pre></td></tr><tr><td data-num="18"></td><td><pre>QUEUED</pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token number">127.0</span>.0.1:3000<span class="token operator"><span class="token file-descriptor important">1</span>></span> EXEC</pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token number">1</span><span class="token punctuation">)</span> OK</pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token number">2</span><span class="token punctuation">)</span> OK</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"bbbbbb"</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"cccccc"</span></pre></td></tr></table></figure><p>所有的数据以及日志都在 create-cluster 脚本所在的目录下</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost create-cluster<span class="token punctuation">]</span><span class="token comment"># pwd</span></pre></td></tr><tr><td data-num="2"></td><td><pre>/usr/local/redis-6.0.6/utils/create-cluster</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@localhost create-cluster<span class="token punctuation">]</span><span class="token comment"># ll</span></pre></td></tr><tr><td data-num="4"></td><td><pre>总用量 <span class="token number">104</span></pre></td></tr><tr><td data-num="5"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">2716</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">22</span>:50 <span class="token number">30001</span>.log</pre></td></tr><tr><td data-num="6"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">2716</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">22</span>:50 <span class="token number">30002</span>.log</pre></td></tr><tr><td data-num="7"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">2716</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">22</span>:50 <span class="token number">30003</span>.log</pre></td></tr><tr><td data-num="8"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">3858</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">22</span>:50 <span class="token number">30004</span>.log</pre></td></tr><tr><td data-num="9"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">3858</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">22</span>:50 <span class="token number">30005</span>.log</pre></td></tr><tr><td data-num="10"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root <span class="token number">3858</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">22</span>:50 <span class="token number">30006</span>.log</pre></td></tr><tr><td data-num="11"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">397</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">23</span>:20 appendonly-30001.aof</pre></td></tr><tr><td data-num="12"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root   <span class="token number">97</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">23</span>:18 appendonly-30002.aof</pre></td></tr><tr><td data-num="13"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root   <span class="token number">53</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">23</span>:02 appendonly-30003.aof</pre></td></tr><tr><td data-num="14"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">145</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">23</span>:02 appendonly-30004.aof</pre></td></tr><tr><td data-num="15"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">489</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">23</span>:20 appendonly-30005.aof</pre></td></tr><tr><td data-num="16"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">189</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">23</span>:18 appendonly-30006.aof</pre></td></tr><tr><td data-num="17"></td><td><pre>-rwxrwxr-x. <span class="token number">1</span> root root <span class="token number">2694</span> <span class="token number">7</span>月  <span class="token number">21</span> 02:08 create-cluster</pre></td></tr><tr><td data-num="18"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">175</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">22</span>:50 dump-30001.rdb</pre></td></tr><tr><td data-num="19"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">175</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">22</span>:50 dump-30002.rdb</pre></td></tr><tr><td data-num="20"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">175</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">22</span>:50 dump-30003.rdb</pre></td></tr><tr><td data-num="21"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">175</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">22</span>:50 dump-30004.rdb</pre></td></tr><tr><td data-num="22"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">175</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">22</span>:50 dump-30005.rdb</pre></td></tr><tr><td data-num="23"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">175</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">22</span>:50 dump-30006.rdb</pre></td></tr><tr><td data-num="24"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">787</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">22</span>:50 nodes-30001.conf</pre></td></tr><tr><td data-num="25"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">787</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">22</span>:50 nodes-30002.conf</pre></td></tr><tr><td data-num="26"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">787</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">22</span>:50 nodes-30003.conf</pre></td></tr><tr><td data-num="27"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">787</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">22</span>:50 nodes-30004.conf</pre></td></tr><tr><td data-num="28"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">787</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">22</span>:50 nodes-30005.conf</pre></td></tr><tr><td data-num="29"></td><td><pre>-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">787</span> <span class="token number">12</span>月 <span class="token number">31</span> <span class="token number">22</span>:50 nodes-30006.conf</pre></td></tr><tr><td data-num="30"></td><td><pre>-rw-rw-r--. <span class="token number">1</span> root root <span class="token number">1436</span> <span class="token number">7</span>月  <span class="token number">21</span> 02:08 README</pre></td></tr></table></figure><p>停止集群服务并清空数据以及日志</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost create-cluster<span class="token punctuation">]</span><span class="token comment"># ./create-cluster stop</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Stopping <span class="token number">30001</span></pre></td></tr><tr><td data-num="3"></td><td><pre>Stopping <span class="token number">30002</span></pre></td></tr><tr><td data-num="4"></td><td><pre>Stopping <span class="token number">30003</span></pre></td></tr><tr><td data-num="5"></td><td><pre>Stopping <span class="token number">30004</span></pre></td></tr><tr><td data-num="6"></td><td><pre>Stopping <span class="token number">30005</span></pre></td></tr><tr><td data-num="7"></td><td><pre>Stopping <span class="token number">30006</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@localhost create-cluster<span class="token punctuation">]</span><span class="token comment"># ./create-cluster clean  #清空日志和数据，谨慎操作！！！</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">[</span>root@localhost create-cluster<span class="token punctuation">]</span><span class="token comment"># ll</span></pre></td></tr><tr><td data-num="10"></td><td><pre>总用量 <span class="token number">8</span></pre></td></tr><tr><td data-num="11"></td><td><pre>-rwxrwxr-x. <span class="token number">1</span> root root <span class="token number">2694</span> <span class="token number">7</span>月  <span class="token number">21</span> 02:08 create-cluster</pre></td></tr><tr><td data-num="12"></td><td><pre>-rw-rw-r--. <span class="token number">1</span> root root <span class="token number">1436</span> <span class="token number">7</span>月  <span class="token number">21</span> 02:08 README</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">[</span>root@localhost create-cluster<span class="token punctuation">]</span><span class="token comment">#</span></pre></td></tr></table></figure><p>此外，使用命令 <code>create-cluster create</code> 给分配实例槽位以及集群时，只能指定一台机器（同一个 IP）上分配 n 个 redis 实例，这样做不到正真意义上的分布式 redis 集群。所以，可以使用命令 <code>redis-cli --cluster create host1:port1 ... hostN:portN --cluster-replicas &lt;arg&gt;</code> 来指定多台机器（不同 IP）上创建 redis 实例，做到真正的分布式的 redis 集群。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost create-cluster<span class="token punctuation">]</span><span class="token comment"># redis-cli --cluster help</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Cluster Manager Commands:</pre></td></tr><tr><td data-num="3"></td><td><pre>  create         host1:port1 <span class="token punctuation">..</span>. hostN:portN</pre></td></tr><tr><td data-num="4"></td><td><pre>                 --cluster-replicas <span class="token operator">&lt;</span>arg<span class="token operator">></span></pre></td></tr><tr><td data-num="5"></td><td><pre>  check          host:port</pre></td></tr><tr><td data-num="6"></td><td><pre>                 --cluster-search-multiple-owners</pre></td></tr><tr><td data-num="7"></td><td><pre>  info           host:port</pre></td></tr><tr><td data-num="8"></td><td><pre>  fix            host:port</pre></td></tr><tr><td data-num="9"></td><td><pre>                 --cluster-search-multiple-owners</pre></td></tr><tr><td data-num="10"></td><td><pre>                 --cluster-fix-with-unreachable-masters</pre></td></tr><tr><td data-num="11"></td><td><pre>  reshard        host:port</pre></td></tr><tr><td data-num="12"></td><td><pre>                 --cluster-from <span class="token operator">&lt;</span>arg<span class="token operator">></span></pre></td></tr><tr><td data-num="13"></td><td><pre>                 --cluster-to <span class="token operator">&lt;</span>arg<span class="token operator">></span></pre></td></tr><tr><td data-num="14"></td><td><pre>                 --cluster-slots <span class="token operator">&lt;</span>arg<span class="token operator">></span></pre></td></tr><tr><td data-num="15"></td><td><pre>                 --cluster-yes</pre></td></tr><tr><td data-num="16"></td><td><pre>                 --cluster-timeout <span class="token operator">&lt;</span>arg<span class="token operator">></span></pre></td></tr><tr><td data-num="17"></td><td><pre>                 --cluster-pipeline <span class="token operator">&lt;</span>arg<span class="token operator">></span></pre></td></tr><tr><td data-num="18"></td><td><pre>                 --cluster-replace</pre></td></tr><tr><td data-num="19"></td><td><pre>  rebalance      host:port</pre></td></tr><tr><td data-num="20"></td><td><pre>                 --cluster-weight <span class="token operator">&lt;</span>node1<span class="token operator">=</span>w1<span class="token punctuation">..</span>.nodeN<span class="token operator">=</span>wN<span class="token operator">></span></pre></td></tr><tr><td data-num="21"></td><td><pre>                 --cluster-use-empty-masters</pre></td></tr><tr><td data-num="22"></td><td><pre>                 --cluster-timeout <span class="token operator">&lt;</span>arg<span class="token operator">></span></pre></td></tr><tr><td data-num="23"></td><td><pre>                 --cluster-simulate</pre></td></tr><tr><td data-num="24"></td><td><pre>                 --cluster-pipeline <span class="token operator">&lt;</span>arg<span class="token operator">></span></pre></td></tr><tr><td data-num="25"></td><td><pre>                 --cluster-threshold <span class="token operator">&lt;</span>arg<span class="token operator">></span></pre></td></tr><tr><td data-num="26"></td><td><pre>                 --cluster-replace</pre></td></tr><tr><td data-num="27"></td><td><pre>  add-node       new_host:new_port existing_host:existing_port</pre></td></tr><tr><td data-num="28"></td><td><pre>                 --cluster-slave</pre></td></tr><tr><td data-num="29"></td><td><pre>                 --cluster-master-id <span class="token operator">&lt;</span>arg<span class="token operator">></span></pre></td></tr><tr><td data-num="30"></td><td><pre>  del-node       host:port node_id</pre></td></tr><tr><td data-num="31"></td><td><pre>  call           host:port <span class="token builtin class-name">command</span> arg arg <span class="token punctuation">..</span> arg</pre></td></tr><tr><td data-num="32"></td><td><pre>  set-timeout    host:port milliseconds</pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token function">import</span>         host:port</pre></td></tr><tr><td data-num="34"></td><td><pre>                 --cluster-from <span class="token operator">&lt;</span>arg<span class="token operator">></span></pre></td></tr><tr><td data-num="35"></td><td><pre>                 --cluster-copy</pre></td></tr><tr><td data-num="36"></td><td><pre>                 --cluster-replace</pre></td></tr><tr><td data-num="37"></td><td><pre>  backup         host:port backup_directory</pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token builtin class-name">help</span>           </pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>For check, fix, reshard, del-node, set-timeout you can specify the <span class="token function">host</span> and port of any working node <span class="token keyword">in</span> the cluster.</pre></td></tr></table></figure><p>例如：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost create-cluster<span class="token punctuation">]</span><span class="token comment"># ./create-cluster start</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Starting <span class="token number">30001</span></pre></td></tr><tr><td data-num="3"></td><td><pre>Starting <span class="token number">30002</span></pre></td></tr><tr><td data-num="4"></td><td><pre>Starting <span class="token number">30003</span></pre></td></tr><tr><td data-num="5"></td><td><pre>Starting <span class="token number">30004</span></pre></td></tr><tr><td data-num="6"></td><td><pre>Starting <span class="token number">30005</span></pre></td></tr><tr><td data-num="7"></td><td><pre>Starting <span class="token number">30006</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">[</span>root@localhost create-cluster<span class="token punctuation">]</span><span class="token comment"># redis-cli --cluster create 127.0.0.1:30001 127.0.0.1:30002 127.0.0.1:30003 127.0.0.1:30004 127.0.0.1:30005 127.0.0.1:30006 --cluster-replicas 1</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> Performing <span class="token builtin class-name">hash</span> slots allocation on <span class="token number">6</span> nodes<span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="10"></td><td><pre>Master<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> -<span class="token operator">></span> Slots <span class="token number">0</span> - <span class="token number">5460</span></pre></td></tr><tr><td data-num="11"></td><td><pre>Master<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> -<span class="token operator">></span> Slots <span class="token number">5461</span> - <span class="token number">10922</span></pre></td></tr><tr><td data-num="12"></td><td><pre>Master<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> -<span class="token operator">></span> Slots <span class="token number">10923</span> - <span class="token number">16383</span></pre></td></tr><tr><td data-num="13"></td><td><pre>Adding replica <span class="token number">127.0</span>.0.1:30005 to <span class="token number">127.0</span>.0.1:30001</pre></td></tr><tr><td data-num="14"></td><td><pre>Adding replica <span class="token number">127.0</span>.0.1:30006 to <span class="token number">127.0</span>.0.1:30002</pre></td></tr><tr><td data-num="15"></td><td><pre>Adding replica <span class="token number">127.0</span>.0.1:30004 to <span class="token number">127.0</span>.0.1:30003</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> Trying to optimize slaves allocation <span class="token keyword">for</span> anti-affinity</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> Some slaves are <span class="token keyword">in</span> the same <span class="token function">host</span> as their master</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr></table></figure><h4 id="槽位移动"><a class="anchor" href="#槽位移动">#</a> 槽位移动</h4><p>一个 redis 节点中的槽位可以移动到另一个 redis 节点中去，同时也意味着槽位中数据的移动。注意：参与槽位移动的节点只能是主节点</p><p>例如：从节点 30001 移动 50 个槽位到节点 30003</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost create-cluster<span class="token punctuation">]</span><span class="token comment"># redis-cli --cluster reshard 127.0.0.1:30001 #随意指定一对主节点 ip 和端口</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> Performing Cluster Check <span class="token punctuation">(</span>using node <span class="token number">127.0</span>.0.1:30001<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>M: d5ee7b57f7a0085b50b898897b6fb013b57fe371 <span class="token number">127.0</span>.0.1:30001</pre></td></tr><tr><td data-num="4"></td><td><pre>   slots:<span class="token punctuation">[</span><span class="token number">0</span>-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master</pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>S: 88ab8ec4a6c2be465728e5a04023692a6dba3eec <span class="token number">127.0</span>.0.1:30004</pre></td></tr><tr><td data-num="7"></td><td><pre>   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave</pre></td></tr><tr><td data-num="8"></td><td><pre>   replicates d987876627c455db85b04bbf2e3f3b67a5e5dae0</pre></td></tr><tr><td data-num="9"></td><td><pre>S: 575e9a4f4628dd7659774f5b7387e7f479922e6b <span class="token number">127.0</span>.0.1:30006</pre></td></tr><tr><td data-num="10"></td><td><pre>   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave</pre></td></tr><tr><td data-num="11"></td><td><pre>   replicates 4ada6d29ab60c65288edfa5aaebb3c946cb59e8b</pre></td></tr><tr><td data-num="12"></td><td><pre>M: d987876627c455db85b04bbf2e3f3b67a5e5dae0 <span class="token number">127.0</span>.0.1:30003</pre></td></tr><tr><td data-num="13"></td><td><pre>   slots:<span class="token punctuation">[</span><span class="token number">10923</span>-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master</pre></td></tr><tr><td data-num="14"></td><td><pre>   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>M: 4ada6d29ab60c65288edfa5aaebb3c946cb59e8b <span class="token number">127.0</span>.0.1:30002</pre></td></tr><tr><td data-num="16"></td><td><pre>   slots:<span class="token punctuation">[</span><span class="token number">5461</span>-10922<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5462</span> slots<span class="token punctuation">)</span> master</pre></td></tr><tr><td data-num="17"></td><td><pre>   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>S: b5771aacd79fbfe0c4c4f4d898c6e8ef0e83beca <span class="token number">127.0</span>.0.1:30005</pre></td></tr><tr><td data-num="19"></td><td><pre>   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave</pre></td></tr><tr><td data-num="20"></td><td><pre>   replicates d5ee7b57f7a0085b50b898897b6fb013b57fe371</pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All nodes agree about slots configuration.</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> Check <span class="token keyword">for</span> <span class="token function">open</span> slots<span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> Check slots coverage<span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All <span class="token number">16384</span> slots covered.</pre></td></tr><tr><td data-num="25"></td><td><pre>How many slots <span class="token keyword">do</span> you want to move <span class="token punctuation">(</span>from <span class="token number">1</span> to <span class="token number">16384</span><span class="token punctuation">)</span>? <span class="token number">50</span> <span class="token comment">#要移动的槽位个数</span></pre></td></tr><tr><td data-num="26"></td><td><pre>What is the receiving node ID? d987876627c455db85b04bbf2e3f3b67a5e5dae0 <span class="token comment">#要移动到目标节点的 ID，节点 ID 就是上一步中打印出的 M 后面的一长串 ID</span></pre></td></tr><tr><td data-num="27"></td><td><pre>Please enter all the <span class="token builtin class-name">source</span> node IDs. <span class="token comment">#选择要从哪个主节点中去拿取槽位，all 表示从所有主节点中总共拿取指定的槽位数，否则指定主节点的 ID</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  Type <span class="token string">'all'</span> to use all the nodes as <span class="token builtin class-name">source</span> nodes <span class="token keyword">for</span> the <span class="token builtin class-name">hash</span> slots.</pre></td></tr><tr><td data-num="29"></td><td><pre>  Type <span class="token string">'done'</span> once you entered all the <span class="token builtin class-name">source</span> nodes IDs. </pre></td></tr><tr><td data-num="30"></td><td><pre>Source node <span class="token comment">#1: d5ee7b57f7a0085b50b898897b6fb013b57fe371 #这里从主节点 30001 拿取指定的槽位数</span></pre></td></tr><tr><td data-num="31"></td><td><pre>Source node <span class="token comment">#2: done #不在从其他主节点中拿取槽位，键入 done 后回车</span></pre></td></tr><tr><td data-num="32"></td><td><pre>Ready to move <span class="token number">50</span> slots.</pre></td></tr><tr><td data-num="33"></td><td><pre>  Source nodes:</pre></td></tr><tr><td data-num="34"></td><td><pre>    M: d5ee7b57f7a0085b50b898897b6fb013b57fe371 <span class="token number">127.0</span>.0.1:30001</pre></td></tr><tr><td data-num="35"></td><td><pre>       slots:<span class="token punctuation">[</span><span class="token number">0</span>-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master</pre></td></tr><tr><td data-num="36"></td><td><pre>       <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  Destination node:</pre></td></tr><tr><td data-num="38"></td><td><pre>    M: d987876627c455db85b04bbf2e3f3b67a5e5dae0 <span class="token number">127.0</span>.0.1:30003</pre></td></tr><tr><td data-num="39"></td><td><pre>       slots:<span class="token punctuation">[</span><span class="token number">10923</span>-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master</pre></td></tr><tr><td data-num="40"></td><td><pre>       <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  Resharding plan:</pre></td></tr><tr><td data-num="42"></td><td><pre>    Moving slot <span class="token number">0</span> from d5ee7b57f7a0085b50b898897b6fb013b57fe371</pre></td></tr><tr><td data-num="43"></td><td><pre>    Moving slot <span class="token number">1</span> from d5ee7b57f7a0085b50b898897b6fb013b57fe371</pre></td></tr><tr><td data-num="44"></td><td><pre>    Moving slot <span class="token number">2</span> from d5ee7b57f7a0085b50b898897b6fb013b57fe371</pre></td></tr><tr><td data-num="45"></td><td><pre>    Moving slot <span class="token number">3</span> from d5ee7b57f7a0085b50b898897b6fb013b57fe371</pre></td></tr><tr><td data-num="46"></td><td><pre>    Moving slot <span class="token number">4</span> from d5ee7b57f7a0085b50b898897b6fb013b57fe371</pre></td></tr><tr><td data-num="47"></td><td><pre>    Moving slot <span class="token number">5</span> from d5ee7b57f7a0085b50b898897b6fb013b57fe371</pre></td></tr><tr><td data-num="48"></td><td><pre>    Moving slot <span class="token number">6</span> from d5ee7b57f7a0085b50b898897b6fb013b57fe371</pre></td></tr><tr><td data-num="49"></td><td><pre>    Moving slot <span class="token number">7</span> from d5ee7b57f7a0085b50b898897b6fb013b57fe371</pre></td></tr><tr><td data-num="50"></td><td><pre>    Moving slot <span class="token number">8</span> from d5ee7b57f7a0085b50b898897b6fb013b57fe371</pre></td></tr><tr><td data-num="51"></td><td><pre>    Moving slot <span class="token number">9</span> from d5ee7b57f7a0085b50b898897b6fb013b57fe371</pre></td></tr><tr><td data-num="52"></td><td><pre>    Moving slot <span class="token number">10</span> from d5ee7b57f7a0085b50b898897b6fb013b57fe371</pre></td></tr><tr><td data-num="53"></td><td><pre>    Moving slot <span class="token number">11</span> from d5ee7b57f7a0085b50b898897b6fb013b57fe371</pre></td></tr><tr><td data-num="54"></td><td><pre>    Moving slot <span class="token number">12</span> from d5ee7b57f7a0085b50b898897b6fb013b57fe371</pre></td></tr><tr><td data-num="55"></td><td><pre>    Moving slot <span class="token number">13</span> from d5ee7b57f7a0085b50b898897b6fb013b57fe371</pre></td></tr><tr><td data-num="56"></td><td><pre>    Moving slot <span class="token number">14</span> from d5ee7b57f7a0085b50b898897b6fb013b57fe371</pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="58"></td><td><pre>   Moving slot <span class="token number">49</span> from d5ee7b57f7a0085b50b898897b6fb013b57fe371</pre></td></tr><tr><td data-num="59"></td><td><pre>   Do you want to proceed with the proposed reshard plan <span class="token punctuation">(</span>yes/no<span class="token punctuation">)</span>? <span class="token function">yes</span> <span class="token comment">#确定执行</span></pre></td></tr><tr><td data-num="60"></td><td><pre>   Moving slot <span class="token number">0</span> from <span class="token number">127.0</span>.0.1:30001 to <span class="token number">127.0</span>.0.1:30003: </pre></td></tr><tr><td data-num="61"></td><td><pre>Moving slot <span class="token number">1</span> from <span class="token number">127.0</span>.0.1:30001 to <span class="token number">127.0</span>.0.1:30003: </pre></td></tr><tr><td data-num="62"></td><td><pre>Moving slot <span class="token number">2</span> from <span class="token number">127.0</span>.0.1:30001 to <span class="token number">127.0</span>.0.1:30003: </pre></td></tr><tr><td data-num="63"></td><td><pre>Moving slot <span class="token number">3</span> from <span class="token number">127.0</span>.0.1:30001 to <span class="token number">127.0</span>.0.1:30003: </pre></td></tr><tr><td data-num="64"></td><td><pre>Moving slot <span class="token number">4</span> from <span class="token number">127.0</span>.0.1:30001 to <span class="token number">127.0</span>.0.1:30003: </pre></td></tr><tr><td data-num="65"></td><td><pre>Moving slot <span class="token number">5</span> from <span class="token number">127.0</span>.0.1:30001 to <span class="token number">127.0</span>.0.1:30003: </pre></td></tr><tr><td data-num="66"></td><td><pre>Moving slot <span class="token number">6</span> from <span class="token number">127.0</span>.0.1:30001 to <span class="token number">127.0</span>.0.1:30003: </pre></td></tr><tr><td data-num="67"></td><td><pre>Moving slot <span class="token number">7</span> from <span class="token number">127.0</span>.0.1:30001 to <span class="token number">127.0</span>.0.1:30003: </pre></td></tr><tr><td data-num="68"></td><td><pre>Moving slot <span class="token number">8</span> from <span class="token number">127.0</span>.0.1:30001 to <span class="token number">127.0</span>.0.1:30003: </pre></td></tr><tr><td data-num="69"></td><td><pre>Moving slot <span class="token number">9</span> from <span class="token number">127.0</span>.0.1:30001 to <span class="token number">127.0</span>.0.1:30003: </pre></td></tr><tr><td data-num="70"></td><td><pre>Moving slot <span class="token number">10</span> from <span class="token number">127.0</span>.0.1:30001 to <span class="token number">127.0</span>.0.1:30003: </pre></td></tr><tr><td data-num="71"></td><td><pre>Moving slot <span class="token number">11</span> from <span class="token number">127.0</span>.0.1:30001 to <span class="token number">127.0</span>.0.1:30003: </pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="73"></td><td><pre>Moving slot <span class="token number">49</span> from <span class="token number">127.0</span>.0.1:30001 to <span class="token number">127.0</span>.0.1:30003: </pre></td></tr><tr><td data-num="74"></td><td><pre>   </pre></td></tr><tr><td data-num="75"></td><td><pre>   <span class="token comment">#查看分配的槽位</span></pre></td></tr><tr><td data-num="76"></td><td><pre>   <span class="token punctuation">[</span>root@localhost create-cluster<span class="token punctuation">]</span><span class="token comment"># redis-cli --cluster check 127.0.0.1:30001</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token number">127.0</span>.0.1:30001 <span class="token punctuation">(</span>d5ee7b57<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">0</span> keys <span class="token operator">|</span> <span class="token number">5411</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.</pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token number">127.0</span>.0.1:30003 <span class="token punctuation">(</span>d9878766<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">1</span> keys <span class="token operator">|</span> <span class="token number">5511</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.</pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token number">127.0</span>.0.1:30002 <span class="token punctuation">(</span>4ada6d29<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">0</span> keys <span class="token operator">|</span> <span class="token number">5462</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.</pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token punctuation">[</span>OK<span class="token punctuation">]</span> <span class="token number">1</span> keys <span class="token keyword">in</span> <span class="token number">3</span> masters.</pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token number">0.00</span> keys per slot on average.</pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> Performing Cluster Check <span class="token punctuation">(</span>using node <span class="token number">127.0</span>.0.1:30001<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="83"></td><td><pre>M: d5ee7b57f7a0085b50b898897b6fb013b57fe371 <span class="token number">127.0</span>.0.1:30001</pre></td></tr><tr><td data-num="84"></td><td><pre>   slots:<span class="token punctuation">[</span><span class="token number">50</span>-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5411</span> slots<span class="token punctuation">)</span> master</pre></td></tr><tr><td data-num="85"></td><td><pre>   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="86"></td><td><pre>S: 88ab8ec4a6c2be465728e5a04023692a6dba3eec <span class="token number">127.0</span>.0.1:30004</pre></td></tr><tr><td data-num="87"></td><td><pre>   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave</pre></td></tr><tr><td data-num="88"></td><td><pre>   replicates d987876627c455db85b04bbf2e3f3b67a5e5dae0</pre></td></tr><tr><td data-num="89"></td><td><pre>S: 575e9a4f4628dd7659774f5b7387e7f479922e6b <span class="token number">127.0</span>.0.1:30006</pre></td></tr><tr><td data-num="90"></td><td><pre>   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave</pre></td></tr><tr><td data-num="91"></td><td><pre>   replicates 4ada6d29ab60c65288edfa5aaebb3c946cb59e8b</pre></td></tr><tr><td data-num="92"></td><td><pre>M: d987876627c455db85b04bbf2e3f3b67a5e5dae0 <span class="token number">127.0</span>.0.1:30003  <span class="token comment">#主节点 30003 中多了 [0-49] 的槽位</span></pre></td></tr><tr><td data-num="93"></td><td><pre>   slots:<span class="token punctuation">[</span><span class="token number">0</span>-49<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">10923</span>-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5511</span> slots<span class="token punctuation">)</span> master</pre></td></tr><tr><td data-num="94"></td><td><pre>   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="95"></td><td><pre>M: 4ada6d29ab60c65288edfa5aaebb3c946cb59e8b <span class="token number">127.0</span>.0.1:30002</pre></td></tr><tr><td data-num="96"></td><td><pre>   slots:<span class="token punctuation">[</span><span class="token number">5461</span>-10922<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5462</span> slots<span class="token punctuation">)</span> master</pre></td></tr><tr><td data-num="97"></td><td><pre>   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="98"></td><td><pre>S: b5771aacd79fbfe0c4c4f4d898c6e8ef0e83beca <span class="token number">127.0</span>.0.1:30005</pre></td></tr><tr><td data-num="99"></td><td><pre>   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave</pre></td></tr><tr><td data-num="100"></td><td><pre>   replicates d5ee7b57f7a0085b50b898897b6fb013b57fe371</pre></td></tr></table></figure><h2 id="windows中启动多个redis实例"><a class="anchor" href="#windows中启动多个redis实例">#</a> windows 中启动多个 redis 实例</h2><p>可以复制出几份安装文件，然后更改每份安装文件中 <strong>redis.windows-service.conf</strong> 配置的端口配置</p><pre><code class="language-cmd"># 进入安装目录下执行，将redis-server作为服务安装到服务列表中
PS D:\redis-6381&gt; redis-server --service-install redis.windows-service.conf --loglevel verbose --service-name redis6381 --port 6381
# 启动指定服务名字的redis-server
PS D:\redis-6381&gt; redis-server --service-start --service-name redis6381
[2292] 29 Aug 18:08:23.500 # Redis service successfully started.

# 启动服务对应的redis客户端
PS D:\redis-6380&gt; redis-cli -p 6380
127.0.0.1:6380&gt;
</code></pre><div class="tags"><a href="/tags/Java/" rel="tag"><i class="ic i-tag"></i> Java</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"><i class="ic i-tag"></i> 数据库</a> <a href="/tags/IO/" rel="tag"><i class="ic i-tag"></i> IO</a> <a href="/tags/Redis/" rel="tag"><i class="ic i-tag"></i> Redis</a> <a href="/tags/%E7%BC%93%E5%AD%98/" rel="tag"><i class="ic i-tag"></i> 缓存</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2021-12-27 23:23:11" itemprop="dateModified" datetime="2021-12-27T23:23:11+08:00">2021-12-27</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="fanfanfan 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="fanfanfan 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="fanfanfan paypal"><p>paypal</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>fanfanfan <i class="ic i-at"><em>@</em></i></li><li class="link"><strong>本文链接：</strong> <a href="https://baiyezi.vip/java/redis/redis%E7%9A%84%E9%9B%86%E7%BE%A4/" title="redis的集群">https://baiyezi.vip/java/redis/redis的集群/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/java/redis/redis%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;gitee.com&#x2F;bfanfanfan&#x2F;img&#x2F;raw&#x2F;master&#x2F;guzhuang&#x2F;20211225105419.jpg" title="redis进阶使用"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Java</span><h3>redis进阶使用</h3></a></div><div class="item right"><a href="/java/redis/redis%E5%9C%A8%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;gitee.com&#x2F;bfanfanfan&#x2F;img&#x2F;raw&#x2F;master&#x2F;guzhuang&#x2F;20211225105423.jpg" title="redis在开发中的简单使用"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> Java</span><h3>redis在开发中的简单使用</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E6%9C%BA-%E5%8D%95%E8%8A%82%E7%82%B9-%E5%8D%95%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.</span> <span class="toc-text">单机、单节点、单实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">2.</span> <span class="toc-text">redis 主从复制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">redis 的高可用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E7%9A%84%E5%88%86%E5%8C%BA"><span class="toc-number">4.</span> <span class="toc-text">redis 的分区</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%8C%BA%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">4.1.</span> <span class="toc-text">分区基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%88%86%E5%8C%BA"><span class="toc-number">4.2.</span> <span class="toc-text">客户端分区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E5%88%86%E5%8C%BA"><span class="toc-number">4.3.</span> <span class="toc-text">代理分区</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#twemproxy"><span class="toc-number">4.3.1.</span> <span class="toc-text">twemproxy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#predixy"><span class="toc-number">4.3.2.</span> <span class="toc-text">predixy</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%8C%BA%E7%9A%84%E4%BC%98%E7%82%B9"><span class="toc-number">4.4.</span> <span class="toc-text">分区的优点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%8C%BA%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="toc-number">4.5.</span> <span class="toc-text">分区的缺点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%84%E5%88%86%E7%89%87"><span class="toc-number">4.6.</span> <span class="toc-text">预分片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E6%95%B0%E6%8D%AE%E8%BF%98%E6%98%AF%E7%BC%93%E5%AD%98"><span class="toc-number">4.7.</span> <span class="toc-text">持久化数据还是缓存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E7%9A%84%E9%9B%86%E7%BE%A4"><span class="toc-number">5.</span> <span class="toc-text">redis 的集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#redis%E9%9B%86%E7%BE%A4%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.1.</span> <span class="toc-text">Redis 集群介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis-%E9%9B%86%E7%BE%A4%E7%9A%84%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87"><span class="toc-number">5.2.</span> <span class="toc-text">Redis 集群的数据分片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis-%E9%9B%86%E7%BE%A4%E7%9A%84%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%A8%A1%E5%9E%8B"><span class="toc-number">5.3.</span> <span class="toc-text">Redis 集群的主从复制模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis-%E4%B8%80%E8%87%B4%E6%80%A7%E4%BF%9D%E8%AF%81"><span class="toc-number">5.4.</span> <span class="toc-text">Redis 一致性保证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">5.5.</span> <span class="toc-text">redis 集群搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A7%BD%E4%BD%8D%E7%A7%BB%E5%8A%A8"><span class="toc-number">5.5.1.</span> <span class="toc-text">槽位移动</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#windows%E4%B8%AD%E5%90%AF%E5%8A%A8%E5%A4%9A%E4%B8%AAredis%E5%AE%9E%E4%BE%8B"><span class="toc-number">6.</span> <span class="toc-text">windows 中启动多个 redis 实例</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/java/MySQL/Linux%E4%B8%8B%E5%AE%89%E8%A3%85MySQL/" rel="bookmark" title="Linux下安装MySQL">Linux下安装MySQL</a></li><li><a href="/java/MySQL/MySQL%E5%9F%BA%E7%A1%80/" rel="bookmark" title="MySQL基础">MySQL基础</a></li><li><a href="/java/Spring/IOC%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F%EF%BC%88%E4%B8%80%EF%BC%89/" rel="bookmark" title="IOC配置方式（一）">IOC配置方式（一）</a></li><li><a href="/java/Spring/IOC%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F%EF%BC%88%E4%BA%8C%EF%BC%89/" rel="bookmark" title="IOC配置方式（二）">IOC配置方式（二）</a></li><li><a href="/java/Spring/IOC%E6%B3%A8%E8%A7%A3%E6%96%B9%E5%BC%8F/" rel="bookmark" title="IOC注解方式">IOC注解方式</a></li><li><a href="/java/Spring/AOP/" rel="bookmark" title="AOP">AOP</a></li><li><a href="/java/SpringBoot/SpringBoot%E5%85%A5%E9%97%A8/" rel="bookmark" title="SpringBoot入门">SpringBoot入门</a></li><li><a href="/java/SpringBoot/SpringBoot-Web%E5%BC%80%E5%8F%91/" rel="bookmark" title="SpringBoot-Web开发">SpringBoot-Web开发</a></li><li><a href="/java/SpringBoot/SpringBoot%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E5%8E%9F%E7%90%86/" rel="bookmark" title="SpringBoot自动装配原理">SpringBoot自动装配原理</a></li><li><a href="/java/zookeeper/zookeeper%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" rel="bookmark" title="zookeeper搭建及基本概念">zookeeper搭建及基本概念</a></li><li><a href="/java/zookeeper/zookeeper%E5%8E%9F%E7%90%86/" rel="bookmark" title="zookeeper原理">zookeeper原理</a></li><li><a href="/java/zookeeper/zookeeper%E6%A1%88%E4%BE%8B/" rel="bookmark" title="zookeeper案例">zookeeper案例</a></li><li><a href="/java/MySQL/MySQL%E8%B0%83%E4%BC%98%EF%BC%88%E4%B8%80%EF%BC%89/" rel="bookmark" title="MySQL调优（一）">MySQL调优（一）</a></li><li><a href="/java/redis/redis%E5%AE%89%E8%A3%85%E5%8F%8ANIO%E5%8E%9F%E7%90%86/" rel="bookmark" title="redis安装及NIO原理">redis安装及NIO原理</a></li><li><a href="/java/SpringMVC/SpringMVC%E5%85%A5%E9%97%A8%EF%BC%88%E4%B8%80%EF%BC%89/" rel="bookmark" title="SpringMVC入门（一）">SpringMVC入门（一）</a></li><li><a href="/java/SpringMVC/SpringMVC%E5%85%A5%E9%97%A8%EF%BC%88%E4%BA%8C%EF%BC%89/" rel="bookmark" title="SpringMVC入门（二）">SpringMVC入门（二）</a></li><li><a href="/java/SpringMVC/SpringMVC-REST%E9%A3%8E%E6%A0%BC/" rel="bookmark" title="SpringMVC-REST风格">SpringMVC-REST风格</a></li><li><a href="/java/SpringMVC/SpringMVC%E8%BF%9B%E9%98%B6/" rel="bookmark" title="SpringMVC进阶">SpringMVC进阶</a></li><li><a href="/java/SpringMVC/SpringMVC%E6%BA%90%E7%A0%81%E6%80%BB%E7%BB%93/" rel="bookmark" title="SpringMVC源码总结">SpringMVC源码总结</a></li><li><a href="/java/shiro/shiro%E5%85%A5%E9%97%A8/" rel="bookmark" title="shiro入门">shiro入门</a></li><li><a href="/java/shiro/shiro%E6%95%B4%E5%90%88SpringBoot/" rel="bookmark" title="shiro整合SpringBoot">shiro整合SpringBoot</a></li><li><a href="/java/shiro/shiro%E7%9A%84session%E7%AE%A1%E7%90%86/" rel="bookmark" title="shiro的session管理">shiro的session管理</a></li><li><a href="/java/shiro/shiro%E7%9A%84%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E7%99%BB%E5%BD%95/" rel="bookmark" title="shiro的缓存机制与分布式登录">shiro的缓存机制与分布式登录</a></li><li><a href="/java/shiro/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/" rel="bookmark" title="单点登录">单点登录</a></li><li><a href="/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91/%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" rel="bookmark" title="线程基础知识">线程基础知识</a></li><li><a href="/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91/%E5%AE%B9%E5%99%A8%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="bookmark" title="容器与线程池">容器与线程池</a></li><li><a href="/java/docker/Win10%E5%AE%89%E8%A3%85docker/" rel="bookmark" title="Win10安装docker">Win10安装docker</a></li><li><a href="/java/docker/Win10%E4%B8%ADdocker%E9%83%A8%E7%BD%B2springboot%E9%A1%B9%E7%9B%AE/" rel="bookmark" title="Win10安装docker">Win10安装docker</a></li><li><a href="/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91/JMH/" rel="bookmark" title="JMH">JMH</a></li><li><a href="/java/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" rel="bookmark" title="并发编程">并发编程</a></li><li><a href="/java/%E6%97%A5%E5%BF%97/java-%E6%97%A5%E5%BF%97%E4%BD%93%E7%B3%BB/" rel="bookmark" title="java-日志体系">java-日志体系</a></li><li><a href="/java/redis/redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" rel="bookmark" title="redis的数据类型">redis的数据类型</a></li><li><a href="/java/redis/redis%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8/" rel="bookmark" title="redis进阶使用">redis进阶使用</a></li><li class="active"><a href="/java/redis/redis%E7%9A%84%E9%9B%86%E7%BE%A4/" rel="bookmark" title="redis的集群">redis的集群</a></li><li><a href="/java/redis/redis%E5%9C%A8%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" rel="bookmark" title="redis在开发中的简单使用">redis在开发中的简单使用</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/ChainOfResponsibility%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F/" rel="bookmark" title="ChainOfResponsibility责任链模式">ChainOfResponsibility责任链模式</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Composite%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F/" rel="bookmark" title="Composite组合模式">Composite组合模式</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Decorator%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F/" rel="bookmark" title="Decorator装饰器模式">Decorator装饰器模式</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Facade%E9%97%A8%E9%9D%A2%E6%A8%A1%E5%BC%8F/" rel="bookmark" title="Facade门面模式">Facade门面模式</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Factory%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/" rel="bookmark" title="Factory工厂模式">Factory工厂模式</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Flyweight%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F/" rel="bookmark" title="Flyweight享元模式">Flyweight享元模式</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Iterator%E8%BF%AD%E4%BB%A3%E5%99%A8%E6%A8%A1%E5%BC%8F/" rel="bookmark" title="Iterator迭代器模式">Iterator迭代器模式</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Mediator%E8%B0%83%E5%81%9C%E8%80%85%E6%A8%A1%E5%BC%8F/" rel="bookmark" title="Mediator调停者模式">Mediator调停者模式</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Observer%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/" rel="bookmark" title="Observer观察者模式">Observer观察者模式</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Proxy%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/" rel="bookmark" title="Proxy代理模式">Proxy代理模式</a></li><li><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Singleton%E5%8D%95%E4%BE%8B/" rel="bookmark" title="Singleton单例">Singleton单例</a></li><li><a href="/java/SpringCloud/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BB%A5%E5%8F%8A%E6%9E%B6%E6%9E%84%E5%8F%91%E5%B1%95/" rel="bookmark" title="微服务以及架构发展">微服务以及架构发展</a></li><li><a href="/java/JVM/JVM-%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD/" rel="bookmark" title="JVM-类的加载">JVM-类的加载</a></li><li><a href="/java/SpringCloud/SpringCloud-Netflix%E4%BD%93%E7%B3%BB/" rel="bookmark" title="SpringCloud-Netflix体系">SpringCloud-Netflix体系</a></li><li><a href="/java/%E5%BA%8F%E5%88%97%E5%8C%96/%E5%BA%8F%E5%88%97%E5%8C%96/" rel="bookmark" title="序列化">序列化</a></li><li><a href="/java/JVM/JVM-JMM/" rel="bookmark" title="JVM-JMM">JVM-JMM</a></li><li><a href="/java/%E4%BA%BF%E7%BA%A7%E6%B5%81%E9%87%8F%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/" rel="bookmark" title="分布式系统与高并发系统架构">分布式系统与高并发系统架构</a></li><li><a href="/java/JVM/JVM-%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%9B%E5%BB%BA/" rel="bookmark" title="JVM-对象的创建">JVM-对象的创建</a></li><li><a href="/java/JVM/JVM-JVM%E8%B0%83%E4%BC%98/" rel="bookmark" title="JVM-JVM调优">JVM-JVM调优</a></li><li><a href="/java/JVM/JVM-GC/" rel="bookmark" title="JVM-GC">JVM-GC</a></li><li><a href="/java/SpringCloud/SpringCloud-Alibaba%E4%BD%93%E7%B3%BB/" rel="bookmark" title="SpringCloud-Alibaba体系">SpringCloud-Alibaba体系</a></li><li><a href="/java/SpringCloud/SpringCloud-SpringCloud%E4%BD%93%E7%B3%BB/" rel="bookmark" title="SpringCloud-SpringCloud体系">SpringCloud-SpringCloud体系</a></li><li><a href="/java/SpringCloud/Apollo/" rel="bookmark" title="Apollo">Apollo</a></li><li><a href="/java/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BC%9A%E8%AF%9D/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86%EF%BC%88%E4%B8%80%EF%BC%89/" rel="bookmark" title="微服务中的会话管理（一）">微服务中的会话管理（一）</a></li><li><a href="/java/io/%E7%A3%81%E7%9B%98IO%E4%B8%8E%E7%BD%91%E7%BB%9CIO/" rel="bookmark" title="磁盘IO与网络IO">磁盘IO与网络IO</a></li><li><a href="/java/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BC%9A%E8%AF%9D/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86%EF%BC%88%E4%BA%8C%EF%BC%89/" rel="bookmark" title="微服务中的会话管理（二）">微服务中的会话管理（二）</a></li><li><a href="/java/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BC%9A%E8%AF%9D/HTTPS/" rel="bookmark" title="HTTPS">HTTPS</a></li><li><a href="/java/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RocketMQ/RocketMQ-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/" rel="bookmark" title="RocketMQ-基础概念">RocketMQ-基础概念</a></li><li><a href="/java/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RocketMQ/RocketMQ-%E6%B6%88%E6%81%AF%E3%80%81%E4%BA%8B%E5%8A%A1/" rel="bookmark" title="RocketMQ-消息、事务">RocketMQ-消息、事务</a></li><li><a href="/java/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/kafka/Kafka-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84/" rel="bookmark" title="Kafka-整体架构">Kafka-整体架构</a></li><li><a href="/java/io/%E7%BD%91%E7%BB%9CIO%E6%A8%A1%E5%9E%8B/" rel="bookmark" title="网络IO模型">网络IO模型</a></li><li><a href="/java/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/kafka/Kafka-%E6%90%AD%E5%BB%BA/" rel="bookmark" title="Kafka-搭建">Kafka-搭建</a></li><li><a href="/java/io/Netty/" rel="bookmark" title="Netty">Netty</a></li><li><a href="/java/Nginx/nginx%E5%AE%9E%E6%88%98/" rel="bookmark" title="nginx实战">nginx实战</a></li><li><a href="/instruments/%E4%B8%B2%E5%8F%A3/Java%E5%92%8C%E4%B8%B2%E5%8F%A3%E8%BF%9B%E8%A1%8C%E9%80%9A%E4%BF%A1/" rel="bookmark" title="Java和串口进行通信">Java和串口进行通信</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="fanfanfan" data-src="/images/avatar.gif"><p class="name" itemprop="name">fanfanfan</p><div class="description" itemprop="description">花有重开日，人无再少年</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">76</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">4</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">78</span> <span class="name">标签</span></a></div></nav><div class="social"></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-magic"></i>友链</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/java/redis/redis%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/java/redis/redis%E5%9C%A8%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a></div><span><a href="/java/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RocketMQ/RocketMQ-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/" title="RocketMQ-基础概念">RocketMQ-基础概念</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a></div><span><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Iterator%E8%BF%AD%E4%BB%A3%E5%99%A8%E6%A8%A1%E5%BC%8F/" title="Iterator迭代器模式">Iterator迭代器模式</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a></div><span><a href="/java/redis/redis%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" title="redis的数据类型">redis的数据类型</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a></div><span><a href="/java/SpringMVC/SpringMVC%E8%BF%9B%E9%98%B6/" title="SpringMVC进阶">SpringMVC进阶</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a></div><span><a href="/java/zookeeper/zookeeper%E6%A1%88%E4%BE%8B/" title="zookeeper案例">zookeeper案例</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/java/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" title="分类于 微服务">微服务</a></div><span><a href="/java/SpringCloud/SpringCloud-Netflix%E4%BD%93%E7%B3%BB/" title="SpringCloud-Netflix体系">SpringCloud-Netflix体系</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a></div><span><a href="/java/SpringMVC/SpringMVC%E5%85%A5%E9%97%A8%EF%BC%88%E4%B8%80%EF%BC%89/" title="SpringMVC入门（一）">SpringMVC入门（一）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a></div><span><a href="/java/MySQL/MySQL%E5%9F%BA%E7%A1%80/" title="MySQL基础">MySQL基础</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a></div><span><a href="/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/Composite%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F/" title="Composite组合模式">Composite组合模式</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 Java">Java</a></div><span><a href="/java/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/RocketMQ/RocketMQ-%E6%B6%88%E6%81%AF%E3%80%81%E4%BA%8B%E5%8A%A1/" title="RocketMQ-消息、事务">RocketMQ-消息、事务</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">fanfanfan</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">1.4m 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">20:37</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"java/redis/redis的集群/",favicon:{show:"书院十四先生",hide:"书院十四先生"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->